import e from"axios";import t from"fs";import i from"path";import{promisify as r}from"util";import o from"stream";import{Client as n}from"basic-ftp";import{S3Client as s,PutObjectCommand as a,GetObjectCommand as d,ListObjectsV2Command as c,DeleteObjectCommand as l}from"@aws-sdk/client-s3";import{createClient as h,AuthType as u}from"webdav";import p from"ssh2-sftp-client";import f from"form-data";import{Storage as y}from"megajs";import g from"electron-store";import m from"node-machine-id";function v(e,t,i,r){return new(i||(i=Promise))((function(o,n){function s(e){try{d(r.next(e))}catch(e){n(e)}}function a(e){try{d(r.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((r=r.apply(e,t||[])).next())}))}const k="https://web.koodoreader.com/",T="vnc67byrssocvy1",E="pg8ten0B3vH",w="ltimecqanmpxoaicn9qw3es6l3sdl1ya",x="506df58a-29ab-4020-afc5-6f423dc80f35",b="1051055003225-ph1f5fvh328dhv7bco5jitlnfhg6ks2t.apps.googleusercontent.com",S="a128ae7b9c094545af623de61dc0a1ef";class R{constructor(e){this.queue=[],this.runningTasks=0,this.maxConcurrency=e}addTask(e){return v(this,void 0,void 0,(function*(){return new Promise(((t,i)=>{const r=()=>v(this,void 0,void 0,(function*(){try{this.runningTasks++;const i=yield e();return t(i),i}catch(e){throw i(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?r():this.queue.push(r)}))}))}runNext(){if(this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}}class F{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.refreshTokenPromise=null,this.taskQueue=new R(3)}retryOperation(e,t=3){return v(this,void 0,void 0,(function*(){let i=0;for(;;){const r=yield e();if(r)return r;if(i>=t)return r;i++;const o=1e3*Math.pow(2,i);console.log(`Retry attempt ${i} after ${o}ms`),yield new Promise((e=>setTimeout(e,o)))}}))}listFiles(t){return v(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken();return(yield e.post("https://api.dropboxapi.com/2/files/list_folder",{path:"/"+t},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}})).data.entries.map((e=>e.name))}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return v(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken();yield e.post("https://api.dropboxapi.com/2/files/delete_v2",{path:"/"+t},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}});return!0}catch(e){return console.error("Error deleting file:",e),!1}}))}refreshToken(){return v(this,void 0,void 0,(function*(){return this.config.access_token&&this.config.expires_at>(new Date).getTime()?this.config.access_token:(this.refreshTokenPromise||(this.refreshTokenPromise=(()=>v(this,void 0,void 0,(function*(){try{let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"dropbox",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}finally{this.refreshTokenPromise=null}})))()),this.refreshTokenPromise)}))}authToken(e){return v(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"dropbox",redirect_uri:k,code:e})).data.refresh_token}))}getAuthUrl(){return`https://www.dropbox.com/oauth2/authorize?response_type=code&token_access_type=offline&client_id=${T}&redirect_uri=${k}`}}const _=r(o.pipeline);class C extends F{constructor(e,t,i){super(e,i),this.storagePath=t}uploadFile(r,o){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){try{const n=yield this.refreshToken(),s=t.createReadStream(i.join(this.storagePath,r));return yield e.post("https://content.dropboxapi.com/2/files/upload",s,{headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/octet-stream","Dropbox-API-Arg":JSON.stringify({path:"/"+o,mode:"overwrite",autorename:!0,mute:!1})},maxContentLength:1/0,maxBodyLength:1/0}),!0}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(r,o){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){try{const n=yield this.refreshToken(),s=t.createWriteStream(i.join(this.storagePath,o)),a=yield e({url:"https://content.dropboxapi.com/2/files/download",method:"GET",responseType:"stream",headers:{Authorization:`Bearer ${n}`,"Dropbox-API-Arg":JSON.stringify({path:"/"+r})},maxContentLength:1/0,maxBodyLength:1/0});return yield _(a.data,s),!0}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class O{constructor(e){this.queue=[],this.runningTasks=0,this.maxConcurrency=e}addTask(e){return v(this,void 0,void 0,(function*(){return new Promise(((t,i)=>{const r=()=>v(this,void 0,void 0,(function*(){try{this.runningTasks++;const i=yield e();return t(i),i}catch(e){throw i(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?r():this.queue.push(r)}))}))}runNext(){if(this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}}class A{constructor(e,t){this.config=e,this.storagePath=t,this.taskQueue=new O(1)}retryOperation(e,t=3){return v(this,void 0,void 0,(function*(){let i=0;for(;;){const r=yield e();if(r)return r;if(i>=t)return r;i++;const o=1e3*Math.pow(2,i);console.log(`Retry attempt ${i} after ${o}ms`),yield new Promise((e=>setTimeout(e,o)))}}))}getClient(){return v(this,void 0,void 0,(function*(){if(this.client)return this.client;let{url:e,username:t,password:i,dir:r,ssl:o,port:s}=this.config;const a=new n;return a.ftp.verbose=!0,yield a.access({host:e,port:parseInt(s),user:t,password:i,secure:"1"===o}),this.client=a,a}))}uploadFile(e,t){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){let{dir:r}=this.config;const o=yield this.getClient(),n=()=>v(this,void 0,void 0,(function*(){yield o.uploadFrom(i.join(this.storagePath,e),r+"/"+t)}));try{return yield n(),!0}catch(e){return console.error(e),!1}}))))))}))}downloadFile(e,t){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){let{dir:r}=this.config;const o=yield this.getClient(),n=()=>v(this,void 0,void 0,(function*(){yield o.downloadTo(i.join(this.storagePath,t),r+"/"+e)}));try{return yield n(),!0}catch(e){return console.error(e),!1}}))))))}))}listFiles(e){return v(this,void 0,void 0,(function*(){let{dir:t}=this.config;const i=yield this.getClient(),r=()=>v(this,void 0,void 0,(function*(){return yield i.list(t+"/"+e)}));try{return(yield r()).map((e=>e.name))}catch(e){return console.error(e),[]}}))}deleteFile(e){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){let{dir:t}=this.config;const i=yield this.getClient(),r=()=>v(this,void 0,void 0,(function*(){yield i.remove(t+"/"+e)}));try{return yield r(),!0}catch(e){return console.error(e),!1}}))))))}))}}class P{constructor(e){this.queue=[],this.runningTasks=0,this.maxConcurrency=e}addTask(e){return v(this,void 0,void 0,(function*(){return new Promise(((t,i)=>{const r=()=>v(this,void 0,void 0,(function*(){try{this.runningTasks++;const i=yield e();return t(i),i}catch(e){throw i(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?r():this.queue.push(r)}))}))}runNext(){if(this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}}class I{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.refreshTokenPromise=null,this.taskQueue=new P(3)}retryOperation(e,t=3){return v(this,void 0,void 0,(function*(){let i=0;for(;;){const r=yield e();if(r)return r;if(i>=t)return r;i++;const o=1e3*Math.pow(2,i);console.log(`Retry attempt ${i} after ${o}ms`),yield new Promise((e=>setTimeout(e,o)))}}))}listFiles(t){return v(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken(),r=yield e.get(`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}:/children`,{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}});return r.status>=300?[]:r.data.value.map((e=>e.name))}catch(e){return console.error("Error occurred during file list:",e),[]}}))}deleteFile(e){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return v(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken(),r=yield e.delete(`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}`,{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}});return!(r.status>=300)||(console.error("Error deleting file:",r),!0)}catch(e){return console.error("Error occurred during file delete:",e),!1}}))}refreshToken(){return v(this,void 0,void 0,(function*(){return this.config.access_token&&this.config.expires_at>(new Date).getTime()?this.config.access_token:(this.refreshTokenPromise||(this.refreshTokenPromise=(()=>v(this,void 0,void 0,(function*(){try{let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"microsoft",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}finally{this.refreshTokenPromise=null}})))()),this.refreshTokenPromise)}))}authToken(e){return v(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"microsoft",redirect_uri:k,code:e})).data.refresh_token}))}getAuthUrl(){return`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${x}&scope=files.readwrite.appfolder offline_access&response_type=code&redirect_uri=${k}`}}const L=e=>"json"===e?"application/json":["jpg","jpeg","png","gif","bmp"].includes(e)?"image/"+e:"zip"===e?"application/zip":"epub"===e?"application/epub+zip":"txt"===e?"text/plain":"pdf"===e?"application/pdf":"mobi"===e?"application/x-mobipocket-ebook":"azw3"===e||"azw"===e?"application/vnd.amazon.ebook":"cbz"===e?"application/x-cbz":"cbr"===e?"application/x-cbr":"cbt"===e?"application/x-cbt":"cb7"===e?"application/x-cb7":"fb2"===e?"application/x-fictionbook+xml":"html"===e?"text/html":"css"===e?"text/css":"js"===e?"application/javascript":"xml"===e?"application/xml":"xhtml"===e?"application/xhtml+xml":"opf"===e?"application/oebps-package+xml":"ncx"===e?"application/x-dtbncx+xml":"mp3"===e?"audio/mpeg":"wav"===e?"audio/wav":"ogg"===e?"audio/ogg":"mp4"===e?"video/mp4":"webm"===e?"video/webm":"avi"===e?"video/x-msvideo":"wmv"===e?"video/x-ms-wmv":"flv"===e?"video/x-flv":"m3u8"===e?"application/x-mpegURL":"ts"===e?"video/MP2T":"3gp"===e?"video/3gpp":"3g2"===e?"video/3gpp2":"db"===e?"application/x-sqlite3":void 0;class q extends I{constructor(e,t,i){super(e,i),this.storagePath=t}uploadFile(r,o){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){try{const n=yield this.refreshToken();let s=o.split(".").pop(),a=L(s||"");const d="https://graph.microsoft.com/v1.0/me/drive/special/approot:/"+o+":/createUploadSession",c=(yield e.post(d,null,{headers:{Authorization:"Bearer "+n,"Content-Type":"application/json"},maxContentLength:1/0,maxBodyLength:1/0})).data.uploadUrl,l=t.readFileSync(i.join(this.storagePath,r));let h=yield this.getFileSize(i.join(this.storagePath,r));yield e.put(c,l,{headers:{"Content-Type":a,"Content-Range":`bytes 0-${h-1}/${h}`},maxContentLength:1/0,maxBodyLength:1/0});return!0}catch(e){return console.error("Error occurred during file upload:",e),!1}}))))))}))}downloadFile(e,r){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),n=`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${e}:/content`;let s=(yield fetch(n,{headers:{Authorization:"Bearer "+o},redirect:"manual"})).headers.get("location");if(s){const e=yield fetch(s,{headers:{}}),o=yield e.arrayBuffer();return t.writeFileSync(i.join(this.storagePath,r),Buffer.from(o)),!0}return!1}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}getFileSize(e){return v(this,void 0,void 0,(function*(){try{return(yield t.promises.stat(e)).size}catch(e){throw e}}))}}class ${constructor(e){this.queue=[],this.runningTasks=0,this.maxConcurrency=e}addTask(e){return v(this,void 0,void 0,(function*(){return new Promise(((t,i)=>{const r=()=>v(this,void 0,void 0,(function*(){try{this.runningTasks++;const i=yield e();return t(i),i}catch(e){throw i(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?r():this.queue.push(r)}))}))}runNext(){if(this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}}class j{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.refreshTokenPromise=null,this.taskQueue=new $(3)}retryOperation(e,t=3){return v(this,void 0,void 0,(function*(){let i=0;for(;;){const r=yield e();if(r)return r;if(i>=t)return r;i++;const o=1e3*Math.pow(2,i);console.log(`Retry attempt ${i} after ${o}ms`),yield new Promise((e=>setTimeout(e,o)))}}))}getFileId(t,i){return v(this,void 0,void 0,(function*(){const r=yield this.refreshToken(),o=`https://www.googleapis.com/drive/v3/files?q=name='${t}'+and+'${i}'+in+parents&spaces=appDataFolder&fields=files(id,name)`;try{const t=yield e.get(o,{headers:{Authorization:"Bearer "+r}});if(0===t.data.files.length)return"";const i=t.data.files;return i.length>0?i[0].id:null}catch(e){return console.error("Error occurred during file list retrieval:",e),""}}))}checkFolder(t){return v(this,void 0,void 0,(function*(){const i=yield this.refreshToken(),r=yield this.getFolderId(t);if(r)return r;const o={name:t,mimeType:"application/vnd.google-apps.folder",parents:["appDataFolder"]};try{return(yield e.post("https://www.googleapis.com/drive/v3/files",o,{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}})).data.id}catch(e){throw console.error("Error occurred during folder creation:",e),e}}))}getFolderId(t){return v(this,void 0,void 0,(function*(){const i=yield this.refreshToken(),r=`https://www.googleapis.com/drive/v3/files?q=name='${t}'+and+mimeType='application/vnd.google-apps.folder'+and+'appDataFolder'+in+parents&spaces=appDataFolder&fields=files(id,name)`;try{const t=(yield e.get(r,{headers:{Authorization:`Bearer ${i}`}})).data.files;return t.length>0?t[0].id:null}catch(e){throw console.error("Error occurred during fetching folder ID:",e),e}}))}listFiles(t){return v(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken();const r=`https://www.googleapis.com/drive/v3/files?q='${yield this.checkFolder(t)}'+in+parents&spaces=appDataFolder&fields=files(id,name)`;return(yield e.get(r,{headers:{Authorization:`Bearer ${i}`}})).data.files.map((e=>e.name))}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQue(e)}))))))}))}deleteFileWithoutQue(t){return v(this,void 0,void 0,(function*(){const i=t.split("/")[1],r=t.split("/")[0],o=yield this.getFolderId(r),n=yield this.refreshToken(),s=yield this.getFileId(i,o);if(""===s)return console.error("File not found:",i),!0;try{const t=yield e.delete(`https://www.googleapis.com/drive/v3/files/${s}`,{headers:{Authorization:`Bearer ${n}`}});return console.error("File deleted:",t),!0}catch(e){return console.error("Error deleting file:",e),!1}}))}refreshToken(){return v(this,void 0,void 0,(function*(){return this.config.access_token&&this.config.expires_at>(new Date).getTime()?this.config.access_token:(this.refreshTokenPromise||(this.refreshTokenPromise=(()=>v(this,void 0,void 0,(function*(){try{let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"google",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}finally{this.refreshTokenPromise=null}})))()),this.refreshTokenPromise)}))}authToken(e){return v(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"google",redirect_uri:k,code:e})).data.refresh_token}))}getAuthUrl(){return`https://accounts.google.com/o/oauth2/v2/auth?redirect_uri=${k}&prompt=consent&response_type=code&client_id=${b}&scope=https://www.googleapis.com/auth/drive.appdata&access_type=offline`}}class B extends j{constructor(e,t,i){super(e,i),this.storagePath=t}uploadFile(r,o){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){try{const n=yield this.refreshToken();let s=r.split("/").pop(),a=o.split(".").pop(),d=L(a||""),c=o.split("/")[0],l=yield this.checkFolder(c),h=yield this.getFileId(s||"",l);const u={mimeType:d,name:s,parents:[l]},p=h?`https://www.googleapis.com/upload/drive/v3/files/${h}?uploadType=resumable`:"https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable",f=(yield e({method:h?"PATCH":"POST",url:p,data:h?null:JSON.stringify(u),headers:{Authorization:"Bearer "+n,"Content-Type":"application/json; charset=UTF-8"},maxContentLength:1/0,maxBodyLength:1/0})).headers.location;let y=yield this.getFileSize(i.join(this.storagePath,r));const g=t.createReadStream(i.join(this.storagePath,r));yield e.put(f,g,{headers:{Authorization:"Bearer "+n,"Content-Type":"application/zip","Content-Range":`bytes 0-${y-1}/${y}`},maxContentLength:1/0,maxBodyLength:1/0});return!0}catch(e){return console.error("Error occurred during upload:",e),!1}}))))))}))}downloadFile(r,o){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){try{const n=yield this.refreshToken();let s=r.split("/").pop(),a=r.split("/")[0],d=yield this.checkFolder(a),c=yield this.getFileId(s||"",d);if(!c)return console.error("File not found"),!1;const l=`https://www.googleapis.com/drive/v3/files/${c}?alt=media`;return new Promise((r=>{const s=t.createWriteStream(i.join(this.storagePath,o));e({url:l,method:"GET",responseType:"stream",headers:{Authorization:"Bearer "+n},maxContentLength:1/0,maxBodyLength:1/0}).then((e=>{e.data.pipe(s),s.on("finish",(()=>{r(!0)})),s.on("error",(()=>{r(!1)}))})).catch((()=>{r(!1)}))}))}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}getFileSize(e){return v(this,void 0,void 0,(function*(){try{return(yield t.promises.stat(e)).size}catch(e){throw e}}))}}class N{constructor(e,t){this.config=e,this.storagePath=t}uploadFile(e,r){return v(this,void 0,void 0,(function*(){let{endpoint:o,region:n,bucketName:d,accessKeyId:c,secretAccessKey:l,dir:h}=this.config;const u=new s({endpoint:o,region:n,credentials:{accessKeyId:c,secretAccessKey:l}});try{let o=yield u.send(new a({Bucket:d,Key:h+"/"+r,Body:t.createReadStream(i.join(this.storagePath,e))}));return 200===o.$metadata.httpStatusCode||(console.error("Error uploading file:",o),!1)}catch(e){return console.error("Error: ",e),!1}}))}downloadFile(e,r){return v(this,void 0,void 0,(function*(){let{endpoint:o,region:n,bucketName:a,accessKeyId:c,secretAccessKey:l,dir:h}=this.config;const u=()=>new Promise(((u,p)=>{const f=new s({region:n,endpoint:o,credentials:{accessKeyId:c,secretAccessKey:l}});let y=t.createWriteStream(i.join(this.storagePath,r));(function(e,t,i,r){return new Promise(((o,n)=>v(this,void 0,void 0,(function*(){const n=yield e.send(new d({Bucket:t,Key:i}));n.Body?(n.Body.pipe(r),r.on("finish",(e=>{e&&o(!1),o(!0)}))):o(!1)}))))})(f,a,h+"/"+e,y).then((e=>{u(!0)})).catch((e=>{console.error(e),u(!1)}))}));try{return yield u()}catch(e){return console.error(e),!1}}))}listFiles(e){return v(this,void 0,void 0,(function*(){let{endpoint:t,region:i,bucketName:r,accessKeyId:o,secretAccessKey:n,dir:a}=this.config;const d=new s({endpoint:t,region:i,credentials:{accessKeyId:o,secretAccessKey:n}});try{const t=yield d.send(new c({Bucket:r,Prefix:a+"/"+e}));return t.Contents?t.Contents.map((t=>{var i;return null===(i=t.Key)||void 0===i?void 0:i.substring((a+"/"+e).length+1)})):[]}catch(e){return console.error(e),[]}}))}deleteFile(e){return v(this,void 0,void 0,(function*(){let{endpoint:t,region:i,bucketName:r,accessKeyId:o,secretAccessKey:n,dir:a}=this.config;const d=new s({endpoint:t,region:i,credentials:{accessKeyId:o,secretAccessKey:n}});try{return yield d.send(new l({Bucket:r,Key:a+"/"+e})),!0}catch(e){return console.error(e),!1}}))}}class M{constructor(e,t){this.storagePath=t;let{username:i,password:r,url:o,dir:n}=e;this.client=h(o,{authType:u.Password,username:i,password:r}),this.username=i,this.password=r,this.dir=n}uploadFile(e,r){return new Promise(((o,n)=>v(this,void 0,void 0,(function*(){try{!1===(yield this.client.exists(i.dirname(this.dir+"/"+r)))&&(yield this.client.createDirectory(i.dirname(this.dir+"/"+r)));let n=this.client.createWriteStream(this.dir+"/"+r);t.createReadStream(i.join(this.storagePath,e)).pipe(n),n.on("finish",(()=>{o(!0)})),n.on("error",(e=>{console.error(e),o(!1)}))}catch(e){console.error("Error uploading file:",e),o(!1)}}))))}downloadFile(e,r){return new Promise(((o,n)=>v(this,void 0,void 0,(function*(){try{!1===(yield this.client.exists(this.dir+"/"+e))&&o(!1);let n=t.createWriteStream(i.join(this.storagePath,r));this.client.createReadStream(this.dir+"/"+e).pipe(n),n.on("finish",(()=>{o(!0)})),n.on("error",(e=>{o(!1)}))}catch(e){console.error("Error occurred during file download:",e),o(!1)}}))))}listFiles(e){return v(this,void 0,void 0,(function*(){try{return(yield this.client.getDirectoryContents(this.dir+"/"+e)).map((e=>e.basename))}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return v(this,void 0,void 0,(function*(){try{return yield this.client.deleteFile(this.dir+"/"+e),!0}catch(e){return console.error("Error deleting file:",e),!1}}))}}class z{constructor(e,t){this.config=e,this.storagePath=t}getClient(){return v(this,void 0,void 0,(function*(){if(this.client)return this.client;let{url:e,username:t,password:i,dir:r,port:o}=this.config;const n=new p;return yield n.connect({host:e,port:o,username:t,password:i}),this.client=n,n}))}uploadFile(e,r){return v(this,void 0,void 0,(function*(){let{dir:o}=this.config,n=yield this.getClient();const s=()=>new Promise(((s,a)=>{let d=t.createReadStream(i.join(this.storagePath,e)),c="/"+o+"/"+r;n.put(d,c).then((()=>{s(!0)})).catch((e=>{console.error(e.message),s(!1)}))}));try{return yield s()}catch(e){return console.error(e),!1}}))}downloadFile(e,r){return v(this,void 0,void 0,(function*(){let{dir:o}=this.config,n=yield this.getClient();const s=()=>new Promise(((s,a)=>{let d="/"+o+"/"+e,c=t.createWriteStream(i.join(this.storagePath,r));n.get(d,c).then((()=>{s(!0)})).catch((e=>{console.error(e.message),s(!1)}))}));try{return yield s()}catch(e){return console.error(e),!1}}))}listFiles(e){return v(this,void 0,void 0,(function*(){let{dir:t}=this.config,i=yield this.getClient();try{return yield new Promise(((r,o)=>{let n="/"+t+"/"+e;i.list(n).then((e=>{r(e.map((e=>e.name)))})).catch((e=>{console.error(e.message),r([])}))}))}catch(e){return console.error(e),[]}}))}deleteFile(e){return v(this,void 0,void 0,(function*(){let{dir:t}=this.config,i=yield this.getClient();try{return yield new Promise(((r,o)=>{let n="/"+t+"/"+e;i.delete(n).then((()=>{r(!0)})).catch((e=>{console.error(e.message),r(!1)}))}))}catch(e){return console.error(e),!1}}))}}class D{downloadFile(e,t){return v(this,void 0,void 0,(function*(){return new Promise((e=>{e(!0)}))}))}uploadFile(e,t){return v(this,void 0,void 0,(function*(){return new Promise((e=>{e(!0)}))}))}listFiles(e){return v(this,void 0,void 0,(function*(){return new Promise((e=>{e([])}))}))}authToken(e){return v(this,void 0,void 0,(function*(){return new Promise((e=>{e("")}))}))}getAuthUrl(){return""}}class W{constructor(e){this.queue=[],this.runningTasks=0,this.maxConcurrency=e}addTask(e){return v(this,void 0,void 0,(function*(){return new Promise(((t,i)=>{const r=()=>v(this,void 0,void 0,(function*(){try{this.runningTasks++;const i=yield e();return t(i),i}catch(e){throw i(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?r():this.queue.push(r)}))}))}runNext(){if(this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}}class K{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.refreshTokenPromise=null,this.taskQueue=new W(3)}retryOperation(e,t=3){return v(this,void 0,void 0,(function*(){let i=0;for(;;){const r=yield e();if(r)return r;if(i>=t)return r;i++;const o=1e3*Math.pow(2,i);console.log(`Retry attempt ${i} after ${o}ms`),yield new Promise((e=>setTimeout(e,o)))}}))}getFolderIdByPath(t){return v(this,void 0,void 0,(function*(){const i=yield this.refreshToken(),r=t.split("/");let o="0";for(const t of r){const r=`https://api.box.com/2.0/folders/${o}/items?fields=id,name&type=folder&limit=1000`;try{const n=(yield e.get(r,{headers:{Authorization:`Bearer ${i}`}})).data.entries.find((e=>e.name===t&&"folder"===e.type));if(n)o=n.id;else{const r={name:t,parent:{id:o},type:"folder"};o=(yield e.post("https://api.box.com/2.0/folders",r,{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}})).data.id}}catch(e){return console.error("Error occurred during folder creation:",e),""}}return o}))}listFiles(t){return v(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken();let r=yield this.getFolderIdByPath("KoodoReader/"+t);return(yield e.get(`https://api.box.com/2.0/folders/${r}/items`,{headers:{Authorization:`Bearer ${i}`}})).data.entries.map((e=>e.name))}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return v(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken(),r=t.substring(0,t.lastIndexOf("/")),o=t.substring(t.lastIndexOf("/")+1),n=yield this.getFolderIdByPath("KoodoReader/"+r);if(!n)return!0;const s=`https://api.box.com/2.0/folders/${n}/items?fields=id,name&type=file&limit=1000`,a=(yield e.get(s,{headers:{Authorization:`Bearer ${i}`}})).data.entries.find((e=>e.name===o&&"file"===e.type));return!a||(yield e.delete(`https://api.box.com/2.0/files/${a.id}`,{headers:{Authorization:`Bearer ${i}`}}),!0)}catch(e){return console.error("Error deleting file:",e),!1}}))}refreshToken(){return v(this,void 0,void 0,(function*(){return this.config.access_token&&this.config.expires_at>(new Date).getTime()?this.config.access_token:(this.refreshTokenPromise||(this.refreshTokenPromise=(()=>v(this,void 0,void 0,(function*(){try{let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"boxnet",refresh_token:e});this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,this.config.refresh_token=t.data.refresh_token;let i=yield this.thirdpartyRequest.encryptToken({token:JSON.stringify({refresh_token:t.data.refresh_token})});return 200===i.code&&(yield this.thirdpartyRequest.TokenService.setToken("boxnet_token",i.data.encrypted_token)),t.data.access_token}finally{this.refreshTokenPromise=null}})))()),this.refreshTokenPromise)}))}authToken(e){return v(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"boxnet",redirect_uri:k,code:e})).data.refresh_token}))}getAuthUrl(){return`https://account.box.com/api/oauth2/authorize?${new URLSearchParams({response_type:"code",client_id:w,redirect_uri:k,grant_type:"authorization_code",box_subject_type:"enterprise",scope:"root_readwrite"}).toString()}`}}class Q extends K{constructor(e,t,i){super(e,i),this.storagePath=t}uploadFile(r,o){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){try{const n=yield this.refreshToken(),s=o.substring(0,o.lastIndexOf("/")),a=o.substring(o.lastIndexOf("/")+1),d=yield this.getFolderIdByPath("KoodoReader/"+s);if(!d)throw new Error("Folder not found");const c=yield this.listFiles(s);c.find((e=>e===a))&&(yield this.deleteFileWithoutQueue(s+"/"+a));const l=new f,h=JSON.stringify({name:a,parent:{id:d}});l.append("attributes",h),l.append("file",t.createReadStream(i.join(this.storagePath,r)));const u=yield e.post("https://upload.box.com/api/2.0/files/content",l,{headers:Object.assign({Authorization:`Bearer ${n}`},l.getHeaders()),maxContentLength:1/0,maxBodyLength:1/0});return!(u.status>=300)||(console.error("Error occurred during file upload:",u),!1)}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(r,o){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){try{const n=yield this.refreshToken(),s=r.substring(0,r.lastIndexOf("/")),a=r.substring(r.lastIndexOf("/")+1),d=yield this.getFolderIdByPath("KoodoReader/"+s);if(!d)return console.error("Folder not found"),!1;const c=`https://api.box.com/2.0/folders/${d}/items?fields=id,name&type=file&limit=1000`,l=(yield e.get(c,{headers:{Authorization:`Bearer ${n}`}})).data.entries.find((e=>e.name===a&&"file"===e.type));if(!l)return console.error("File not found:",a),!1;const h=yield e({url:`https://api.box.com/2.0/files/${l.id}/content`,method:"get",responseType:"stream",headers:{Authorization:`Bearer ${n}`}});return yield new Promise(((e,r)=>{const n=t.createWriteStream(i.join(this.storagePath,o));h.data.pipe(n),n.on("finish",e),n.on("error",r)})),!0}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class J{constructor(e){this.queue=[],this.runningTasks=0,this.maxConcurrency=e}addTask(e){return v(this,void 0,void 0,(function*(){return new Promise(((t,i)=>{const r=()=>v(this,void 0,void 0,(function*(){try{this.runningTasks++;const i=yield e();return t(i),i}catch(e){throw i(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?r():this.queue.push(r)}))}))}runNext(){if(this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}}class H{constructor(e){this.folderCreationLocks=new Map,this.config=e,this.taskQueue=new J(3)}retryOperation(e,t=3){return v(this,void 0,void 0,(function*(){let i=0;for(;;){const r=yield e();if(r)return r;if(i>=t)return r;i++;const o=1e3*Math.pow(2,i);console.log(`Retry attempt ${i} after ${o}ms`),yield new Promise((e=>setTimeout(e,o)))}}))}getStorage(){return v(this,void 0,void 0,(function*(){if(this.storage)return this.storage;let{email:e,password:t}=this.config;return this.storage=yield new y({email:e,password:t}).ready,this.storage}))}getRoot(){return v(this,void 0,void 0,(function*(){if(this.root)return this.root;const e=(yield this.getStorage()).root;let t=e.children.find((e=>"KoodoReader"===e.name&&e.directory));return t||(t=yield e.mkdir("KoodoReader")),this.root=t,this.root}))}createFolder(e,t){return v(this,void 0,void 0,(function*(){const i=`${e.nodeId}_${t}`;if(this.folderCreationLocks.has(i))return yield this.folderCreationLocks.get(i);const r=(()=>v(this,void 0,void 0,(function*(){try{let i=e.children.find((e=>e.name===t&&e.directory));return i||(i=yield e.mkdir(t),i)}finally{this.folderCreationLocks.delete(i)}})))();return this.folderCreationLocks.set(i,r),yield r}))}listFiles(e){return v(this,void 0,void 0,(function*(){try{let t=yield this.getRoot();if(e){const i=e.split("/").filter((e=>e));for(const e of i){const i=t.children.find((t=>t.name===e&&t.directory));if(!i)return[];t=i}}return t.children.filter((e=>!e.directory)).map((e=>e.name))}catch(e){return console.error("Error listing MEGA files:",e),[]}}))}deleteFile(e){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(e){return v(this,void 0,void 0,(function*(){try{let t=yield this.getRoot();const i=e.split("/"),r=i.pop();for(const e of i){if(!e)continue;const i=t.children.find((t=>t.name===e&&t.directory));if(!i)return!0;t=i}const o=t.children.find((e=>e.name===r&&!e.directory));return!o||(yield o.delete(),!0)}catch(e){return console.error("Error deleting MEGA file:",e),!1}}))}}class U extends H{constructor(e,t){super(e),this.storagePath=t}uploadFile(e,r){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){try{let o=yield this.getRoot();const n=r.split("/"),s=n.pop()||"";for(const e of n){if(!e)continue;let t=o.children.find((t=>t.name===e&&t.directory));t||(t=yield this.createFolder(o,e)),o=t}const a=o.children.find((e=>e.name===s&&!e.directory));a&&(yield a.delete());const d=t.createReadStream(i.join(this.storagePath,e)),c=t.statSync(i.join(this.storagePath,e)).size;return yield o.upload({name:s,size:c},d).complete,!0}catch(e){return console.error("Error occurred during MEGA file upload:",e),!1}}))))))}))}downloadFile(e,r){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){try{let o=yield this.getRoot();const n=e.split("/"),s=n.pop()||"";for(const e of n){if(!e)continue;const t=o.children.find((t=>t.name===e&&t.directory));if(!t)return!1;o=t}const a=o.children.find((e=>e.name===s&&!e.directory));if(!a)return!1;const d=t.createWriteStream(i.join(this.storagePath,r));return new Promise((e=>{a.download().pipe(d),d.on("finish",(()=>e(!0))),d.on("error",(t=>{console.error("Error writing file:",t),e(!1)}))}))}catch(e){return console.error("Error occurred during MEGA file download:",e),!1}}))))))}))}}class V{constructor(e){this.queue=[],this.runningTasks=0,this.maxConcurrency=e}addTask(e){return v(this,void 0,void 0,(function*(){return new Promise(((t,i)=>{const r=()=>v(this,void 0,void 0,(function*(){try{this.runningTasks++;const i=yield e();return t(i),i}catch(e){throw i(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?r():this.queue.push(r)}))}))}runNext(){if(this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}}class X{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.driveId="",this.refreshTokenPromise=null,this.taskQueue=new V(1)}retryOperation(e,t=5){return v(this,void 0,void 0,(function*(){let i=0;for(;;){const r=yield e();if(r)return r;if(i>=t)return r;i++;const o=1e3*Math.pow(2,i);console.log(`Retry attempt ${i} after ${o}ms`),yield new Promise((e=>setTimeout(e,o)))}}))}getDriveId(){return v(this,void 0,void 0,(function*(){if(this.driveId)return this.driveId;const t=yield this.refreshToken(),i=yield e.post("https://openapi.alipan.com/adrive/v1.0/user/getDriveInfo",{},{headers:{Authorization:`Bearer ${t}`}});return this.driveId=i.data.default_drive_id,this.driveId}))}getFolderIdByPath(t){return v(this,void 0,void 0,(function*(){const i=yield this.refreshToken(),r=yield this.getDriveId();try{try{const o=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:r,file_path:t},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}});if(o.data)return o.data.file_id}catch(o){const n=t.split("/").filter((e=>e));let s="",a="root";for(const t of n){s+="/"+t;try{a=(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:r,file_path:s},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}})).data.file_id}catch(o){a=(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/create",{drive_id:r,parent_file_id:a,name:t,type:"folder",check_name_mode:"refuse"},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}})).data.file_id}}return a}}catch(e){return console.error("Error getting/creating folder by path:",e),""}}))}listFiles(t){return v(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken(),r=yield this.getDriveId(),o=yield this.getFolderIdByPath("/KoodoReader/"+t);return(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/list",{drive_id:r,parent_file_id:o},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}})).data.items.map((e=>e.name))}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return v(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken(),r=yield this.getDriveId(),o=yield this.getFolderIdByPath("/KoodoReader/"+t);return!o||(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/delete",{drive_id:r,file_id:o},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}}),!0)}catch(e){return console.error("Error deleting file:",e),!1}}))}checkExists(t){var i;return v(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield this.getDriveId(),n=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:o,file_path:t},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});(null===(i=n.data)||void 0===i?void 0:i.file_id)&&(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/recyclebin/trash",{drive_id:o,file_id:n.data.file_id},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}}))}catch(e){}}))}refreshToken(){return v(this,void 0,void 0,(function*(){return this.config.access_token&&this.config.expires_at>(new Date).getTime()?this.config.access_token:(this.refreshTokenPromise||(this.refreshTokenPromise=(()=>v(this,void 0,void 0,(function*(){try{let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"adrive",refresh_token:e});this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,this.config.refresh_token=t.data.refresh_token;let i=yield this.thirdpartyRequest.encryptToken({token:JSON.stringify({refresh_token:t.data.refresh_token})});return 200===i.code&&(yield this.thirdpartyRequest.TokenService.setToken("adrive_token",i.data.encrypted_token)),t.data.access_token}finally{this.refreshTokenPromise=null}})))()),this.refreshTokenPromise)}))}authToken(e){return v(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"adrive",redirect_uri:k,code:e})).data.refresh_token}))}getAuthUrl(){return`https://openapi.alipan.com/oauth/authorize?${new URLSearchParams({response_type:"code",client_id:S,redirect_uri:k,grant_type:"authorization_code",scope:"user:base,file:all:write,file:all:read"}).toString()}`}}class Y extends X{constructor(e,t,i){super(e,i),this.storagePath=t}uploadFile(r,o){return v(this,void 0,void 0,(function*(){return new Promise(((n,s)=>v(this,void 0,void 0,(function*(){try{const s=yield this.refreshToken(),a=yield this.getDriveId(),d=o.substring(0,o.lastIndexOf("/")),c=o.substring(o.lastIndexOf("/")+1);yield this.deleteFile(o);const l=yield this.getFolderIdByPath("/KoodoReader/"+d),h=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/create",{drive_id:a,parent_file_id:l,name:c,type:"file",check_name_mode:"ignore"},{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}}),{file_id:u,upload_id:p,part_info_list:f}=h.data,y=yield t.promises.readFile(i.join(this.storagePath,r));yield fetch(f[0].upload_url,{method:"PUT",body:y,headers:{"Content-Length":t.statSync(i.join(this.storagePath,r)).size.toString()}}),yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/complete",{drive_id:a,file_id:u,upload_id:p},{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}}),n(!0)}catch(e){console.error("Error uploading file:",e),n(!1)}}))))}))}downloadFile(r,o){return new Promise(((n,s)=>v(this,void 0,void 0,(function*(){try{const s=yield this.refreshToken(),a=yield this.getDriveId(),d=(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:a,file_path:"/KoodoReader/"+r},{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}})).data.file_id,c=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/getDownloadUrl",{drive_id:a,file_id:d},{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}}),l=yield e({url:c.data.url,method:"get",responseType:"stream"}),h=t.createWriteStream(i.join(this.storagePath,o));l.data.pipe(h),h.on("finish",(()=>{n(!0)})),h.on("error",(e=>{console.error("Error occurred during file download:",e),n(!1)}))}catch(e){console.error("Error downloading file:",e),n(!1)}}))))}}class G{constructor(e){this.queue=[],this.runningTasks=0,this.maxConcurrency=e}addTask(e){return v(this,void 0,void 0,(function*(){return new Promise(((t,i)=>{const r=()=>v(this,void 0,void 0,(function*(){try{this.runningTasks++;const i=yield e();return t(i),i}catch(e){throw i(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?r():this.queue.push(r)}))}))}runNext(){if(this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}}class Z{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.taskQueue=new G(3)}retryOperation(e,t=5){return v(this,void 0,void 0,(function*(){let i=0;for(;;){const r=yield e();if(r)return r;if(i>=t)return r;i++;const o=1e3*Math.pow(2,i);console.log(`Retry attempt ${i} after ${o}ms`),yield new Promise((e=>setTimeout(e,o)))}}))}checkFolderExists(t,i){return v(this,void 0,void 0,(function*(){try{return 0===(yield e.get("https://api.pcloud.com/listfolder",{params:{access_token:i,path:`/${t}`}})).data.result}catch(e){return console.error("Error checking folder:",e),!1}}))}createFolder(t,i){return v(this,void 0,void 0,(function*(){try{return 0===(yield e.get("https://api.pcloud.com/createfolderifnotexists",{params:{access_token:i,path:`/${t}`}})).data.result}catch(e){return console.error("Error creating folder:",e),!1}}))}listFiles(t){return v(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken(),r=yield e.get("https://api.pcloud.com/listfolder",{params:{access_token:i,path:"/"+t,recursive:0}});return 0!==r.data.result?[]:r.data.metadata.contents.map((e=>e.name))}catch(e){return console.error("Error occurred during file list:",e),[]}}))}deleteFile(e){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return v(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken(),r=yield e.get("https://api.pcloud.com/deletefile",{params:{access_token:i,path:"/"+t}});return 0===r.data.result||(console.error("Error deleting file:",r.data),!0)}catch(e){return console.error("Error occurred during file delete:",e),!1}}))}refreshToken(){return v(this,void 0,void 0,(function*(){return this.config.refresh_token}))}authToken(e){return v(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"pcloud",redirect_uri:k,code:e})).data.access_token}))}getAuthUrl(){return`https://my.pcloud.com/oauth2/authorize?client_id=${E}&response_type=code&redirect_uri=${k}`}}class ee extends Z{constructor(e,t,i){super(e,i),this.storagePath=t}uploadFile(r,o){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){try{const n=yield this.refreshToken(),s=o.split("/").slice(0,-1).join("/");if(!(yield this.checkFolderExists(s,n))){if(!(yield this.createFolder(s,n)))return!1}const a=i.join(this.storagePath,r),d=t.createReadStream(a),c=t.statSync(a),l=i.basename(r),h=yield e({method:"put",url:"https://api.pcloud.com/uploadfile",params:{access_token:n,path:`/${s}`,renew:1,filename:l},data:d,headers:{"Content-Length":c.size,"Content-Type":"application/octet-stream"},maxContentLength:1/0,maxBodyLength:1/0});return 0===h.data.result||(console.error("Error uploading file:",h.data),!1)}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(r,o){return v(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>v(this,void 0,void 0,(function*(){try{const n=yield this.refreshToken(),s=yield e.get("https://api.pcloud.com/getfilelink",{params:{access_token:n,path:`/${r}`}});if(0!==s.data.result)return console.error("Error getting file link:",s.data),!1;const a=i.join(this.storagePath,o),d=t.createWriteStream(a),c=`https://${s.data.hosts[0]}${s.data.path}`,l=yield e({method:"get",url:c,responseType:"stream",maxContentLength:1/0,maxBodyLength:1/0});return new Promise((e=>{l.data.pipe(d),d.on("finish",(()=>{e(!0)})),d.on("error",(t=>{console.error("Error writing file:",t),e(!1)}))}))}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}const te=["book","config","cover","font"];class ie{constructor(e,t,i,r){this.type=e,this.storagePath=i,this.remote="dropbox"===e?new C(t,i,r):"microsoft"===e?new q(t,i,r):"google"===e?new B(t,i,r):"s3compatible"===e?new N(t,i):"webdav"===e?new M(t,i):"ftp"===e?new A(t,i):"sftp"===e?new z(t,i):"boxnet"===e?new Q(t,i,r):"mega"===e?new U(t,i):"adrive"===e?new Y(t,i,r):"pcloud"===e?new ee(t,i,r):new D}downloadFile(e,r,o){return v(this,void 0,void 0,(function*(){return t.existsSync(i.join(this.storagePath+"/"+o))||t.mkdirSync(i.join(this.storagePath+"/"+o)),!!(yield this.listFiles(o)).find((t=>e.indexOf(t)>-1))&&(yield this.remote.downloadFile(o+"/"+e,o+"/"+r))}))}uploadFile(e,t,i){return v(this,void 0,void 0,(function*(){return yield this.remote.uploadFile(i+"/"+e,i+"/"+t)}))}deleteFile(e,t){return v(this,void 0,void 0,(function*(){return yield this.remote.deleteFile(t+"/"+e)}))}isExist(e,t){return v(this,void 0,void 0,(function*(){return(yield this.listFiles(t)).find((t=>-1!==t.indexOf(e)))}))}listFiles(e){return v(this,void 0,void 0,(function*(){return yield this.remote.listFiles(e)}))}downloadAllFiles(){return v(this,void 0,void 0,(function*(){for(let e of te){let t=yield this.listFiles(e);for(let i of t)yield this.downloadFile(i,i,e)}}))}authToken(e){return v(this,void 0,void 0,(function*(){return yield this.remote.authToken(e)}))}getAuthUrl(){return this.remote.getAuthUrl()}}const re={notes:"SELECT * FROM notes WHERE key = ?",bookmarks:"SELECT * FROM bookmarks WHERE key = ?",books:"SELECT * FROM books WHERE key = ?",plugins:"SELECT * FROM plugins WHERE key = ?",words:"SELECT * FROM words WHERE key = ?"},oe={notes:"SELECT * FROM notes WHERE bookKey = ?",bookmarks:"SELECT * FROM bookmarks WHERE bookKey = ?",words:"SELECT * FROM words WHERE bookKey = ?",books:"SELECT * FROM books WHERE key = ?"},ne={notes:"DELETE FROM notes WHERE bookKey = ?",bookmarks:"DELETE FROM bookmarks WHERE bookKey = ?",words:"DELETE FROM words WHERE bookKey = ?"};function se(e){for(const t in e)e.hasOwnProperty(t)&&(e[`temp-${t}`]=e[t]);return e}const ae={notes:e=>{let t=Object.assign({},e);return t.date=JSON.parse(e.date),t.tag=JSON.parse(e.tag),t},bookmarks:e=>e,books:e=>e,plugins:e=>{let t=Object.assign({},e);return e.autoValue||delete t.autoValue,e.langList?t.langList=JSON.parse(e.langList):delete t.langList,e.voiceList?t.voiceList=JSON.parse(e.voiceList):delete t.voiceList,t.config=JSON.parse(e.config),t},words:e=>{let t=Object.assign({},e);return t.date=JSON.parse(e.date),t}};var de={sqlStatement:{createTableStatement:se({notes:'\n      CREATE TABLE IF NOT EXISTS "notes" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "date" object,\n        "chapter" text,\n        "chapterIndex" integer,\n        "text" text,\n        "cfi" text,\n        "range" text,\n        "notes" text,\n        "percentage" text,\n        "color" integer,\n        "tag" array\n      )\n    ',bookmarks:'\n      CREATE TABLE IF NOT EXISTS "bookmarks" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "cfi" text,\n        "label" text,\n        "percentage" text,\n        "chapter" text\n      );\n    ',books:'\n      CREATE TABLE IF NOT EXISTS "books" (\n        "key" text PRIMARY KEY,\n        "name" text,\n        "author" text,\n        "description" text,\n        "md5" text,\n        "cover" text,\n        "format" text,\n        "publisher" text,\n        "size" integer,\n        "page" integer,\n        "path" text,\n        "charset" text\n      );\n    ',plugins:'\n      CREATE TABLE IF NOT EXISTS "plugins" (\n        "key" text PRIMARY KEY,\n        "type" text,\n        "displayName" text,\n        "icon" text,\n        "version" text,\n        "config" object,\n        "autoValue" string,\n        "langList" text,\n        "voiceList" text,\n        "scriptSHA256" text,\n        "script" text\n      );\n    ',words:'\n      CREATE TABLE IF NOT EXISTS "words" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "date" object,\n        "word" text,\n        "chapter" text\n      );\n    '}),getAllStatement:se({notes:"SELECT * FROM notes",bookmarks:"SELECT * FROM bookmarks",books:"SELECT * FROM books",plugins:"SELECT * FROM plugins",words:"SELECT * FROM words"}),saveStatement:se({notes:"INSERT OR REPLACE INTO notes (key, bookKey, chapter, chapterIndex, text, cfi, range, notes, date, percentage, color, tag) VALUES (@key, @bookKey, @chapter, @chapterIndex, @text, @cfi, @range, @notes, @date, @percentage, @color, @tag)",bookmarks:"INSERT OR REPLACE INTO bookmarks (key, bookKey, cfi, label, percentage, chapter) VALUES (@key, @bookKey, @cfi, @label, @percentage, @chapter)",books:"INSERT OR REPLACE INTO books (key, name, author, description, md5, cover, format, publisher, size, page, path, charset) VALUES (@key, @name, @author, @description, @md5, @cover, @format, @publisher, @size, @page, @path, @charset)",plugins:"INSERT OR REPLACE INTO plugins (key, type, displayName, icon, version, config, autoValue, langList, voiceList, scriptSHA256, script) VALUES (@key, @type, @displayName, @icon, @version, @config, @autoValue, @langList, @voiceList, @scriptSHA256, @script)",words:"INSERT OR REPLACE INTO words (key, bookKey, date, word, chapter) VALUES (@key, @bookKey, @date, @word, @chapter)"}),deleteAllStatement:se({notes:"DELETE FROM notes",bookmarks:"DELETE FROM bookmarks",books:"DELETE FROM books",plugins:"DELETE FROM plugins",words:"DELETE FROM words"}),updateStatement:se({notes:"UPDATE notes SET bookKey = @bookKey, chapter = @chapter, chapterIndex = @chapterIndex, text = @text, cfi = @cfi, range = @range, notes = @notes, date = @date, percentage = @percentage, color = @color, tag = @tag WHERE key = @key",bookmarks:"UPDATE bookmarks SET bookKey = @bookKey, cfi = @cfi, label = @label, percentage = @percentage, chapter = @chapter WHERE key = @key",books:"UPDATE books SET name = @name, author = @author, description = @description, md5 = @md5, cover = @cover, format = @format, publisher = @publisher, size = @size, page = @page, path = @path, charset = @charset WHERE key = @key",plugins:"UPDATE plugins SET type = @type, displayName = @displayName, icon = @icon, version = @version, config = @config, autoValue = @autoValue, langList = @langList, voiceList = @voiceList, scriptSHA256 = @scriptSHA256, script = @script WHERE key = @key",words:"UPDATE words SET bookKey = @bookKey, date = @date, word = @word, chapter = @chapter WHERE key = @key"}),deleteStatement:se({notes:"DELETE FROM notes WHERE key = ?",bookmarks:"DELETE FROM bookmarks WHERE key = ?",books:"DELETE FROM books WHERE key = ?",plugins:"DELETE FROM plugins WHERE key = ?",words:"DELETE FROM words WHERE key = ?"}),dropStatement:se({notes:"DROP TABLE IF EXISTS notes",bookmarks:"DROP TABLE IF EXISTS bookmarks",books:"DROP TABLE IF EXISTS books",plugins:"DROP TABLE IF EXISTS plugins",words:"DROP TABLE IF EXISTS words"}),getStatement:se(re),getByBookKeyStatement:se(oe),getByBookKeysStatement:se({notes:e=>`SELECT * FROM notes WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,bookmarks:e=>`SELECT * FROM bookmarks WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,words:e=>`SELECT * FROM words WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,books:e=>`SELECT * FROM books WHERE key IN (${e.map((()=>"?")).join(",")})`}),deleteByBookKeyStatement:se(ne)},jsonToSqlite:se({notes:e=>{let t=Object.assign({},e);return t.date=JSON.stringify(e.date),t.tag=JSON.stringify(e.tag),t},bookmarks:e=>e,books:e=>{let t=Object.assign({},e);return t.page=e.page||0,t},plugins:e=>{let t=Object.assign({},e);return e.autoValue||(t.autoValue=null),e.langList?t.langList=JSON.stringify(e.langList):t.langList=null,e.voiceList?t.voiceList=JSON.stringify(e.voiceList):t.voiceList=null,t.config=JSON.stringify(e.config),t},words:e=>{let t=Object.assign({},e);return t.date=JSON.stringify(e.date),t}}),sqliteToJson:se(ae)};const ce="http://192.168.28.159:8000";class le{constructor(e,t){this.processingQueue=!1,this.requestQueue=[],this.TokenService=e,this.ConfigService=t,this.refreshToken="",this.accessToken="",this.streamPromise=null}refreshUserToken(){return v(this,void 0,void 0,(function*(){if(this.refreshToken=yield this.TokenService.getToken("refresh_token"),!this.refreshToken)return{code:401,message:"refresh token not found"};let t=(yield e.post(ce+"/api/v1/public/user/refresh_token",{refresh_token:this.refreshToken})).data;return 200===t.code&&(yield this.TokenService.setToken("access_token",t.data.access_token),yield this.TokenService.setToken("refresh_token",t.data.refresh_token),this.accessToken=t.data.access_token,this.refreshToken=t.data.refresh_token),t}))}requestWithRetry(e){return v(this,void 0,void 0,(function*(){return this.requestQueue||(this.requestQueue=[]),new Promise(((t,i)=>{this.requestQueue.push({config:e,resolve:t,reject:i}),this.processingQueue||this.processQueue()}))}))}processQueue(){return v(this,void 0,void 0,(function*(){if(!this.processingQueue){this.processingQueue=!0;try{for(;this.requestQueue.length>0;){const e=this.requestQueue.shift();try{let t=yield this.executeRequest(e.config);e.resolve(t)}catch(t){e.reject(t)}}}finally{this.processingQueue=!1}}}))}executeRequest(t){return v(this,void 0,void 0,(function*(){try{try{this.accessToken=(yield this.TokenService.getToken("access_token"))||""}catch(e){console.error("Error get Token:",e)}let i="req-"+Date.now().toString(36)+"-"+Math.random().toString(36).substring(2,11);t.baseURL=ce,t.headers={Authorization:"Bearer "+this.accessToken,"X-Request-ID":i};let r=(yield e(t)).data;if(402===r.code){let i=yield this.refreshUserToken();if(200===i.code){return t.headers=t.headers||{},t.headers.Authorization="Bearer "+this.accessToken,(yield e(t)).data}return i}return 200!==r.code&&this.ConfigService.setItem("errorLog",JSON.stringify({request:t.data,url:t.url,result:r,requestID:i})),r}catch(e){throw console.error("Request execution error:",e),e}}))}requestWithStream(e,t,i){return v(this,void 0,void 0,(function*(){return this.streamPromise||(this.streamPromise=(()=>v(this,void 0,void 0,(function*(){try{let r="";try{r=(yield this.TokenService.getToken("access_token"))||""}catch(e){console.error("Error get Token:",e)}let o="req-"+Date.now().toString(36)+"-"+Math.random().toString(36).substring(2,11);return new Promise(((n,s)=>{const a=new i(ce+e.url,{headers:{"Content-Type":"application/json",Authorization:"Bearer "+r,"X-Request-ID":o},method:e.method,body:JSON.stringify(e.data),pollingInterval:0});a.addEventListener("open",(()=>{console.info("Connection to OpenAI established.")})),a.addEventListener("message",(e=>v(this,void 0,void 0,(function*(){if(!e.data)return;const i=JSON.parse(e.data);i.done?(a.close(),n(i)):(402===i.code&&(yield this.refreshUserToken()),t(i.data))})))),a.addEventListener("error",(e=>{console.error("Error:",e),n({code:500,message:"internal error"}),a.close()}))}))}finally{this.streamPromise=null}})))()),this.streamPromise}))}requestWithFetch(e,t){return v(this,void 0,void 0,(function*(){return this.streamPromise||(this.streamPromise=(()=>v(this,void 0,void 0,(function*(){try{let i="";try{i=(yield this.TokenService.getToken("access_token"))||""}catch(e){console.error("Error get Token:",e)}let r="req-"+Date.now().toString(36)+"-"+Math.random().toString(36).substring(2,11);return console.log(e.data,"config"),new Promise(((o,n)=>v(this,void 0,void 0,(function*(){const n=yield fetch(ce+e.url,{method:"POST",headers:{"Content-Type":"text/event-stream",Authorization:"Bearer "+i,"X-Request-ID":r},body:JSON.stringify(e.data)});if(!n.body)throw new Error("Response body is null");const s=n.body.pipeThrough(new TextDecoderStream).getReader();for(;;){const{value:e,done:i}=yield s.read();if(i)break;if(console.log("Received",e),e)if(e.includes('"code":400')||e.includes('"code":401')||e.includes('"code":402')){console.log("error",e);let t=JSON.parse(e);402===t.code&&(yield this.refreshUserToken()),o(t)}else e.split("\n").forEach((e=>{if(e.startsWith("data:")){const i=JSON.parse(e.substring(5));console.log(i,"data"),t(i.data)}}))}}))))}finally{this.streamPromise=null}})))()),this.streamPromise}))}}class he extends le{constructor(e,t){super(e,t)}encryptToken(e){return v(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/encrypt_token",data:e};return yield this.requestWithRetry(t)}))}decryptToken(e){return v(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/decrypt_token",data:e};return yield this.requestWithRetry(t)}))}authThirdToken(e){return v(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/auth_token",data:e};return yield this.requestWithRetry(t)}))}refreshThirdToken(e){return v(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/refresh_token",data:e};return yield this.requestWithRetry(t)}))}s3Upload(e){return v(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_upload",data:e};return yield this.requestWithRetry(t)}))}s3Download(e){return v(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_download",data:e};return yield this.requestWithRetry(t)}))}s3List(e){return v(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_list",data:e};return yield this.requestWithRetry(t)}))}s3Delete(e){return v(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_delete",data:e};return yield this.requestWithRetry(t)}))}getSyncState(){return v(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"get",url:"/api/v1/pro/thirdparty/get_sync_state"})}))}deleteSyncState(){return v(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/pro/thirdparty/delete_sync_state"})}))}}const ue=new g;class pe{static encrypt(e,t){let i="";for(let r=0;r<e.length;r++){const o=e.charCodeAt(r)^t.charCodeAt(r%t.length);i+=String.fromCharCode(o)}return Buffer.from(i).toString("base64")}static decrypt(e,t){const i=Buffer.from(e,"base64").toString();let r="";for(let e=0;e<i.length;e++){const o=i.charCodeAt(e)^t.charCodeAt(e%t.length);r+=String.fromCharCode(o)}return r}static saveAllToken(e){return v(this,void 0,void 0,(function*(){try{let t=this.encrypt(e,yield this.getFingerprint());ue.set("encryptedToken",t)}catch(e){throw console.error("Failed to save token:",e),e}}))}static getAllToken(){return v(this,void 0,void 0,(function*(){try{let e=ue.get("encryptedToken");if(!e)return"";let t=this.decrypt(e,yield this.getFingerprint());if(t.startsWith("{")&&t.endsWith("}"))return t;const{safeStorage:i}=require("electron");return t=i.decryptString(Buffer.from(e,"base64")),yield this.saveAllToken(t),t}catch(e){return console.error("Failed to read token:",e),null}}))}static setToken(e,t){return v(this,void 0,void 0,(function*(){try{const i=JSON.parse((yield this.getAllToken())||"{}");i[e]=t,yield this.saveAllToken(JSON.stringify(i))}catch(e){throw console.error("Failed to set token:",e),e}}))}static getToken(e){return v(this,void 0,void 0,(function*(){try{return JSON.parse((yield this.getAllToken())||"{}")[e]||null}catch(e){return console.error("Failed to get token:",e),null}}))}static deleteToken(e){return v(this,void 0,void 0,(function*(){try{const t=JSON.parse((yield this.getAllToken())||"{}");delete t[e],yield this.saveAllToken(JSON.stringify(t))}catch(e){throw console.error("Failed to delete token:",e),e}}))}static getFingerprint(){return v(this,void 0,void 0,(function*(){return m.machineIdSync()}))}}const fe=new g;const ye=(ge=class{static getItem(e){return fe.get(e)}static setItem(e,t){fe.set(e,t)}static removeItem(e){fe.delete(e)}},me="desktop",class extends ge{static getReaderConfig(e){return JSON.parse(this.getItem("readerConfig")||"{}")[e]}static setReaderConfig(e,t,i=!0){let r=JSON.parse(this.getItem("readerConfig")||"{}");r[e]=t,this.setItem("readerConfig",JSON.stringify(r)),i&&this.setSyncRecord({type:"config",catergory:"readerConfig",name:me,key:e},{operation:"update",time:Date.now()})}static getAllListConfig(e){return("{}"!==this.getItem(e)&&this.getItem(e)?JSON.parse(this.getItem(e)||""):[])||[]}static deleteListConfig(e,t){let i=this.getAllListConfig(t);const r=i.indexOf(e);r>-1&&i.splice(r,1),this.setAllListConfig(i,t)}static setListConfig(e,t){let i=this.getAllListConfig(t);const r=i.indexOf(e);r>-1?(i.splice(r,1),i.unshift(e)):i.unshift(e),this.setAllListConfig(i,t)}static setAllListConfig(e,t,i=!0){this.setItem(t,JSON.stringify(e)),i&&this.setSyncRecord({type:"config",catergory:"listConfig",name:"general",key:t},{operation:"update",time:Date.now()})}static setObjectConfig(e,t,i,r=!0){let o=this.getAllObjectConfig(i);o[e]=t,r&&this.setSyncRecord({type:"config",catergory:"objectConfig",name:i,key:e},{operation:"update",time:Date.now()}),this.setAllObjectConfig(o,i)}static getObjectConfig(e,t,i){return this.getAllObjectConfig(t)[e]||i}static getAllObjectConfig(e){let t=this.getItem(e);return JSON.parse(t)||{}}static setAllObjectConfig(e,t){this.setItem(t,JSON.stringify(e))}static deleteObjectConfig(e,t){let i=this.getAllObjectConfig(t);delete i[e],this.setSyncRecord({type:"config",catergory:"objectConfig",name:t,key:e},{operation:"delete",time:Date.now()}),this.setAllObjectConfig(i,t)}static getAllMapConfig(e){let t=this.getItem(e);return JSON.parse(t)||{}}static getMapConfig(e,t){return this.getAllMapConfig(t)[e]||[]}static setAllMapConfig(e,t){this.setItem(t,JSON.stringify(e))}static setMapConfig(e,t,i){let r=this.getAllMapConfig(i);void 0===r[e]&&(r[e]=[]),t&&-1===r[e].indexOf(t)&&r[e].unshift(t),this.setSyncRecord({type:"config",catergory:"mapConfig",name:i,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(r,i)}static setOneMapConfig(e,t,i,r=!0){let o=this.getAllMapConfig(i);o[e]=t,r&&this.setSyncRecord({type:"config",catergory:"mapConfig",name:i,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(o,i)}static deleteFromMapConfig(e,t,i){let r=this.getAllMapConfig(i),o=r[e].indexOf(t);r[e].splice(o,1),this.setSyncRecord({type:"config",catergory:"mapConfig",name:i,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(r,i)}static deleteFromAllMapConfig(e,t){let i=this.getAllMapConfig(t);Object.keys(i).forEach((r=>{let o=i[r].indexOf(e);o>-1&&(i[r].splice(o,1),this.setSyncRecord({type:"config",catergory:"mapConfig",name:t,key:r},{operation:"update",time:Date.now()}))})),this.setAllMapConfig(i,t)}static deleteMapConfig(e,t){let i=this.getAllMapConfig(t);delete i[e],this.setSyncRecord({type:"config",catergory:"mapConfig",name:t,key:e},{operation:"delete",time:Date.now()}),this.setAllMapConfig(i,t)}static getFromAllMapConfig(e,t){let i=this.getAllMapConfig(t),r=[];for(let t in i)i[t]&&i[t].indexOf(e)>-1&&r.push(t);return r}static getSyncRecord(e){return JSON.parse(this.getItem("syncRecord")||"{}")[e.type+"."+e.catergory+"."+e.name+"."+e.key]||{operation:"",time:0}}static getAllSyncRecord(){return JSON.parse(this.getItem("syncRecord")||"{}")}static setSyncRecord(e,t){let i=JSON.parse(this.getItem("syncRecord")||"{}");i[e.type+"."+e.catergory+"."+e.name+"."+e.key]=t,this.setItem("syncRecord",JSON.stringify(i))}static setAllSyncRecord(e){this.setItem("syncRecord",JSON.stringify(e))}});var ge,me;export{ye as ConfigService,de as SqlStatement,ie as SyncUtil,he as ThirdpartyRequest,pe as TokenService};
