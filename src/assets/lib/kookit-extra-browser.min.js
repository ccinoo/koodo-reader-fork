import e from"axios";import{Storage as t}from"megajs";import{Buffer as r}from"buffer";import{createClient as o,AuthType as i}from"webdav/dist/web/index.js";import{isElectron as n}from"react-device-detect";function s(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{c(o.next(e))}catch(e){n(e)}}function a(e){try{c(o.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))}const a=e=>"json"===e?"application/json":["jpg","jpeg","png","gif","bmp"].includes(e)?"image/"+e:"zip"===e?"application/zip":"epub"===e?"application/epub+zip":"txt"===e?"text/plain":"pdf"===e?"application/pdf":"mobi"===e?"application/x-mobipocket-ebook":"azw3"===e||"azw"===e?"application/vnd.amazon.ebook":"cbz"===e?"application/x-cbz":"cbr"===e?"application/x-cbr":"cbt"===e?"application/x-cbt":"cb7"===e?"application/x-cb7":"fb2"===e?"application/x-fictionbook+xml":"html"===e?"text/html":"css"===e?"text/css":"js"===e?"application/javascript":"xml"===e?"application/xml":"xhtml"===e?"application/xhtml+xml":"opf"===e?"application/oebps-package+xml":"ncx"===e?"application/x-dtbncx+xml":"mp3"===e?"audio/mpeg":"wav"===e?"audio/wav":"ogg"===e?"audio/ogg":"mp4"===e?"video/mp4":"webm"===e?"video/webm":"avi"===e?"video/x-msvideo":"wmv"===e?"video/x-ms-wmv":"flv"===e?"video/x-flv":"m3u8"===e?"application/x-mpegURL":"ts"===e?"video/MP2T":"3gp"===e?"video/3gpp":"3g2"===e?"video/3gpp2":"db"===e?"application/x-sqlite3":void 0,c=["books","notes","bookmarks","plugins","words"],l=e=>{const t=atob(e),r=t.length,o=new Uint8Array(r);for(let e=0;e<r;e++)o[e]=t.charCodeAt(e);return o.buffer},d=e=>{let t="";const r=new Uint8Array(e),o=r.byteLength;for(let e=0;e<o;e++)t+=String.fromCharCode(r[e]);return btoa(t)};function u(e){const t=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],r=(e,t)=>e>>>t|e<<32-t,o=(e,t,r)=>e&t^~e&r,i=(e,t,r)=>e&t^e&r^t&r,n=e=>r(e,2)^r(e,13)^r(e,22),s=e=>r(e,6)^r(e,11)^r(e,25),a=e=>r(e,7)^r(e,18)^e>>>3,c=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],l=8*e.length,d=(960-(8*e.length+1)%512)%512,u=e.length+Math.ceil((d+1)/8)+8,h=new Uint8Array(u);h.set(e),h[e.length]=128;new DataView(h.buffer,h.byteLength-8).setBigUint64(0,BigInt(l),!1);for(let e=0;e<h.length;e+=64){const l=h.subarray(e,e+64),d=new Uint32Array(64);for(let e=0;e<16;e++)d[e]=l[4*e]<<24|l[4*e+1]<<16|l[4*e+2]<<8|l[4*e+3];for(let e=16;e<64;e++)d[e]=(p=d[e-2],(r(p,17)^r(p,19)^p>>>10)+d[e-7]+a(d[e-15])+d[e-16]>>>0);let[u,f,g,y,m,v,k,b]=c;for(let e=0;e<64;e++){const r=b+s(m)+o(m,v,k)+t[e]+d[e]>>>0,a=n(u)+i(u,f,g)>>>0;b=k,k=v,v=m,m=y+r>>>0,y=g,g=f,f=u,u=r+a>>>0}c[0]=c[0]+u>>>0,c[1]=c[1]+f>>>0,c[2]=c[2]+g>>>0,c[3]=c[3]+y>>>0,c[4]=c[4]+m>>>0,c[5]=c[5]+v>>>0,c[6]=c[6]+k>>>0,c[7]=c[7]+b>>>0}var p;const f=new ArrayBuffer(32),g=new DataView(f);return c.forEach(((e,t)=>{g.setUint32(4*t,e,!1)})),f}class h{constructor(e){this.queue=[],this.runningTasks=0,this.totalTasks=0,this.completedTasks=0,this.maxConcurrency=e}addTask(e){return s(this,void 0,void 0,(function*(){return this.totalTasks++,new Promise(((t,r)=>{const o=()=>s(this,void 0,void 0,(function*(){try{this.runningTasks++;const r=yield e();return this.completedTasks++,t(r),r}catch(e){throw this.completedTasks++,r(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?o():this.queue.push(o)}))}))}runNext(){if(this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}getStats(){return{total:this.totalTasks,completed:this.completedTasks,pending:this.queue.length,running:this.runningTasks}}resetCounters(){this.totalTasks=0,this.completedTasks=0}}var p={getMimeType:a,getExtension:e=>"application/json"===e?"json":e.startsWith("image/")?e.split("/")[1]:"application/zip"===e?"zip":"application/epub+zip"===e?"epub":"text/plain"===e?"txt":"application/pdf"===e?"pdf":"application/x-mobipocket-ebook"===e?"mobi":"application/vnd.amazon.ebook"===e?"azw3":"application/x-cbz"===e?"cbz":"application/x-cbr"===e?"cbr":"application/x-cbt"===e?"cbt":"application/x-cb7"===e?"cb7":"application/x-fictionbook+xml"===e?"fb2":"text/html"===e?"html":"text/css"===e?"css":"application/javascript"===e?"js":"application/xml"===e?"xml":"application/xhtml+xml"===e?"xhtml":"application/oebps-package+xml"===e?"opf":"application/x-dtbncx+xml"===e?"ncx":"audio/mpeg"===e?"mp3":"audio/wav"===e?"wav":"audio/ogg"===e?"ogg":"video/mp4"===e?"mp4":"video/webm"===e?"webm":"video/x-msvideo"===e?"avi":"video/x-ms-wmv"===e?"wmv":"video/x-flv"===e?"flv":"application/x-mpegURL"===e?"m3u8":"video/MP2T"===e?"ts":"video/3gpp"===e?"3gp":"video/3gpp2"===e?"3g2":"application/x-sqlite3"===e?"db":"",databaseList:c,configList:["themeColors","readingTime","cloudSyncTime","recentBooks","recentAdd","deletedBooks","favoriteBooks","shelfList","txtParsers","noteTags","recordLocation","sortedShelfList","kindleDeviceList"],copyArrayBuffer:e=>{var t=new ArrayBuffer(e.byteLength);return new Uint8Array(t).set(new Uint8Array(e)),t},base64ToArrayBuffer:l,arrayBufferToBase64:d,generateSHA256Hash:function(e){return s(this,void 0,void 0,(function*(){const t=(new TextEncoder).encode(e),r="undefined"!=typeof crypto&&crypto.subtle?yield crypto.subtle.digest("SHA-256",t):u(t);return Array.from(new Uint8Array(r)).map((e=>e.toString(16).padStart(2,"0"))).join("")}))},EmailProviders:["gmail.com","qq.com","163.com","yahoo.com","sina.com","126.com","outlook.com","yeah.net","foxmail.com","hotmail.com","protonmail.com","proton.me","icloud.com","mail.com","live.com","aliyun.com"]};const f={publicUrl:"https://api.960960.xyz",cloudUrl:"https://cloud.960960.xyz",devUrl:"http://192.168.28.159:8000"},g={callbackUrl:"https://web.koodoreader.com/",dropboxClientId:"vnc67byrssocvy1",pcloudClientId:"pg8ten0B3vH",boxClientId:"ltimecqanmpxoaicn9qw3es6l3sdl1ya",microsoftClientId:"506df58a-29ab-4020-afc5-6f423dc80f35",googleClientId:"1051055003225-ph1f5fvh328dhv7bco5jitlnfhg6ks2t.apps.googleusercontent.com",facebookClientId:"2845583825559500",githubClientId:"Ov23liJVzfvJMMEEZ8v2",adriveClientId:"a128ae7b9c094545af623de61dc0a1ef"};var y={CloudConfig:f,ThirdpartyConfig:g,LoginAuthRequest:{google:{clientId:g.googleClientId,scopes:["openid"],usePKCE:!1,responseType:"code",redirectUri:g.callbackUrl,extraParams:{prompt:"consent",scope:"openid"}},microsoft:{clientId:g.microsoftClientId,scopes:["openid","profile","User.Read","offline_access"],usePKCE:!1,responseType:"code",redirectUri:g.callbackUrl,extraParams:{scope:"openid profile User.Read offline_access"}},facebook:{clientId:g.facebookClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:g.callbackUrl,extraParams:{scope:""}},github:{clientId:g.githubClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:g.callbackUrl,extraParams:{scope:""}},email:{clientId:"",scopes:[],usePKCE:!1,responseType:"code",redirectUri:g.callbackUrl,extraParams:{scope:""}}},LoginDiscovery:{microsoft:{authorizationEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/authorize",tokenEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/token"},google:{authorizationEndpoint:"https://accounts.google.com/o/oauth2/v2/auth",tokenEndpoint:"https://oauth2.googleapis.com/token"},facebook:{authorizationEndpoint:"https://www.facebook.com/v12.0/dialog/oauth",tokenEndpoint:"https://graph.facebook.com/v12.0/oauth/access_token"},github:{authorizationEndpoint:"https://github.com/login/oauth/authorize",tokenEndpoint:"https://github.com/login/oauth/access_token"},email:{authorizationEndpoint:"",tokenEndpoint:""}},DriveAuthRequest:{dropbox:{clientId:g.dropboxClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:g.callbackUrl,extraParams:{token_access_type:"offline"}},boxnet:{clientId:g.boxClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:g.callbackUrl,extraParams:{grant_type:"authorization_code",box_subject_type:"enterprise",scope:"root_readwrite"}},pcloud:{clientId:g.pcloudClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:g.callbackUrl,extraParams:{grant_type:"authorization_code"}},adrive:{clientId:g.adriveClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:g.callbackUrl,extraParams:{grant_type:"authorization_code",scope:"user:base,file:all:write,file:all:read"}},microsoft:{clientId:g.microsoftClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:g.callbackUrl,extraParams:{scope:"files.readwrite.appfolder offline_access"}},google:{clientId:g.googleClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:g.callbackUrl,extraParams:{prompt:"consent",scope:"https://www.googleapis.com/auth/drive.appdata",access_type:"offline"}}},DriveDiscovery:{dropbox:{authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",tokenEndpoint:"https://www.dropbox.com/oauth2/token"},boxnet:{authorizationEndpoint:"https://account.box.com/api/oauth2/authorize",tokenEndpoint:"https://api.box.com/oauth2/token"},pcloud:{authorizationEndpoint:"https://my.pcloud.com/oauth2/authorize",tokenEndpoint:"https://api.pcloud.com/oauth2_token"},adrive:{authorizationEndpoint:"https://openapi.alipan.com/oauth/authorize",tokenEndpoint:"https://openapi.alipan.com/oauth/token"},microsoft:{authorizationEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/authorize",tokenEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/token"},google:{authorizationEndpoint:"https://accounts.google.com/o/oauth2/v2/auth",tokenEndpoint:"https://oauth2.googleapis.com/token"}}};class m{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.driveId="",this.refreshTokenPromise=null,this.taskQueue=new h(1),void 0===this.config.baseFolder?this.baseFolder="/KoodoReader":this.baseFolder=this.config.baseFolder}retryOperation(e,t=5){return s(this,void 0,void 0,(function*(){let r=0;for(;;){const o=yield e();if(o)return o;if(r>=t)return o;r++;const i=1e3*Math.pow(2,r);console.info(`Retry attempt ${r} after ${i}ms`),yield new Promise((e=>setTimeout(e,i)))}}))}getDriveId(){return s(this,void 0,void 0,(function*(){if(this.driveId)return this.driveId;const t=yield this.refreshToken(),r=yield e.post("https://openapi.alipan.com/adrive/v1.0/user/getDriveInfo",{},{headers:{Authorization:`Bearer ${t}`}});return this.driveId=r.data.default_drive_id,this.driveId}))}getFolderIdByPath(t){return s(this,void 0,void 0,(function*(){const r=yield this.refreshToken(),o=yield this.getDriveId();try{try{const i=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:o,file_path:t},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});if(i.data)return i.data.file_id}catch(i){const n=t.split("/").filter((e=>e));let s="",a="root";for(const t of n){s+="/"+t;try{a=(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:o,file_path:s},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})).data.file_id}catch(i){a=(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/create",{drive_id:o,parent_file_id:a,name:t,type:"folder",check_name_mode:"refuse"},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})).data.file_id}}return a}}catch(e){return console.error("Error getting/creating folder by path:",e),""}}))}listFiles(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield this.getDriveId(),i=yield this.getFolderIdByPath(this.baseFolder+"/"+t);let n=[],s="",a=!0;for(;a;){const t=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/list",{drive_id:o,parent_file_id:i,marker:s||void 0},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}}),c=t.data.items||[];n=n.concat(c),s=t.data.next_marker,a=!!s&&100===c.length}return[...new Set(n.map((e=>e.name)))]}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield this.getDriveId(),i=yield this.getFolderIdByPath(this.baseFolder+"/"+t);return!i||(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/delete",{drive_id:o,file_id:i},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}}),!0)}catch(e){return console.error("Error deleting file:",e),!1}}))}checkExists(t){var r;return s(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),i=yield this.getDriveId(),n=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:i,file_path:t},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});(null===(r=n.data)||void 0===r?void 0:r.file_id)&&(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/recyclebin/trash",{drive_id:i,file_id:n.data.file_id},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}}))}catch(e){}}))}refreshToken(){return s(this,void 0,void 0,(function*(){return this.config.access_token&&this.config.expires_at>(new Date).getTime()?this.config.access_token:(this.refreshTokenPromise||(this.refreshTokenPromise=(()=>s(this,void 0,void 0,(function*(){try{let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"adrive",refresh_token:e});this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,this.config.refresh_token=t.data.refresh_token;let r=yield this.thirdpartyRequest.encryptToken({token:JSON.stringify({refresh_token:t.data.refresh_token})});return 200===r.code&&(yield this.thirdpartyRequest.TokenService.setToken("adrive_token",r.data.encrypted_token)),t.data.access_token}finally{this.refreshTokenPromise=null}})))()),this.refreshTokenPromise)}))}authToken(e){return s(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"adrive",redirect_uri:g.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://openapi.alipan.com/oauth/authorize?${new URLSearchParams({response_type:"code",client_id:g.adriveClientId,redirect_uri:g.callbackUrl,grant_type:"authorization_code",scope:"user:base,file:all:write,file:all:read"}).toString()}`}}class v extends m{constructor(e,t){super(e,t)}uploadFile(t,r){return s(this,void 0,void 0,(function*(){return new Promise(((o,i)=>s(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken(),n=yield this.getDriveId(),s=r.substring(0,r.lastIndexOf("/")),a=r.substring(r.lastIndexOf("/")+1),c=yield this.getFolderIdByPath(this.baseFolder+"/"+s),l=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/create",{drive_id:n,parent_file_id:c,name:a,type:"file",check_name_mode:"ignore"},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}}),{file_id:d,upload_id:u,part_info_list:h}=l.data;yield e.put(h[0].upload_url,t,{headers:{"Content-Type":"application/octet-stream"}}),yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/complete",{drive_id:n,file_id:d,upload_id:u},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}}),o(!0)}catch(e){console.error("Error uploading file:",e),o(!1)}}))))}))}downloadFile(t){return new Promise(((r,o)=>s(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),i=yield this.getDriveId(),n=(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:i,file_path:this.baseFolder+"/"+t},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}})).data.file_id,s=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/getDownloadUrl",{drive_id:i,file_id:n},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}}),a=yield e.get(s.data.url,{responseType:"arraybuffer"});r(a.data)}catch(e){console.error("Error downloading file:",e),r(!1)}}))))}}class k{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.refreshTokenPromise=null,this.taskQueue=new h(3),void 0===this.config.baseFolder?this.baseFolder="KoodoReader":this.baseFolder=this.config.baseFolder}retryOperation(e,t=3){return s(this,void 0,void 0,(function*(){let r=0;for(;;){const o=yield e();if(o)return o;if(r>=t)return o;r++;const i=1e3*Math.pow(2,r);console.info(`Retry attempt ${r} after ${i}ms`),yield new Promise((e=>setTimeout(e,i)))}}))}getFolderIdByPath(t){return s(this,void 0,void 0,(function*(){if(""==t)return"0";const r=yield this.refreshToken(),o=t.split("/");let i="0";for(const t of o){const o=`https://api.box.com/2.0/folders/${i}/items?fields=id,name&type=folder&limit=1000`;try{const n=(yield e.get(o,{headers:{Authorization:`Bearer ${r}`}})).data.entries.find((e=>e.name===t&&"folder"===e.type));if(n)i=n.id;else{const o={name:t,parent:{id:i},type:"folder"};i=(yield e.post("https://api.box.com/2.0/folders",o,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})).data.id}}catch(e){return console.error("Error occurred during folder creation:",e),""}}return i}))}listFiles(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken();let o=this.baseFolder+"/"+t;for(;o.startsWith("/");)o=o.substring(1);let i=yield this.getFolderIdByPath(o),n=[],s=0,a=!0;const c=1e3;for(;a;){const t=yield e.get(`https://api.box.com/2.0/folders/${i}/items`,{params:{limit:c,offset:s},headers:{Authorization:`Bearer ${r}`}}),o=t.data.entries||[];n=n.concat(o),s+=o.length,a=o.length===c&&t.data.total_count>s}return[...new Set(n.map((e=>e.name)))]}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=t.substring(0,t.lastIndexOf("/")),i=t.substring(t.lastIndexOf("/")+1);let n=this.baseFolder+"/"+o;for(;n.startsWith("/");)n=n.substring(1);const s=yield this.getFolderIdByPath(n);if(!s)return!0;const a=`https://api.box.com/2.0/folders/${s}/items?fields=id,name&type=file&limit=1000`,c=(yield e.get(a,{headers:{Authorization:`Bearer ${r}`}})).data.entries.find((e=>e.name===i&&"file"===e.type));return!c||(yield e.delete(`https://api.box.com/2.0/files/${c.id}`,{headers:{Authorization:`Bearer ${r}`}}),!0)}catch(e){return console.error("Error deleting file:",e),!1}}))}refreshToken(){return s(this,void 0,void 0,(function*(){return this.config.access_token&&this.config.expires_at>(new Date).getTime()?this.config.access_token:(this.refreshTokenPromise||(this.refreshTokenPromise=(()=>s(this,void 0,void 0,(function*(){try{let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"boxnet",refresh_token:e});this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,this.config.refresh_token=t.data.refresh_token;let r=yield this.thirdpartyRequest.encryptToken({token:JSON.stringify({refresh_token:t.data.refresh_token})});return 200===r.code&&(yield this.thirdpartyRequest.TokenService.setToken("boxnet_token",r.data.encrypted_token)),t.data.access_token}finally{this.refreshTokenPromise=null}})))()),this.refreshTokenPromise)}))}authToken(e){return s(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"boxnet",redirect_uri:g.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://account.box.com/api/oauth2/authorize?${new URLSearchParams({response_type:"code",client_id:g.boxClientId,redirect_uri:g.callbackUrl,grant_type:"authorization_code",box_subject_type:"enterprise",scope:"root_readwrite"}).toString()}`}}class b extends k{constructor(e,t){super(e,t)}uploadFile(t,r){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),i=r.substring(0,r.lastIndexOf("/")),n=r.substring(r.lastIndexOf("/")+1);let s=this.baseFolder+"/"+i;for(;s.startsWith("/");)s=s.substring(1);const a=yield this.getFolderIdByPath(s);if(!a)throw new Error("Folder not found");const c=(yield this.listFiles(i)).find((e=>e===n));c&&(yield this.deleteFileWithoutQueue(i+"/"+n));let l=new File([t],n,{lastModified:(new Date).getTime(),type:t.type});const d=new FormData;d.append("file",l),d.append("parent_id",a);const u=yield e.post("https://upload.box.com/api/2.0/files/content",d,{headers:{Authorization:`Bearer ${o}`,"Content-Type":"multipart/form-data"},params:{if_match:"false",fields:"name,id"},maxContentLength:1/0,maxBodyLength:1/0});return!(u.status>=300)||(console.error("Error occurred during file upload:",u),!1)}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(t){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=t.substring(0,t.lastIndexOf("/")),i=t.substring(t.lastIndexOf("/")+1);let n=this.baseFolder+"/"+o;for(;n.startsWith("/");)n=n.substring(1);const s=yield this.getFolderIdByPath(n);if(!s)return console.error("Folder not found"),!0;const a=`https://api.box.com/2.0/folders/${s}/items?fields=id,name&type=file&limit=1000`,c=(yield e.get(a,{headers:{Authorization:`Bearer ${r}`}})).data.entries.find((e=>e.name===i&&"file"===e.type));if(!c)return console.error("File not found:",i),!0;const l=yield e({url:`https://api.box.com/2.0/files/${c.id}/content`,method:"get",headers:{Authorization:`Bearer ${r}`},responseType:"arraybuffer"});return l.status>=300?(console.error("Error occurred during file download:",l),!1):l.data}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class w{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.refreshTokenPromise=null,this.taskQueue=new h(3)}retryOperation(e,t=3){return s(this,void 0,void 0,(function*(){let r=0;for(;;){const o=yield e();if(o)return o;if(r>=t)return o;r++;const i=1e3*Math.pow(2,r);console.info(`Retry attempt ${r} after ${i}ms`),yield new Promise((e=>setTimeout(e,i)))}}))}listFiles(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken();let o=[],i=!0,n=null;for(;i;){let s;s=n?yield e.post("https://api.dropboxapi.com/2/files/list_folder/continue",{cursor:n},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}}):yield e.post("https://api.dropboxapi.com/2/files/list_folder",{path:"/"+t,limit:2e3},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});const a=s.data.entries||[];o=o.concat(a),i=s.data.has_more,n=s.data.cursor}return[...new Set(o.map((e=>e.name)))]}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken();yield e.post("https://api.dropboxapi.com/2/files/delete_v2",{path:"/"+t},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});return!0}catch(e){return console.error("Error deleting file:",e),!1}}))}refreshToken(){return s(this,void 0,void 0,(function*(){return this.config.access_token&&this.config.expires_at>(new Date).getTime()?this.config.access_token:(this.refreshTokenPromise||(this.refreshTokenPromise=(()=>s(this,void 0,void 0,(function*(){try{let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"dropbox",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}finally{this.refreshTokenPromise=null}})))()),this.refreshTokenPromise)}))}authToken(e){return s(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"dropbox",redirect_uri:g.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://www.dropbox.com/oauth2/authorize?response_type=code&token_access_type=offline&client_id=${g.dropboxClientId}&redirect_uri=${g.callbackUrl}`}}class T extends w{constructor(e,t){super(e,t)}uploadFile(t,r){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken();let i=r.split("/").pop()||"",n=new File([t],i,{lastModified:(new Date).getTime(),type:t.type});const s=yield e.post("https://content.dropboxapi.com/2/files/upload",n,{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/octet-stream","Dropbox-API-Arg":JSON.stringify({path:"/"+r,mode:"overwrite",autorename:!0,mute:!1})},maxContentLength:1/0,maxBodyLength:1/0});return!(s.status>=300)||(console.error("Error occurred during file upload:",s),!1)}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(t){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield e({url:"https://content.dropboxapi.com/2/files/download",method:"post",headers:{Authorization:`Bearer ${r}`,"Dropbox-API-Arg":JSON.stringify({path:"/"+t})},maxContentLength:1/0,maxBodyLength:1/0,responseType:"arraybuffer"});return o.status>=300?(console.error("Error occurred during file download:",o),!1):o.data}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class E{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.refreshTokenPromise=null,this.taskQueue=new h(3)}retryOperation(e,t=3){return s(this,void 0,void 0,(function*(){let r=0;for(;;){const o=yield e();if(o)return o;if(r>=t)return o;r++;const i=1e3*Math.pow(2,r);console.info(`Retry attempt ${r} after ${i}ms`),yield new Promise((e=>setTimeout(e,i)))}}))}getFileId(t,r){return s(this,void 0,void 0,(function*(){const o=yield this.refreshToken(),i=`https://www.googleapis.com/drive/v3/files?q=name='${t}'+and+'${r}'+in+parents&spaces=appDataFolder&fields=files(id,name)`;try{const t=yield e.get(i,{headers:{Authorization:"Bearer "+o}});if(0===t.data.files.length)return"";const r=t.data.files;return r.length>0?r[0].id:null}catch(e){return console.error("Error occurred during file list retrieval:",e),""}}))}checkFolder(t){return s(this,void 0,void 0,(function*(){const r=yield this.refreshToken(),o=yield this.getFolderId(t);if(o)return o;const i={name:t,mimeType:"application/vnd.google-apps.folder",parents:["appDataFolder"]};try{return(yield e.post("https://www.googleapis.com/drive/v3/files",i,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})).data.id}catch(e){throw console.error("Error occurred during folder creation:",e),e}}))}getFolderId(t){return s(this,void 0,void 0,(function*(){const r=yield this.refreshToken(),o=`https://www.googleapis.com/drive/v3/files?q=name='${t}'+and+mimeType='application/vnd.google-apps.folder'+and+'appDataFolder'+in+parents&spaces=appDataFolder&fields=files(id,name)`;try{const t=(yield e.get(o,{headers:{Authorization:`Bearer ${r}`}})).data.files;return t.length>0?t[0].id:null}catch(e){throw console.error("Error occurred during fetching folder ID:",e),e}}))}listFiles(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken();let o=yield this.checkFolder(t),i=[],n="",s=!0;for(;s;){let t=`https://www.googleapis.com/drive/v3/files?q='${o}'+in+parents&spaces=appDataFolder&fields=nextPageToken,files(id,name)&pageSize=1000`;n&&(t+=`&pageToken=${n}`);const a=yield e.get(t,{headers:{Authorization:`Bearer ${r}`}}),c=a.data.files||[];i=i.concat(c),n=a.data.nextPageToken,s=!!n}return[...new Set(i.map((e=>e.name)))]}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQue(e)}))))))}))}deleteFileWithoutQue(t){return s(this,void 0,void 0,(function*(){const r=t.split("/")[1],o=t.split("/")[0],i=yield this.getFolderId(o),n=yield this.refreshToken(),s=yield this.getFileId(r,i);if(""===s)return console.error("File not found:",r),!0;try{const t=yield e.delete(`https://www.googleapis.com/drive/v3/files/${s}`,{headers:{Authorization:`Bearer ${n}`}});return console.error("File deleted:",t),!0}catch(e){return console.error("Error deleting file:",e),!1}}))}refreshToken(){return s(this,void 0,void 0,(function*(){return this.config.access_token&&this.config.expires_at>(new Date).getTime()?this.config.access_token:(this.refreshTokenPromise||(this.refreshTokenPromise=(()=>s(this,void 0,void 0,(function*(){try{let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"google",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}finally{this.refreshTokenPromise=null}})))()),this.refreshTokenPromise)}))}authToken(e){return s(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"google",redirect_uri:g.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://accounts.google.com/o/oauth2/v2/auth?redirect_uri=${g.callbackUrl}&prompt=consent&response_type=code&client_id=${g.googleClientId}&scope=https://www.googleapis.com/auth/drive.appdata&access_type=offline`}}class C extends E{constructor(e,t){super(e,t)}uploadFile(t,r){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken();let i=r.split("/").pop()||"",n=new File([t],i,{lastModified:(new Date).getTime(),type:t.type}),s=r.split(".").pop(),c=a(s||""),l=r.split("/")[0],d=yield this.checkFolder(l),u=yield this.getFileId(i||"",d);const h={mimeType:c,name:i,parents:[d]},p=u?`https://www.googleapis.com/upload/drive/v3/files/${u}?uploadType=resumable`:"https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable",f=(yield e({method:u?"PATCH":"POST",url:p,data:u?null:JSON.stringify(h),headers:{Authorization:"Bearer "+o,"Content-Type":"application/json; charset=UTF-8"},maxContentLength:1/0,maxBodyLength:1/0})).headers.location,g=yield this.getData(n);if(0===Object.keys(g).length)return!1;const y=yield e.put(f,g.data,{headers:{Authorization:"Bearer "+o,"Content-Type":"application/zip","Content-Range":`bytes 0-${g.fileSize-1}/${g.fileSize}`},maxContentLength:1/0,maxBodyLength:1/0});return!(y.status>=300)||(console.error("Error occurred during file download:",y),!1)}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(t){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken();let o=t.split("/").pop(),i=t.split("/")[0],n=yield this.checkFolder(i),s=yield this.getFileId(o||"",n);if(!s)return console.error("File not found:",o),!0;const a=`https://www.googleapis.com/drive/v3/files/${s}?alt=media`,c=yield e.get(a,{headers:{Authorization:"Bearer "+r},maxContentLength:1/0,maxBodyLength:1/0,responseType:"arraybuffer"});return c.status>=300?(console.error("Error occurred during file download:",c),!1):c.data}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}getData(e){return s(this,void 0,void 0,(function*(){return e?new Promise(((t,r)=>{const o=new FileReader;o.onload=r=>t({fileName:e.name,mimeType:e.type,fileSize:e.size,data:r.target.result}),o.onerror=e=>r(e),o.readAsArrayBuffer(e)})):{}}))}}class x{constructor(e){this.folderCreationLocks=new Map,this.config=e,this.taskQueue=new h(3),void 0===this.config.baseFolder?this.baseFolder="KoodoReader":this.baseFolder=this.config.baseFolder}retryOperation(e,t=3){return s(this,void 0,void 0,(function*(){let r=0;for(;;){const o=yield e();if(o)return o;if(r>=t)return o;r++;const i=1e3*Math.pow(2,r);console.info(`Retry attempt ${r} after ${i}ms`),yield new Promise((e=>setTimeout(e,i)))}}))}getStorage(){return s(this,void 0,void 0,(function*(){if(this.storage)return this.storage;let{email:e,password:r}=this.config;return this.storage=yield new t({email:e,password:r}).ready,this.storage}))}getRoot(){return s(this,void 0,void 0,(function*(){if(this.root)return this.root;const e=(yield this.getStorage()).root;if(""===this.baseFolder)return this.root=e,this.root;let t=e.children.find((e=>e.name===this.baseFolder&&e.directory));return t||(t=yield e.mkdir(this.baseFolder)),this.root=t,this.root}))}createFolder(e,t){return s(this,void 0,void 0,(function*(){const r=`${e.nodeId}_${t}`;if(this.folderCreationLocks.has(r))return yield this.folderCreationLocks.get(r);const o=(()=>s(this,void 0,void 0,(function*(){try{let r=e.children.find((e=>e.name===t&&e.directory));return r||(r=yield e.mkdir(t),r)}finally{this.folderCreationLocks.delete(r)}})))();return this.folderCreationLocks.set(r,o),yield o}))}listFiles(e){return s(this,void 0,void 0,(function*(){try{let t=yield this.getRoot();if(e){const r=e.split("/").filter((e=>e));for(const e of r){const r=t.children.find((t=>t.name===e&&t.directory));if(!r)return[];t=r}}return t.children.map((e=>e.name))}catch(e){return console.error("Error listing MEGA files:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(e){return s(this,void 0,void 0,(function*(){try{let t=yield this.getRoot();const r=e.split("/"),o=r.pop();for(const e of r){if(!e)continue;const r=t.children.find((t=>t.name===e&&t.directory));if(!r)return!0;t=r}const i=t.children.find((e=>e.name===o&&!e.directory));return!i||(yield i.delete(),!0)}catch(e){return console.error("Error deleting MEGA file:",e),!1}}))}}class _ extends x{constructor(e){super(e)}uploadFile(e,t){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{let o=yield this.getRoot();const i=t.split("/"),n=i.pop()||"";for(const e of i){if(!e)continue;let t=o.children.find((t=>t.name===e&&t.directory));t||(t=yield this.createFolder(o,e)),o=t}const s=new File([e],n,{lastModified:(new Date).getTime(),type:e.type}),a=yield e.arrayBuffer(),c=new Uint8Array(a),l=r.from(c),d=o.children.find((e=>e.name===n&&!e.directory));return d&&(yield d.delete()),yield o.upload({name:n,size:s.size},l).complete,!0}catch(e){return console.error("Error occurred during MEGA file upload:",e),!1}}))))))}))}downloadFile(e){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{let t=yield this.getRoot();const r=e.split("/"),o=r.pop()||"";for(const e of r){if(!e)continue;const r=t.children.find((t=>t.name===e&&t.directory));if(!r)return!0;t=r}const i=t.children.find((e=>e.name===o&&!e.directory));if(!i)return!0;return(yield i.downloadBuffer()).buffer}catch(e){return console.error("Error occurred during MEGA file download:",e),!1}}))))))}))}}class S{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.refreshTokenPromise=null,this.taskQueue=new h(3)}retryOperation(e,t=3){return s(this,void 0,void 0,(function*(){let r=0;for(;;){const o=yield e();if(o)return o;if(r>=t)return o;r++;const i=1e3*Math.pow(2,r);console.info(`Retry attempt ${r} after ${i}ms`),yield new Promise((e=>setTimeout(e,i)))}}))}listFiles(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken();let o=[],i=`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}:/children`;for(;i;){const t=yield e.get(i,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});if(t.status>=300)break;const n=t.data.value||[];o=o.concat(n),i=t.data["@odata.nextLink"]||""}return[...new Set(o.map((e=>e.name)))]}catch(e){return console.error("Error occurred during file list:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield e.delete(`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}`,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});return!(o.status>=300)||(console.error("Error deleting file:",o),!0)}catch(e){return console.error("Error occurred during file delete:",e),!1}}))}refreshToken(){return s(this,void 0,void 0,(function*(){return this.config.access_token&&this.config.expires_at>(new Date).getTime()?this.config.access_token:(this.refreshTokenPromise||(this.refreshTokenPromise=(()=>s(this,void 0,void 0,(function*(){try{let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"microsoft",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}finally{this.refreshTokenPromise=null}})))()),this.refreshTokenPromise)}))}authToken(e){return s(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"microsoft",redirect_uri:g.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${g.microsoftClientId}&scope=files.readwrite.appfolder offline_access&response_type=code&redirect_uri=${g.callbackUrl}`}}class R extends S{constructor(e,t){super(e,t)}uploadFile(t,r){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken();let i=r.split("/").pop()||"",n=new File([t],i,{lastModified:(new Date).getTime(),type:t.type});const s="https://graph.microsoft.com/v1.0/me/drive/special/approot:/"+r+":/createUploadSession",a=yield e.post(s,null,{headers:{Authorization:"Bearer "+o,"Content-Type":"application/json"},maxContentLength:1/0,maxBodyLength:1/0});let c=n.size;const l=n.type,d=a.data.uploadUrl,u=yield e.put(d,n,{headers:{"Content-Type":l,"Content-Range":`bytes 0-${c-1}/${c}`},maxContentLength:1/0,maxBodyLength:1/0});return!(u.status>=300)||(console.error("Error occurred during file download:",u),!1)}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(t){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}:/content`,i=yield e.get(o,{responseType:"arraybuffer",headers:{Authorization:"Bearer "+r},maxContentLength:1/0,maxBodyLength:1/0});return i.status>=300?(console.error("Error occurred during file download:",i),!1):i.data}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class O{downloadFile(e,t){return s(this,void 0,void 0,(function*(){return new Promise((e=>{e(!0)}))}))}uploadFile(e,t){return s(this,void 0,void 0,(function*(){return new Promise((e=>{e(!0)}))}))}listFiles(e){return s(this,void 0,void 0,(function*(){return new Promise((e=>{e([])}))}))}authToken(e){return s(this,void 0,void 0,(function*(){return new Promise((e=>{e("")}))}))}getAuthUrl(){return""}}class A{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.taskQueue=new h(3)}retryOperation(e,t=5){return s(this,void 0,void 0,(function*(){let r=0;for(;;){const o=yield e();if(o)return o;if(r>=t)return o;r++;const i=1e3*Math.pow(2,r);console.info(`Retry attempt ${r} after ${i}ms`),yield new Promise((e=>setTimeout(e,i)))}}))}checkFolderExists(t,r){return s(this,void 0,void 0,(function*(){try{return 0===(yield e.get("https://api.pcloud.com/listfolder",{params:{access_token:r,path:`/${t}`}})).data.result}catch(e){return console.error("Error checking folder:",e),!1}}))}createFolder(t,r){return s(this,void 0,void 0,(function*(){try{return 0===(yield e.get("https://api.pcloud.com/createfolderifnotexists",{params:{access_token:r,path:`/${t}`}})).data.result}catch(e){return console.error("Error creating folder:",e),!1}}))}listFiles(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield e.get("https://api.pcloud.com/listfolder",{params:{access_token:r,path:"/"+t,recursive:0}});return 0!==o.data.result?[]:o.data.metadata.contents.map((e=>e.name))}catch(e){return console.error("Error occurred during file list:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield e.get("https://api.pcloud.com/deletefile",{params:{access_token:r,path:"/"+t}});return 0===o.data.result||(console.error("Error deleting file:",o.data),!0)}catch(e){return console.error("Error occurred during file delete:",e),!1}}))}refreshToken(){return s(this,void 0,void 0,(function*(){return this.config.refresh_token}))}authToken(e){return s(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"pcloud",redirect_uri:g.callbackUrl,code:e})).data.access_token}))}getAuthUrl(){return`https://my.pcloud.com/oauth2/authorize?client_id=${g.pcloudClientId}&response_type=code&redirect_uri=${g.callbackUrl}`}}class F extends A{constructor(e,t){super(e,t)}uploadFile(t,r){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),i=r.split("/").slice(0,-1).join("/");if(!(yield this.checkFolderExists(i,o))){if(!(yield this.createFolder(i,o)))return!1}let n=r.split("/").pop()||"",s=new File([t],n,{lastModified:(new Date).getTime(),type:t.type});const a=new FormData;a.append("file",s);const c=yield e.post("https://api.pcloud.com/uploadfile",a,{params:{access_token:o,path:`/${i}`,renew:1},maxContentLength:1/0,maxBodyLength:1/0});return 0===c.data.result||(console.error("Error uploading file:",c.data),!1)}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(t){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield e.get("https://api.pcloud.com/getfilelink",{params:{access_token:r,path:`/${t}`}});if(0!==o.data.result)return console.error("Error getting file link:",o.data),!0;const i=`https://${o.data.hosts[0]}${o.data.path}`,n=yield e.get(i,{responseType:"arraybuffer",maxContentLength:1/0,maxBodyLength:1/0});return n.status>=300?(console.error("Error downloading file:",n),!1):n.data}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class I{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.taskQueue=new h(5),void 0===this.config.baseFolder?this.baseFolder="KoodoReader":this.baseFolder=this.config.baseFolder}retryOperation(e,t=0){return s(this,void 0,void 0,(function*(){let r=0;for(;;){const o=yield e();if(o)return o;if(r>=t)return o;r++;const i=1e3*Math.pow(2,r);console.info(`Retry attempt ${r} after ${i}ms`),yield new Promise((e=>setTimeout(e,i)))}}))}listFiles(e){return s(this,void 0,void 0,(function*(){let{endpoint:t,region:r,bucketName:o,accessKeyId:i,secretAccessKey:n,dir:s}=this.config;s=s&&"KoodoReader"===this.baseFolder?s:this.baseFolder;let a=s+"/"+e;for(;a.startsWith("/");)a=a.substring(1);try{let e=yield this.thirdpartyRequest.s3List({bucket_name:o,prefix:a,region:r,endpoint:t,access_key_id:i,secret_access_key:n});const s=new Set;""===a||a.endsWith("/")||(a+="/");for(const t of e.data.contents){const e=t.substring(a.length).split("/")[0];s.add(e)}return Array.from(s)}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){let{endpoint:t,region:r,bucketName:o,accessKeyId:i,secretAccessKey:n,dir:s}=this.config;s=s&&"KoodoReader"===this.baseFolder?s:this.baseFolder;try{let a=yield this.thirdpartyRequest.s3Delete({bucket_name:o,object_key:s+"/"+e,region:r,endpoint:t,access_key_id:i,secret_access_key:n});return 200===a.code||(console.error("Error deleting file:",a),!1)}catch(e){return console.error("Error deleting file:",e),!1}}))}}class L extends I{constructor(e,t){super(e,t)}uploadFile(t,r){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){let{endpoint:o,region:i,bucketName:n,accessKeyId:s,secretAccessKey:a,dir:c}=this.config;c=c&&"KoodoReader"===this.baseFolder?c:this.baseFolder;let l=c+"/"+r;for(;l.startsWith("/");)l=l.substring(1);try{const c=(yield this.thirdpartyRequest.s3Upload({bucket_name:n,object_key:l,region:i,endpoint:o,access_key_id:s,secret_access_key:a})).data.url;let d=r.split("/").pop()||"",u=new File([t],d,{lastModified:(new Date).getTime(),type:t.type});const h=yield e.put(c,u,{headers:{},maxContentLength:1/0,maxBodyLength:1/0});return!(h.status>=300)||(console.error("Error occurred during file upload:",h),!1)}catch(e){return console.error("Error occurred during file upload:",e),!1}}))))))}))}downloadFile(t){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){let{endpoint:r,region:o,bucketName:i,accessKeyId:n,secretAccessKey:s,dir:a}=this.config;a=a&&"KoodoReader"===this.baseFolder?a:this.baseFolder;let c=a+"/"+t;for(;c.startsWith("/");)c=c.substring(1);try{const t=(yield this.thirdpartyRequest.s3Download({bucket_name:i,object_key:c,region:o,endpoint:r,access_key_id:n,secret_access_key:s})).data.url;return(yield e({url:t,method:"get",headers:{},responseType:"arraybuffer",maxContentLength:1/0,maxBodyLength:1/0})).data}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class M{constructor(e){let{username:t,password:r,url:n,dir:s}=e;void 0===e.baseFolder?this.baseFolder="KoodoReader":this.baseFolder=e.baseFolder,s=s&&"KoodoReader"===this.baseFolder?s:this.baseFolder,this.client=o(n,{authType:i.Password,username:t,password:r}),this.username=t,this.password=r,this.dir=s,this.taskQueue=new h(5)}retryOperation(e,t=0){return s(this,void 0,void 0,(function*(){let r=0;for(;;){const o=yield e();if(o)return o;if(r>=t)return o;r++;const i=1e3*Math.pow(2,r);console.info(`Retry attempt ${r} after ${i}ms`),yield new Promise((e=>setTimeout(e,i)))}}))}uploadFile(t,r){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{!1===(yield this.client.exists(this.dir+"/"+r.substring(0,r.lastIndexOf("/"))))&&(yield this.client.createDirectory(this.dir+"/"+r.substring(0,r.lastIndexOf("/"))));let o=r.split("/").pop()||"",i=new File([t],o,{lastModified:(new Date).getTime(),type:t.type}),n=this.client.getFileUploadLink(this.dir+"/"+r);const s=new URL(n);s.search="",n=s.toString();const a=btoa(this.username+":"+this.password),c=yield e.put(n,i,{headers:{Authorization:"Basic "+a},maxContentLength:1/0,maxBodyLength:1/0});return!(c.status>=300)||(console.error("Error occurred during file upload:",c),!1)}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(t){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const r=this.client.getFileDownloadLink(this.dir+"/"+t),o=btoa(this.username+":"+this.password),i=yield e({url:r,method:"get",headers:{Authorization:"Basic "+o},responseType:"arraybuffer",maxContentLength:1/0,maxBodyLength:1/0});return i.status>=300?(console.error("Error occurred during file download:",i),!1):i.data}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}listFiles(e){return s(this,void 0,void 0,(function*(){try{return(yield this.client.getDirectoryContents(this.dir+"/"+e)).map((e=>e.basename))}catch(t){return t.response&&404===t.response.status&&(yield this.client.createDirectory(this.dir+"/"+e)),console.error("Error listing files:",t),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){try{return yield this.client.deleteFile(this.dir+"/"+e),!0}catch(e){return console.error("Error deleting file:",e),!1}}))}}const j=["book","config","cover","font"];class B{constructor(e,t,r){this.type=e,this.remote="dropbox"===e?new T(t,r):"microsoft"===e?new R(t,r):"google"===e?new C(t,r):"s3compatible"===e?new L(t,r):"webdav"===e?new M(t):"boxnet"===e?new b(t,r):"mega"===e?new _(t):"adrive"===e?new v(t,r):"pcloud"===e?new F(t,r):new O}downloadFile(e,t){return s(this,void 0,void 0,(function*(){return!!(yield this.listFiles(t)).find((t=>e.indexOf(t)>-1))&&(yield this.remote.downloadFile(t+"/"+e))}))}uploadFile(e,t,r){return s(this,void 0,void 0,(function*(){return yield this.remote.uploadFile(r,t+"/"+e)}))}deleteFile(e,t){return s(this,void 0,void 0,(function*(){return!(yield this.listFiles(t)).find((t=>e.indexOf(t)>-1))||(yield this.remote.deleteFile(t+"/"+e))}))}listFiles(e){return s(this,void 0,void 0,(function*(){return yield this.remote.listFiles(e)}))}isExist(e,t){return s(this,void 0,void 0,(function*(){return(yield this.listFiles(t)).find((t=>-1!==t.indexOf(e)))}))}downloadAllFiles(){return s(this,void 0,void 0,(function*(){for(let e of j){let t=yield this.listFiles(e);for(let r of t)yield this.downloadFile(r,e)}}))}authToken(e){return s(this,void 0,void 0,(function*(){return yield this.remote.authToken(e)}))}getAuthUrl(){return this.remote.getAuthUrl?this.remote.getAuthUrl():""}getStats(){return this.remote.taskQueue.getStats()}resetCounters(){this.remote.taskQueue.resetCounters()}}const z={notes:"SELECT * FROM notes WHERE key = ?",bookmarks:"SELECT * FROM bookmarks WHERE key = ?",books:"SELECT * FROM books WHERE key = ?",plugins:"SELECT * FROM plugins WHERE key = ?",words:"SELECT * FROM words WHERE key = ?"},D={notes:"SELECT * FROM notes WHERE bookKey = ?",bookmarks:"SELECT * FROM bookmarks WHERE bookKey = ?",words:"SELECT * FROM words WHERE bookKey = ?",books:"SELECT * FROM books WHERE key = ?"},P={notes:"DELETE FROM notes WHERE bookKey = ?",bookmarks:"DELETE FROM bookmarks WHERE bookKey = ?",words:"DELETE FROM words WHERE bookKey = ?"};function $(e){for(const t in e)e.hasOwnProperty(t)&&(e[`temp-${t}`]=e[t]);return e}const U={notes:e=>{let t=Object.assign({},e);return t.date=JSON.parse(e.date),t.tag=JSON.parse(e.tag),t},bookmarks:e=>e,books:e=>e,plugins:e=>{let t=Object.assign({},e);return e.autoValue||delete t.autoValue,e.langList?t.langList=JSON.parse(e.langList):delete t.langList,e.voiceList?t.voiceList=JSON.parse(e.voiceList):delete t.voiceList,t.config=JSON.parse(e.config),t},words:e=>{let t=Object.assign({},e);return t.date=JSON.parse(e.date),t}};var N,q={sqlStatement:{createTableStatement:$({notes:'\n      CREATE TABLE IF NOT EXISTS "notes" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "date" object,\n        "chapter" text,\n        "chapterIndex" integer,\n        "text" text,\n        "cfi" text,\n        "range" text,\n        "notes" text,\n        "percentage" text,\n        "color" integer,\n        "tag" array\n      )\n    ',bookmarks:'\n      CREATE TABLE IF NOT EXISTS "bookmarks" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "cfi" text,\n        "label" text,\n        "percentage" text,\n        "chapter" text\n      );\n    ',books:'\n      CREATE TABLE IF NOT EXISTS "books" (\n        "key" text PRIMARY KEY,\n        "name" text,\n        "author" text,\n        "description" text,\n        "md5" text,\n        "cover" text,\n        "format" text,\n        "publisher" text,\n        "size" integer,\n        "page" integer,\n        "path" text,\n        "charset" text\n      );\n    ',plugins:'\n      CREATE TABLE IF NOT EXISTS "plugins" (\n        "key" text PRIMARY KEY,\n        "type" text,\n        "displayName" text,\n        "icon" text,\n        "version" text,\n        "config" object,\n        "autoValue" string,\n        "langList" text,\n        "voiceList" text,\n        "scriptSHA256" text,\n        "script" text\n      );\n    ',words:'\n      CREATE TABLE IF NOT EXISTS "words" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "date" object,\n        "word" text,\n        "chapter" text\n      );\n    '}),getAllStatement:$({notes:"SELECT * FROM notes",bookmarks:"SELECT * FROM bookmarks",books:"SELECT * FROM books",plugins:"SELECT * FROM plugins",words:"SELECT * FROM words"}),saveStatement:$({notes:"INSERT OR REPLACE INTO notes (key, bookKey, chapter, chapterIndex, text, cfi, range, notes, date, percentage, color, tag) VALUES (@key, @bookKey, @chapter, @chapterIndex, @text, @cfi, @range, @notes, @date, @percentage, @color, @tag)",bookmarks:"INSERT OR REPLACE INTO bookmarks (key, bookKey, cfi, label, percentage, chapter) VALUES (@key, @bookKey, @cfi, @label, @percentage, @chapter)",books:"INSERT OR REPLACE INTO books (key, name, author, description, md5, cover, format, publisher, size, page, path, charset) VALUES (@key, @name, @author, @description, @md5, @cover, @format, @publisher, @size, @page, @path, @charset)",plugins:"INSERT OR REPLACE INTO plugins (key, type, displayName, icon, version, config, autoValue, langList, voiceList, scriptSHA256, script) VALUES (@key, @type, @displayName, @icon, @version, @config, @autoValue, @langList, @voiceList, @scriptSHA256, @script)",words:"INSERT OR REPLACE INTO words (key, bookKey, date, word, chapter) VALUES (@key, @bookKey, @date, @word, @chapter)"}),deleteAllStatement:$({notes:"DELETE FROM notes",bookmarks:"DELETE FROM bookmarks",books:"DELETE FROM books",plugins:"DELETE FROM plugins",words:"DELETE FROM words"}),updateStatement:$({notes:"UPDATE notes SET bookKey = @bookKey, chapter = @chapter, chapterIndex = @chapterIndex, text = @text, cfi = @cfi, range = @range, notes = @notes, date = @date, percentage = @percentage, color = @color, tag = @tag WHERE key = @key",bookmarks:"UPDATE bookmarks SET bookKey = @bookKey, cfi = @cfi, label = @label, percentage = @percentage, chapter = @chapter WHERE key = @key",books:"UPDATE books SET name = @name, author = @author, description = @description, md5 = @md5, cover = @cover, format = @format, publisher = @publisher, size = @size, page = @page, path = @path, charset = @charset WHERE key = @key",plugins:"UPDATE plugins SET type = @type, displayName = @displayName, icon = @icon, version = @version, config = @config, autoValue = @autoValue, langList = @langList, voiceList = @voiceList, scriptSHA256 = @scriptSHA256, script = @script WHERE key = @key",words:"UPDATE words SET bookKey = @bookKey, date = @date, word = @word, chapter = @chapter WHERE key = @key"}),deleteStatement:$({notes:"DELETE FROM notes WHERE key = ?",bookmarks:"DELETE FROM bookmarks WHERE key = ?",books:"DELETE FROM books WHERE key = ?",plugins:"DELETE FROM plugins WHERE key = ?",words:"DELETE FROM words WHERE key = ?"}),dropStatement:$({notes:"DROP TABLE IF EXISTS notes",bookmarks:"DROP TABLE IF EXISTS bookmarks",books:"DROP TABLE IF EXISTS books",plugins:"DROP TABLE IF EXISTS plugins",words:"DROP TABLE IF EXISTS words"}),getStatement:$(z),getByBookKeyStatement:$(D),getByBookKeysStatement:$({notes:e=>`SELECT * FROM notes WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,bookmarks:e=>`SELECT * FROM bookmarks WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,words:e=>`SELECT * FROM words WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,books:e=>`SELECT * FROM books WHERE key IN (${e.map((()=>"?")).join(",")})`}),deleteByBookKeyStatement:$(P)},jsonToSqlite:$({notes:e=>{let t=Object.assign({},e);return t.date=JSON.stringify(e.date),t.tag=JSON.stringify(e.tag),t},bookmarks:e=>e,books:e=>{let t=Object.assign({},e);return t.page=e.page||0,t},plugins:e=>{let t=Object.assign({},e);return e.autoValue||(t.autoValue=null),e.langList?t.langList=JSON.stringify(e.langList):t.langList=null,e.voiceList?t.voiceList=JSON.stringify(e.voiceList):t.voiceList=null,t.config=JSON.stringify(e.config),t},words:e=>{let t=Object.assign({},e);return t.date=JSON.stringify(e.date),t}}),sqliteToJson:$(U)};class W{constructor(e,t,r,o,i,n,s,a,c,l,d,u){this.key=e,this.name=t,this.author=r,this.description=o,this.md5=i,this.cover=n,this.format=s,this.publisher=a,this.size=c,this.page=l,this.path=d,this.charset=u}}class J{static generateBook(e,t,r,o,i,n,a){return new Promise(((c,l)=>s(this,void 0,void 0,(function*(){try{let s,l,d,u,h,p,f,g,y="";switch([l,d,h,u,p,f]=[e,"","","","",0],t){case"pdf":case"epub":case"mobi":case"azw":case"azw3":case"fb2":g=yield a.getMetadata(),[l,d,h,u,y]=[g.name||e,g.author||"",g.description||"",g.publisher||"",g.cover||""];break;case"cbr":case"cbt":case"cbz":case"cb7":g=yield a.getMetadata(),y=g.cover;break;case"txt":g=yield a.getMetadata(n),p=g.charset}let m=t.toUpperCase();s=(new Date).getTime()+"",c(new W(s,l,d,h,r,y,m,u,o,f,i,p))}catch(e){console.error(e),l(e)}}))))}}N=J,J.getRendtion=(e,t,r,o,i,n,s,a,c,l)=>{let d;var u,h;return"CACHE"===t?d=new l.CacheRender(e,{readerMode:r,animation:i,convertChinese:n,isDarkMode:a,isMobile:c}):"MOBI"===t||"AZW3"===t||"AZW"===t?d=new l.MobiRender(e,{readerMode:r,animation:i,convertChinese:n,isDarkMode:a,isMobile:c}):"EPUB"===t?d=new l.EpubRender(e,{readerMode:r,animation:i,convertChinese:n,isDarkMode:a,isMobile:c}):"TXT"===t?d=new l.TxtRender(e,{readerMode:r,animation:i,charset:o,convertChinese:n,parserRegex:s,isDarkMode:a,isMobile:c}):"MD"===t?d=new l.MdRender(e,{readerMode:r,animation:i,convertChinese:n,isDarkMode:a,isMobile:c}):"PDF"===t?d=new l.PdfRender(e,{readerMode:r,animation:i,convertChinese:n,isDarkMode:a,isMobile:c}):"FB2"===t?d=new l.Fb2Render(e,{readerMode:r,animation:i,convertChinese:n,isDarkMode:a,isMobile:c}):"DOCX"===t?d=new l.DocxRender(e,{readerMode:r,animation:i,convertChinese:n,isDarkMode:a,isMobile:c}):"HTML"===t||"XHTML"===t||"MHTML"===t||"HTM"===t||"XML"===t?d=new l.HtmlRender(e,{readerMode:r,format:t,animation:i,convertChinese:n,isDarkMode:a,isMobile:c}):"CBR"!==t&&"CBT"!==t&&"CBZ"!==t&&"CB7"!==t||(d=new l.ComicRender((u=e,h=new ArrayBuffer(u.byteLength),new Uint8Array(h).set(new Uint8Array(u)),h),{readerMode:r,format:t,animation:i,convertChinese:n,isDarkMode:a,isMobile:c})),d},J.initMobileBook=(e,t,r,o,i,n,a,c,l)=>s(void 0,void 0,void 0,(function*(){try{const s=yield fetch(e);if(!s.ok)throw new Error(`Failed to download book: ${s.status} ${s.statusText}`);const d=yield s.arrayBuffer();window.ReactNativeWebView.postMessage(JSON.stringify({event:"finish-download"})),window.file_content=d;let u=N.getRendtion(d,t,r,o,i,n,a,l,"yes",window.Kookit);window.rendition=u;let h=document.getElementById("page-area");t&&"TXT"===t.toUpperCase()?yield window.rendition.renderTo(h,c):yield window.rendition.renderTo(h),window.rendition.on("rendered",(()=>{let e=window.rendition.getPosition();window.ReactNativeWebView.postMessage(JSON.stringify({event:"content-loaded",bookLocation:e})),window.rendition.tsTransform()})),window.rendition.on("page-changed",(()=>{let e=window.rendition.getPosition();window.ReactNativeWebView.postMessage(JSON.stringify({event:"page-changed",bookLocation:e}))})),window.ReactNativeWebView.postMessage(JSON.stringify({event:"book-inited",chapterList:window.rendition.getChapter()}))}catch(e){window.ReactNativeWebView.postMessage(JSON.stringify({event:"error",message:"Parse book failed"}))}})),J.addMobileBook=(e,t,r,o,i,n,a="")=>s(void 0,void 0,void 0,(function*(){var s;try{if("PDF"===r.toUpperCase()&&i>104857600){t=t.replace(/\.[^/.]+$/,"");let e=r.toUpperCase(),s=(new Date).getTime()+"",a=new W(s,t,"","",o,"",e,"",i,0,n,"");return void window.ReactNativeWebView.postMessage(JSON.stringify({event:"metadata",bookInfo:a}))}const c=yield fetch(e);if(!c.ok)throw new Error(`Failed to download book: ${c.status} ${c.statusText}`);const l=yield c.arrayBuffer();null===(s=window.ReactNativeWebView)||void 0===s||s.postMessage(JSON.stringify({event:"finish-download"})),window.file_content=l;let d=N.getRendtion(l,r.toUpperCase(),"","","","no",a,"no","yes",window.Kookit);window.rendition=d,t=t.replace(/\.[^/.]+$/,"");let u=yield J.generateBook(t,r,o,i,n,l,d);if(!u||!u.key)return;window.ReactNativeWebView.postMessage(JSON.stringify({event:"metadata",bookInfo:u}))}catch(e){window.ReactNativeWebView.postMessage(JSON.stringify({event:"error",message:"Parse book failed"}))}})),J.precacheMobileBook=(e,t)=>s(void 0,void 0,void 0,(function*(){let r=yield window.rendition.preCache(window.file_content);if(""===r)window.ReactNativeWebView.postMessage(JSON.stringify({event:"cache",cacheBase64:"",key:t}));else if("err"!==r){try{const o=`${e}/dav/${"cache-"+t+".zip"}`,i=yield fetch(o,{method:"PUT",headers:{"Content-Type":"application/octet-stream",Overwrite:"T"},body:r});if(!i.ok)throw new Error(`上传失败: ${i.status}`);console.info("文件上传成功")}catch(e){console.error("操作失败:"+e)}window.ReactNativeWebView.postMessage(JSON.stringify({event:"cache",key:t}))}else window.ReactNativeWebView.postMessage(JSON.stringify({event:"error",message:"Parse book failed"}));window.file_content=null,window.rendition=null}));const Q=f.devUrl;class K{constructor(e,t){this.processingQueue=!1,this.requestQueue=[],this.TokenService=e,this.ConfigService=t,this.refreshToken="",this.accessToken="",this.streamPromise=null}refreshUserToken(){return s(this,void 0,void 0,(function*(){if(this.refreshToken=yield this.TokenService.getToken("refresh_token"),!this.refreshToken)return{code:401,message:"refresh token not found"};let t=(yield e.post(Q+"/api/v1/public/user/refresh_token",{refresh_token:this.refreshToken})).data;return 200===t.code&&(yield this.TokenService.setToken("access_token",t.data.access_token),yield this.TokenService.setToken("refresh_token",t.data.refresh_token),this.accessToken=t.data.access_token,this.refreshToken=t.data.refresh_token),t}))}requestWithRetry(e){return s(this,void 0,void 0,(function*(){return this.requestQueue||(this.requestQueue=[]),new Promise(((t,r)=>{this.requestQueue.push({config:e,resolve:t,reject:r}),this.processingQueue||this.processQueue()}))}))}processQueue(){return s(this,void 0,void 0,(function*(){if(!this.processingQueue){this.processingQueue=!0;try{for(;this.requestQueue.length>0;){const e=this.requestQueue.shift();try{let t=yield this.executeRequest(e.config);e.resolve(t)}catch(t){e.reject(t)}}}finally{this.processingQueue=!1}}}))}executeRequest(t){return s(this,void 0,void 0,(function*(){try{try{this.accessToken=(yield this.TokenService.getToken("access_token"))||""}catch(e){console.error("Error get Token:",e)}let r="req-"+Date.now().toString(36)+"-"+Math.random().toString(36).substring(2,11);t.baseURL=Q,t.headers?(t.headers.Authorization="Bearer "+this.accessToken,t.headers["X-Request-ID"]=r):t.headers={Authorization:"Bearer "+this.accessToken,"X-Request-ID":r};let o=(yield e(t)).data;if(402===o.code){let r=yield this.refreshUserToken();if(200===r.code){return t.headers=t.headers||{},t.headers.Authorization="Bearer "+this.accessToken,(yield e(t)).data}return r}return 200!==o.code&&this.ConfigService.setItem("errorLog",JSON.stringify({request:t.data,url:t.url,result:o,requestID:r})),o}catch(e){return console.error("Request execution error:",e),{code:503,message:"network error",data:null}}}))}requestWithStream(e,t,r){return s(this,void 0,void 0,(function*(){return this.streamPromise||(this.streamPromise=(()=>s(this,void 0,void 0,(function*(){try{let o="";try{o=(yield this.TokenService.getToken("access_token"))||""}catch(e){console.error("Error get Token:",e)}let i="req-"+Date.now().toString(36)+"-"+Math.random().toString(36).substring(2,11);return new Promise(((n,a)=>{const c=new r(Q+e.url,{headers:{"Content-Type":"application/json",Authorization:"Bearer "+o,"X-Request-ID":i},method:e.method,body:JSON.stringify(e.data),pollingInterval:0});c.addEventListener("open",(()=>{console.info("Connection to OpenAI established.")})),c.addEventListener("message",(e=>s(this,void 0,void 0,(function*(){if(!e.data)return;const r=JSON.parse(e.data);r.done?(c.close(),n(r)):(402===r.code&&(yield this.refreshUserToken()),t(r.data))})))),c.addEventListener("error",(e=>{if(console.info("Error:",e),!e.data)return;const t=JSON.parse(e.data);n(t),c.close()}))}))}finally{this.streamPromise=null}})))()),this.streamPromise}))}requestWithFetch(e,t){return s(this,void 0,void 0,(function*(){return this.streamPromise||(this.streamPromise=(()=>s(this,void 0,void 0,(function*(){try{let r="";try{r=(yield this.TokenService.getToken("access_token"))||""}catch(e){console.error("Error get Token:",e)}let o="req-"+Date.now().toString(36)+"-"+Math.random().toString(36).substring(2,11);return new Promise(((i,n)=>s(this,void 0,void 0,(function*(){const n=yield fetch(Q+e.url,{method:"POST",headers:{"Content-Type":"text/event-stream",Authorization:"Bearer "+r,"X-Request-ID":o},body:JSON.stringify(e.data)});if(!n.body)throw new Error("Response body is null");const s=n.body.pipeThrough(new TextDecoderStream).getReader();for(;;){const{value:e,done:r}=yield s.read();if(r){t({done:!0});break}if(e)if(e.includes('"code":400')||e.includes('"code":401')||e.includes('"code":402')){let t=JSON.parse(e);402===t.code&&(yield this.refreshUserToken()),i(t)}else e.split("\n").forEach((e=>{if(e.startsWith("data:")){const r=JSON.parse(e.substring(5));t(r.data)}}))}i({code:200,data:{done:!0}})}))))}finally{this.streamPromise=null}})))()),this.streamPromise}))}}class H extends K{constructor(e,t){super(e,t)}getTransStream(e,t,r){return s(this,void 0,void 0,(function*(){const o={method:"post",url:"/api/v1/pro/reader/get_llm_trans_stream",data:e};return yield this.requestWithStream(o,t,r)}))}getTransFetch(e,t){return s(this,void 0,void 0,(function*(){const r={method:"post",url:"/api/v1/pro/reader/get_llm_trans_stream",data:e};return yield this.requestWithFetch(r,t)}))}getDictionary(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/reader/get_llm_dict",data:e};return yield this.requestWithRetry(t)}))}getSummaryStream(e,t,r){return s(this,void 0,void 0,(function*(){const o={method:"post",url:"/api/v1/pro/reader/get_llm_sum_stream",data:e};return yield this.requestWithStream(o,t,r)}))}getAnswerStream(e,t,r){return s(this,void 0,void 0,(function*(){const o={method:"post",url:"/api/v1/pro/reader/get_llm_answer_stream",data:e};return yield this.requestWithStream(o,t,r)}))}getAnswerFetch(e,t){return s(this,void 0,void 0,(function*(){const r={method:"post",url:"/api/v1/pro/reader/get_llm_answer_stream",data:e};return yield this.requestWithFetch(r,t)}))}getSummaryFetch(e,t){return s(this,void 0,void 0,(function*(){const r={method:"post",url:"/api/v1/pro/reader/get_llm_sum_stream",data:e};return yield this.requestWithFetch(r,t)}))}getGoogleFont(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/reader/get_google_font",data:e};return yield this.requestWithRetry(t)}))}sendToKindle(e){return s(this,void 0,void 0,(function*(){let t=new FormData;t.append("file",e.file),t.append("email",e.email),t.append("file_name",e.fileName);const r={method:"post",url:"/api/v1/pro/reader/send_to_kindle",headers:{"Content-Type":"multipart/form-data"},data:t};return yield this.requestWithRetry(r)}))}}class V extends K{constructor(e,t){super(e,t)}encryptToken(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/encrypt_token",data:e};return yield this.requestWithRetry(t)}))}decryptToken(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/decrypt_token",data:e};return yield this.requestWithRetry(t)}))}authThirdToken(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/auth_token",data:e};return yield this.requestWithRetry(t)}))}refreshThirdToken(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/refresh_token",data:e};return yield this.requestWithRetry(t)}))}s3Upload(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_upload",data:e};return yield this.executeRequest(t)}))}s3Download(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_download",data:e};return yield this.executeRequest(t)}))}s3List(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_list",data:e};return yield this.executeRequest(t)}))}s3Delete(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_delete",data:e};return yield this.executeRequest(t)}))}getSyncData(){return s(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"get",url:"/api/v1/pro/thirdparty/get_sync_data"})}))}updateSyncData(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/update_sync_data",data:e};return yield this.requestWithRetry(t)}))}}class X extends K{constructor(e,t){super(e,t)}loginRegister(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/public/user/login_register",data:e};return yield this.requestWithRetry(t)}))}logout(){return s(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/member/user/logout"})}))}getLogins(){return s(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/member/user/get_logins"})}))}addLogin(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/member/user/add_login",data:e};return yield this.requestWithRetry(t)}))}removeLogin(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/member/user/remove_login",data:e};return yield this.requestWithRetry(t)}))}getUserInfo(){return s(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/member/user/get_info"})}))}getUserConfig(){return s(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"get",url:"/api/v1/member/user/get_config"})}))}updateUserConfig(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/member/user/update_config",data:e};return yield this.requestWithRetry(t)}))}getTempToken(){return s(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"get",url:"/api/v1/member/user/get_temp_token"})}))}sendEmailCode(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/public/user/send_email_code",data:e};return yield this.requestWithRetry(t)}))}checkEmailRegistration(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/public/user/check_email_registration",data:e};return yield this.requestWithRetry(t)}))}redeemCode(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/member/user/redeem_code",data:e};return yield this.requestWithRetry(t)}))}deleteAccount(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/member/user/delete_account",data:e};return yield this.requestWithRetry(t)}))}}var Y={getAuthUrl:(e,t)=>{let r="";if("github"===e?r=`https://github.com/login/oauth/authorize?client_id=${g.githubClientId}&redirect_uri=${g.callbackUrl}&scope=openid`:"google"===e?r=`https://accounts.google.com/o/oauth2/v2/auth?redirect_uri=${g.callbackUrl}&prompt=consent&response_type=code&client_id=${g.googleClientId}&scope=openid&access_type=offline`:"facebook"===e?r=`https://www.facebook.com/v12.0/dialog/oauth?client_id=${g.facebookClientId}&redirect_uri=${g.callbackUrl}&scope=&response_type=code`:"microsoft"===e&&(r=`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${g.microsoftClientId}&scope=openid profile User.Read offline_access&response_type=code&redirect_uri=${g.callbackUrl}`),"manual"===t)return r;let o=JSON.stringify({deeplink:"desktop"===t?"koodo-reader://callback":"browser"===t?"https://web.koodoreader.com/#/login":"",service:e});return`${r}&state=${"state|"+encodeURIComponent(o)}`}};class G{static CompareDatabase(e,t,r){return s(this,void 0,void 0,(function*(){let o=Object.keys(e).filter((e=>e.startsWith("database.sqlite.books"))),i=Object.keys(e).filter((e=>e.startsWith("database.sqlite.notes"))),n=Object.keys(e).filter((e=>e.startsWith("database.sqlite.bookmarks"))),s=Object.keys(e).filter((e=>e.startsWith("database.sqlite.plugins"))),a=Object.keys(e).filter((e=>e.startsWith("database.sqlite.words"))),c=Object.keys(t).filter((e=>e.startsWith("database.sqlite.books"))),l=Object.keys(t).filter((e=>e.startsWith("database.sqlite.notes"))),d=Object.keys(t).filter((e=>e.startsWith("database.sqlite.bookmarks"))),u=Object.keys(t).filter((e=>e.startsWith("database.sqlite.plugins"))),h=Object.keys(t).filter((e=>e.startsWith("database.sqlite.words"))),p={books:Array.from(new Set(o.concat(c))),notes:Array.from(new Set(i.concat(l))),bookmarks:Array.from(new Set(n.concat(d))),plugins:Array.from(new Set(s.concat(u))),words:Array.from(new Set(a.concat(h)))},f={books:{save:[],update:[],delete:[],conflict:[],upload:[]},notes:{save:[],update:[],delete:[],conflict:[],upload:[]},bookmarks:{save:[],update:[],delete:[],conflict:[],upload:[]},plugins:{save:[],update:[],delete:[],conflict:[],upload:[]},words:{save:[],update:[],delete:[],conflict:[],upload:[]}},g=["books","notes","bookmarks","plugins","words"];for(let o of g)for(let i of p[o]){let n=i.split(".")[3],s=e[i],a=t[i];s?a?("save"===a.operation&&("update"===s.operation||"delete"===s.operation?f[o].upload.push(n):console.info("ignore",a)),"delete"===a.operation&&("save"===s.operation&&(f[o].delete.push(n),e[i]=a),"update"===s.operation&&(s.time<a.time?(f[o].delete.push(n),e[i]=a):s.time>a.time?(f[o].conflict.push(n),"cloud"===r?(f[o].delete.push(n),e[i]=a):f[o].upload.push(n)):console.info("ignore",a)),"delete"===s.operation&&console.info("ignore",a)),"update"===a.operation&&("save"===s.operation&&(f[o].update.push(n),e[i]=a),"update"===s.operation&&(s.time<a.time?(f[o].update.push(n),e[i]=a):s.time>a.time?f[o].upload.push(n):console.info("ignore",a)),"delete"===s.operation&&(s.time<a.time?(f[o].conflict.push(n),"cloud"===r?(f[o].save.push(n),e[i]=a):f[o].upload.push(n)):s.time>a.time?f[o].upload.push(n):console.info("ignore",a)))):f[o].upload.push(n):(f[o].save.push(n),e[i]=a)}return{compareResult:f,syncRecords:e}}))}static CompareConfig(e,t,r){return s(this,void 0,void 0,(function*(){let o=Object.keys(e).filter((e=>e.startsWith("config.readerConfig"))),i=Object.keys(e).filter((e=>e.startsWith("config.listConfig"))),n=Object.keys(e).filter((e=>e.startsWith("config.objectConfig"))),s=Object.keys(e).filter((e=>e.startsWith("config.mapConfig"))),a=Object.keys(t).filter((e=>e.startsWith("config.readerConfig"))),c=Object.keys(t).filter((e=>e.startsWith("config.listConfig"))),l=Object.keys(t).filter((e=>e.startsWith("config.objectConfig"))),d=Object.keys(t).filter((e=>e.startsWith("config.mapConfig"))),u={readerConfig:Array.from(new Set(o.concat(a))),listConfig:Array.from(new Set(i.concat(c))),objectConfig:Array.from(new Set(n.concat(l))),mapConfig:Array.from(new Set(s.concat(d)))},h={readerConfig:{update:[],upload:[]},listConfig:{update:[],upload:[]},objectConfig:{update:[],delete:[],conflict:[],upload:[]},mapConfig:{update:[],delete:[],conflict:[],upload:[]}},p=["readerConfig","listConfig"];for(let r of p)for(let o of u[r]){let i=o,n=e[o],s=t[o];n?s?n.time<s.time?(h[r].update.push(i),e[o]=s):n.time>s.time?h[r].upload.push(i):console.info("ignore",s):h[r].upload.push(i):(h[r].update.push(i),e[o]=s)}let f=["objectConfig","mapConfig"];for(let o of f)for(let i of u[o]){let n=i,s=e[i],a=t[i];s?a?("delete"===a.operation&&("update"===s.operation&&(s.time<a.time?(h[o].delete.push(n),e[i]=a):s.time>a.time?(h[o].conflict.push(n),"cloud"===r?(h[o].delete.push(n),e[i]=a):h[o].upload.push(n)):console.info("ignore",a)),"delete"===s.operation&&console.info("ignore",a)),"update"===a.operation&&("update"===s.operation&&(s.time<a.time?(h[o].update.push(n),e[i]=a):s.time>a.time?h[o].upload.push(n):console.info("ignore",a)),"delete"===s.operation&&(s.time<a.time?(h[o].conflict.push(n),"cloud"===r?(h[o].save.push(n),e[i]=a):h[o].upload.push(n)):s.time>a.time?h[o].upload.push(n):console.info("ignore",a)))):h[o].upload.push(n):(h[o].update.push(n),e[i]=a)}return{compareResult:h,syncRecords:e}}))}static compareAll(e,t,r,o,i){return s(this,void 0,void 0,(function*(){let n="cloud";if("yes"===r.getReaderConfig("isKeepLocal")){n="local";let e=r.getObjectConfig(yield o.getFingerprint(),"cloudSyncTime",{time:0,conflictMode:"cloud"}),t=yield i.getCloudConfig("config"),s=JSON.parse(t.cloudSyncTime||"{}");delete s[yield o.getFingerprint()],Object.values(s).filter((t=>"local"===t.conflictMode&&t.time>e.time)).length>0&&(n="cloud")}let{compareResult:s,syncRecords:a}=yield this.CompareDatabase(e,t,n),{compareResult:c,syncRecords:l}=yield this.CompareConfig(a,t,n),d=Object.assign(Object.assign({},s),c);return r.setAllSyncRecord(l),"local"===n&&(d.books.conflict.length>0||d.notes.conflict.length>0||d.bookmarks.conflict.length>0||d.plugins.conflict.length>0||d.words.conflict.length>0||d.objectConfig.conflict.length>0||d.mapConfig.conflict.length>0)?r.setObjectConfig(yield o.getFingerprint(),{time:(new Date).getTime(),conflictMode:"local"},"cloudSyncTime"):r.setObjectConfig(yield o.getFingerprint(),{time:(new Date).getTime(),conflictMode:"cloud"},"cloudSyncTime"),d}))}static startSync(e,t,r,o,i,n){return s(this,void 0,void 0,(function*(){return[...yield this.syncConfig(e,t,r,i,o),...yield this.syncCover(t,n,i),...yield this.syncBook(t,i)]}))}static syncConfig(e,t,r,o,i){return s(this,void 0,void 0,(function*(){let n=[];for(let t of c){if(e[t].save.length+e[t].update.length>0){let o=yield i.getCloudDatabase(t);for(let i of e[t].save){let e=o.find((e=>e.key===i));e&&(yield r.saveRecord(e,t))}for(let i of e[t].update){let e=o.find((e=>e.key===i));e&&(yield r.updateRecord(e,t,!1))}}if(e[t].delete.length>0)for(let i of e[t].delete)yield r.deleteRecord(i,t),"books"===t&&(yield o.deleteOfflineBook(i))}if(e.readerConfig.update.length>0||e.listConfig.update.length>0||e.objectConfig.update.length>0||e.mapConfig.update.length>0){let r=yield i.getCloudConfig("config");for(let o of e.readerConfig.update){let e=o.split(".")[3];r.readerConfig&&t.setReaderConfig(e,JSON.parse(r.readerConfig)[e],!1)}for(let o of e.listConfig.update){let e=o.split(".")[3];r[e]&&t.setAllListConfig(JSON.parse(r[e]),e,!1)}for(let o of e.objectConfig.update){let e=o.split(".")[3],i=o.split(".")[2];r[i]&&JSON.parse(r[i])&&JSON.parse(r[i])[e]&&t.setObjectConfig(e,JSON.parse(r[i])[e],i,!1)}for(let o of e.mapConfig.update){let e=o.split(".")[3],i=o.split(".")[2];if(r[i]&&JSON.parse(r[i])&&JSON.parse(r[i])[e]){let o=JSON.parse(r[i])[e];t.setOneMapConfig(e,o,i,!1)}}}if(e.objectConfig.delete.length>0||e.mapConfig.delete.length>0){for(let r of e.objectConfig.delete){let e=r.split(".")[3],o=r.split(".")[2];t.deleteObjectConfig(e,o)}for(let r of e.mapConfig.delete){let e=r.split(".")[3],o=r.split(".")[2];t.deleteMapConfig(e,o)}}for(let t of c)e[t].upload.length>0&&n.push((()=>i.uploadDatabase(t)));return n.push((()=>i.uploadConfig("config"))),n.push((()=>i.uploadConfig("sync"))),n}))}static syncCover(e,t,r){return s(this,void 0,void 0,(function*(){let r=yield t.getLocalCoverList(),o=yield t.getCloudCoverList(),i=Array.from(new Set([...r,...o])),n=[];for(let s of i)r.includes(s)&&!o.includes(s)&&n.push((()=>t.uploadCover(s))),!r.includes(s)&&o.includes(s)&&"adrive"!==e.getItem("defaultSyncOption")&&n.push((()=>t.downloadCover(s)));return n}))}static syncBook(e,t){return s(this,void 0,void 0,(function*(){let r=yield t.getLocalBookList(),o=yield t.getCloudBookList(),i=[],n=Array.from(new Set([...r,...o]));for(let s of n){if(r.includes(s)&&!o.includes(s)){let e=s.split(".")[0],r=s.split(".")[1];i.push((()=>t.uploadBook(e,r)))}let n="yes"===e.getReaderConfig("autoOffline");if(!r.includes(s)&&o.includes(s)&&n&&"adrive"!==e.getItem("defaultSyncOption")){let e=s.split(".")[0],r=s.split(".")[1];i.push((()=>t.offlineBook(e,r.toUpperCase())))}}return i}))}static runTasksWithLimit(e,t,r){return s(this,void 0,void 0,(function*(){if("ftp"!==r&&"adrive"!==r){const r=[],o=[];for(const i of e){const e=i().then((t=>(o.splice(o.indexOf(e),1),t)));r.push(e),o.push(e),o.length>=t&&(yield Promise.race(o))}return Promise.all(r)}for(let t of e)yield t()}))}}const Z=(ee=class{static getItem(e){return localStorage.getItem(e)}static setItem(e,t){localStorage.setItem(e,t)}static removeItem(e){localStorage.removeItem(e)}},te="browser",class extends ee{static getReaderConfig(e){return JSON.parse(this.getItem("readerConfig")||"{}")[e]}static setReaderConfig(e,t,r=!0){let o=JSON.parse(this.getItem("readerConfig")||"{}");o[e]=t,this.setItem("readerConfig",JSON.stringify(o)),r&&this.setSyncRecord({type:"config",catergory:"readerConfig",name:te,key:e},{operation:"update",time:Date.now()})}static getAllListConfig(e){return("{}"!==this.getItem(e)&&this.getItem(e)?JSON.parse(this.getItem(e)||""):[])||[]}static deleteListConfig(e,t){let r=this.getAllListConfig(t);const o=r.indexOf(e);o>-1&&r.splice(o,1),this.setAllListConfig(r,t)}static setListConfig(e,t){let r=this.getAllListConfig(t);const o=r.indexOf(e);o>-1?(r.splice(o,1),r.unshift(e)):r.unshift(e),this.setAllListConfig(r,t)}static setAllListConfig(e,t,r=!0){this.setItem(t,JSON.stringify(e)),r&&this.setSyncRecord({type:"config",catergory:"listConfig",name:"general",key:t},{operation:"update",time:Date.now()})}static setObjectConfig(e,t,r,o=!0){let i=this.getAllObjectConfig(r);i[e]=t,o&&this.setSyncRecord({type:"config",catergory:"objectConfig",name:r,key:e},{operation:"update",time:Date.now()}),this.setAllObjectConfig(i,r)}static getObjectConfig(e,t,r){return this.getAllObjectConfig(t)[e]||r}static getAllObjectConfig(e){let t=this.getItem(e);return JSON.parse(t)||{}}static setAllObjectConfig(e,t){this.setItem(t,JSON.stringify(e))}static deleteObjectConfig(e,t){let r=this.getAllObjectConfig(t);delete r[e],this.setSyncRecord({type:"config",catergory:"objectConfig",name:t,key:e},{operation:"delete",time:Date.now()}),this.setAllObjectConfig(r,t)}static getAllMapConfig(e){let t=this.getItem(e);return JSON.parse(t)||{}}static getMapConfig(e,t){return this.getAllMapConfig(t)[e]||[]}static setAllMapConfig(e,t){this.setItem(t,JSON.stringify(e))}static setMapConfig(e,t,r){let o=this.getAllMapConfig(r);void 0===o[e]&&(o[e]=[]),t&&-1===o[e].indexOf(t)&&o[e].unshift(t),this.setSyncRecord({type:"config",catergory:"mapConfig",name:r,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(o,r)}static setOneMapConfig(e,t,r,o=!0){let i=this.getAllMapConfig(r);i[e]=t,o&&this.setSyncRecord({type:"config",catergory:"mapConfig",name:r,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(i,r)}static deleteFromMapConfig(e,t,r){let o=this.getAllMapConfig(r),i=o[e].indexOf(t);o[e].splice(i,1),this.setSyncRecord({type:"config",catergory:"mapConfig",name:r,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(o,r)}static deleteFromAllMapConfig(e,t){let r=this.getAllMapConfig(t);Object.keys(r).forEach((o=>{let i=r[o].indexOf(e);i>-1&&(r[o].splice(i,1),this.setSyncRecord({type:"config",catergory:"mapConfig",name:t,key:o},{operation:"update",time:Date.now()}))})),this.setAllMapConfig(r,t)}static deleteMapConfig(e,t){let r=this.getAllMapConfig(t);delete r[e],this.setSyncRecord({type:"config",catergory:"mapConfig",name:t,key:e},{operation:"delete",time:Date.now()}),this.setAllMapConfig(r,t)}static getFromAllMapConfig(e,t){let r=this.getAllMapConfig(t),o=[];for(let t in r)r[t]&&r[t].indexOf(e)>-1&&o.push(t);return o}static getSyncRecord(e){return JSON.parse(this.getItem("syncRecord")||"{}")[e.type+"."+e.catergory+"."+e.name+"."+e.key]||{operation:"",time:0}}static getAllSyncRecord(){return JSON.parse(this.getItem("syncRecord")||"{}")}static setSyncRecord(e,t){let r=JSON.parse(this.getItem("syncRecord")||"{}");r[e.type+"."+e.catergory+"."+e.name+"."+e.key]=t,this.setItem("syncRecord",JSON.stringify(r))}static setAllSyncRecord(e){this.setItem("syncRecord",JSON.stringify(e))}});var ee,te;let re;const oe=new Uint8Array(16);function ie(){if(!re&&(re="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!re))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return re(oe)}const ne=[];for(let e=0;e<256;++e)ne.push((e+256).toString(16).slice(1));var se={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function ae(e,t,r){if(se.randomUUID&&!t&&!e)return se.randomUUID();const o=(e=e||{}).random||(e.rng||ie)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=o[e];return t}return function(e,t=0){return ne[e[t+0]]+ne[e[t+1]]+ne[e[t+2]]+ne[e[t+3]]+"-"+ne[e[t+4]]+ne[e[t+5]]+"-"+ne[e[t+6]]+ne[e[t+7]]+"-"+ne[e[t+8]]+ne[e[t+9]]+"-"+ne[e[t+10]]+ne[e[t+11]]+ne[e[t+12]]+ne[e[t+13]]+ne[e[t+14]]+ne[e[t+15]]}(o)}class ce{static saveAllToken(e){return s(this,void 0,void 0,(function*(){if(e)if(n){const{ipcRenderer:t}=window.require("electron");t.invoke("encrypt-data",{token:e})}else{const t=yield this.encryptString(e);localStorage.setItem("encryptedToken",t)}}))}static getAllToken(){return s(this,void 0,void 0,(function*(){if(n){const{ipcRenderer:e}=window.require("electron");return yield e.invoke("decrypt-data")}{let e=localStorage.getItem("encryptedToken")||"";return e?yield this.decryptString(e):null}}))}static setToken(e,t){return s(this,void 0,void 0,(function*(){const r=JSON.parse((yield this.getAllToken())||"{}");r[e]=t,yield this.saveAllToken(JSON.stringify(r))}))}static getToken(e){return s(this,void 0,void 0,(function*(){return JSON.parse((yield this.getAllToken())||"{}")[e]||null}))}static deleteToken(e){return s(this,void 0,void 0,(function*(){const t=JSON.parse((yield this.getAllToken())||"{}");delete t[e],yield this.saveAllToken(JSON.stringify(t))}))}static encryptString(e){return s(this,void 0,void 0,(function*(){try{let t=yield this.getFingerprint();const r=yield ue(t);return"undefined"!=typeof crypto&&crypto.subtle?yield function(e,t,r={alg:"HS256",typ:"JWT"}){return s(this,void 0,void 0,(function*(){const o=le((new TextEncoder).encode(JSON.stringify(r))),i=le((new TextEncoder).encode(JSON.stringify(e))),n=(new TextEncoder).encode(`${o}.${i}`),s=yield crypto.subtle.importKey("raw",(new TextEncoder).encode(t),{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]);return`${o}.${i}.${le(yield crypto.subtle.sign("HMAC",s,n))}`}))}(e,r):function(e,t){if(!e||!t)return"";const r=u((new TextEncoder).encode(t)),o=Array.from(new Uint8Array(r)),i=(new TextEncoder).encode(e),n=new Uint8Array(i.length);for(let e=0;e<i.length;e++)n[e]=i[e]^o[e%o.length];return d(n.buffer)}(e,r)}catch(e){return console.error("Error generating secret:",e),""}}))}static decryptString(e){return s(this,void 0,void 0,(function*(){try{let t=yield this.getFingerprint();const r=yield ue(t);return"undefined"!=typeof crypto&&crypto.subtle?yield function(e,t){return s(this,void 0,void 0,(function*(){const[r,o,i]=e.split("."),n=(new TextEncoder).encode(`${r}.${o}`),s=yield de(i),a=yield crypto.subtle.importKey("raw",(new TextEncoder).encode(t),{name:"HMAC",hash:{name:"SHA-256"}},!1,["verify"]);if(!(yield crypto.subtle.verify("HMAC",a,s,n)))throw new Error("Invalid signature");return JSON.parse((new TextDecoder).decode(de(o)))}))}(e,r):function(e,t){if(!e||!t)return"";try{const r=u((new TextEncoder).encode(t)),o=Array.from(new Uint8Array(r)),i=l(e),n=new Uint8Array(i),s=new Uint8Array(n.length);for(let e=0;e<n.length;e++)s[e]=n[e]^o[e%o.length];return(new TextDecoder).decode(s)}catch(e){return console.error("Decryption failed:",e),""}}(e,r)}catch(e){return console.error("Error generating secret:",e),""}}))}static getFingerprint(){return s(this,void 0,void 0,(function*(){if(n){const{ipcRenderer:e}=window.require("electron");return yield e.invoke("get-mac")}{let e=Z.getItem("fingerPrint");if(e)return e;let t=ae().replace(/-/g,"");return Z.setItem("fingerPrint",t),t}}))}}function le(e){return btoa(String.fromCharCode.apply(null,Array.from(new Uint8Array(e)))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function de(e){const t=e.replace(/-/g,"+").replace(/_/g,"/"),r=atob(t),o=new Uint8Array(r.length);for(let e=0;e<r.length;e++)o[e]=r.charCodeAt(e);return o}function ue(e){return s(this,void 0,void 0,(function*(){const t=(new TextEncoder).encode(e);return function(e){let t="";const r=new Uint8Array(e);for(let e=0;e<r.byteLength;e++)t+=String.fromCharCode(r[e]);return btoa(t)}(yield crypto.subtle.digest("SHA-256",t))}))}var he="1.13.7",pe="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||Function("return this")()||{},fe=Array.prototype,ge=Object.prototype,ye="undefined"!=typeof Symbol?Symbol.prototype:null,me=fe.push,ve=fe.slice,ke=ge.toString,be=ge.hasOwnProperty,we="undefined"!=typeof ArrayBuffer,Te="undefined"!=typeof DataView,Ee=Array.isArray,Ce=Object.keys,xe=Object.create,_e=we&&ArrayBuffer.isView,Se=isNaN,Re=isFinite,Oe=!{toString:null}.propertyIsEnumerable("toString"),Ae=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],Fe=Math.pow(2,53)-1;function Ie(e,t){return t=null==t?e.length-1:+t,function(){for(var r=Math.max(arguments.length-t,0),o=Array(r),i=0;i<r;i++)o[i]=arguments[i+t];switch(t){case 0:return e.call(this,o);case 1:return e.call(this,arguments[0],o);case 2:return e.call(this,arguments[0],arguments[1],o)}var n=Array(t+1);for(i=0;i<t;i++)n[i]=arguments[i];return n[t]=o,e.apply(this,n)}}function Le(e){var t=typeof e;return"function"===t||"object"===t&&!!e}function Me(e){return void 0===e}function je(e){return!0===e||!1===e||"[object Boolean]"===ke.call(e)}function Be(e){var t="[object "+e+"]";return function(e){return ke.call(e)===t}}var ze=Be("String"),De=Be("Number"),Pe=Be("Date"),$e=Be("RegExp"),Ue=Be("Error"),Ne=Be("Symbol"),qe=Be("ArrayBuffer"),We=Be("Function"),Je=pe.document&&pe.document.childNodes;"function"!=typeof/./&&"object"!=typeof Int8Array&&"function"!=typeof Je&&(We=function(e){return"function"==typeof e||!1});var Qe=We,Ke=Be("Object"),He=Te&&(!/\[native code\]/.test(String(DataView))||Ke(new DataView(new ArrayBuffer(8)))),Ve="undefined"!=typeof Map&&Ke(new Map),Xe=Be("DataView");var Ye=He?function(e){return null!=e&&Qe(e.getInt8)&&qe(e.buffer)}:Xe,Ge=Ee||Be("Array");function Ze(e,t){return null!=e&&be.call(e,t)}var et=Be("Arguments");!function(){et(arguments)||(et=function(e){return Ze(e,"callee")})}();var tt=et;function rt(e){return De(e)&&Se(e)}function ot(e){return function(){return e}}function it(e){return function(t){var r=e(t);return"number"==typeof r&&r>=0&&r<=Fe}}function nt(e){return function(t){return null==t?void 0:t[e]}}var st=nt("byteLength"),at=it(st),ct=/\[object ((I|Ui)nt(8|16|32)|Float(32|64)|Uint8Clamped|Big(I|Ui)nt64)Array\]/;var lt=we?function(e){return _e?_e(e)&&!Ye(e):at(e)&&ct.test(ke.call(e))}:ot(!1),dt=nt("length");function ut(e,t){t=function(e){for(var t={},r=e.length,o=0;o<r;++o)t[e[o]]=!0;return{contains:function(e){return!0===t[e]},push:function(r){return t[r]=!0,e.push(r)}}}(t);var r=Ae.length,o=e.constructor,i=Qe(o)&&o.prototype||ge,n="constructor";for(Ze(e,n)&&!t.contains(n)&&t.push(n);r--;)(n=Ae[r])in e&&e[n]!==i[n]&&!t.contains(n)&&t.push(n)}function ht(e){if(!Le(e))return[];if(Ce)return Ce(e);var t=[];for(var r in e)Ze(e,r)&&t.push(r);return Oe&&ut(e,t),t}function pt(e,t){var r=ht(t),o=r.length;if(null==e)return!o;for(var i=Object(e),n=0;n<o;n++){var s=r[n];if(t[s]!==i[s]||!(s in i))return!1}return!0}function ft(e){return e instanceof ft?e:this instanceof ft?void(this._wrapped=e):new ft(e)}function gt(e){return new Uint8Array(e.buffer||e,e.byteOffset||0,st(e))}ft.VERSION=he,ft.prototype.value=function(){return this._wrapped},ft.prototype.valueOf=ft.prototype.toJSON=ft.prototype.value,ft.prototype.toString=function(){return String(this._wrapped)};var yt="[object DataView]";function mt(e,t,r,o){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return!1;if(e!=e)return t!=t;var i=typeof e;return("function"===i||"object"===i||"object"==typeof t)&&vt(e,t,r,o)}function vt(e,t,r,o){e instanceof ft&&(e=e._wrapped),t instanceof ft&&(t=t._wrapped);var i=ke.call(e);if(i!==ke.call(t))return!1;if(He&&"[object Object]"==i&&Ye(e)){if(!Ye(t))return!1;i=yt}switch(i){case"[object RegExp]":case"[object String]":return""+e==""+t;case"[object Number]":return+e!=+e?+t!=+t:0==+e?1/+e==1/t:+e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object Symbol]":return ye.valueOf.call(e)===ye.valueOf.call(t);case"[object ArrayBuffer]":case yt:return vt(gt(e),gt(t),r,o)}var n="[object Array]"===i;if(!n&&lt(e)){if(st(e)!==st(t))return!1;if(e.buffer===t.buffer&&e.byteOffset===t.byteOffset)return!0;n=!0}if(!n){if("object"!=typeof e||"object"!=typeof t)return!1;var s=e.constructor,a=t.constructor;if(s!==a&&!(Qe(s)&&s instanceof s&&Qe(a)&&a instanceof a)&&"constructor"in e&&"constructor"in t)return!1}o=o||[];for(var c=(r=r||[]).length;c--;)if(r[c]===e)return o[c]===t;if(r.push(e),o.push(t),n){if((c=e.length)!==t.length)return!1;for(;c--;)if(!mt(e[c],t[c],r,o))return!1}else{var l,d=ht(e);if(c=d.length,ht(t).length!==c)return!1;for(;c--;)if(!Ze(t,l=d[c])||!mt(e[l],t[l],r,o))return!1}return r.pop(),o.pop(),!0}function kt(e){if(!Le(e))return[];var t=[];for(var r in e)t.push(r);return Oe&&ut(e,t),t}function bt(e){var t=dt(e);return function(r){if(null==r)return!1;var o=kt(r);if(dt(o))return!1;for(var i=0;i<t;i++)if(!Qe(r[e[i]]))return!1;return e!==xt||!Qe(r[wt])}}var wt="forEach",Tt=["clear","delete"],Et=["get","has","set"],Ct=Tt.concat(wt,Et),xt=Tt.concat(Et),_t=["add"].concat(Tt,wt,"has"),St=Ve?bt(Ct):Be("Map"),Rt=Ve?bt(xt):Be("WeakMap"),Ot=Ve?bt(_t):Be("Set"),At=Be("WeakSet");function Ft(e){for(var t=ht(e),r=t.length,o=Array(r),i=0;i<r;i++)o[i]=e[t[i]];return o}function It(e){for(var t={},r=ht(e),o=0,i=r.length;o<i;o++)t[e[r[o]]]=r[o];return t}function Lt(e){var t=[];for(var r in e)Qe(e[r])&&t.push(r);return t.sort()}function Mt(e,t){return function(r){var o=arguments.length;if(t&&(r=Object(r)),o<2||null==r)return r;for(var i=1;i<o;i++)for(var n=arguments[i],s=e(n),a=s.length,c=0;c<a;c++){var l=s[c];t&&void 0!==r[l]||(r[l]=n[l])}return r}}var jt=Mt(kt),Bt=Mt(ht),zt=Mt(kt,!0);function Dt(e){if(!Le(e))return{};if(xe)return xe(e);var t=function(){};t.prototype=e;var r=new t;return t.prototype=null,r}function Pt(e){return Ge(e)?e:[e]}function $t(e){return ft.toPath(e)}function Ut(e,t){for(var r=t.length,o=0;o<r;o++){if(null==e)return;e=e[t[o]]}return r?e:void 0}function Nt(e,t,r){var o=Ut(e,$t(t));return Me(o)?r:o}function qt(e){return e}function Wt(e){return e=Bt({},e),function(t){return pt(t,e)}}function Jt(e){return e=$t(e),function(t){return Ut(t,e)}}function Qt(e,t,r){if(void 0===t)return e;switch(null==r?3:r){case 1:return function(r){return e.call(t,r)};case 3:return function(r,o,i){return e.call(t,r,o,i)};case 4:return function(r,o,i,n){return e.call(t,r,o,i,n)}}return function(){return e.apply(t,arguments)}}function Kt(e,t,r){return null==e?qt:Qe(e)?Qt(e,t,r):Le(e)&&!Ge(e)?Wt(e):Jt(e)}function Ht(e,t){return Kt(e,t,1/0)}function Vt(e,t,r){return ft.iteratee!==Ht?ft.iteratee(e,t):Kt(e,t,r)}function Xt(){}function Yt(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))}ft.toPath=Pt,ft.iteratee=Ht;var Gt=Date.now||function(){return(new Date).getTime()};function Zt(e){var t=function(t){return e[t]},r="(?:"+ht(e).join("|")+")",o=RegExp(r),i=RegExp(r,"g");return function(e){return e=null==e?"":""+e,o.test(e)?e.replace(i,t):e}}var er={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},tr=Zt(er),rr=Zt(It(er)),or=ft.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},ir=/(.)^/,nr={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},sr=/\\|'|\r|\n|\u2028|\u2029/g;function ar(e){return"\\"+nr[e]}var cr=/^\s*(\w|\$)+\s*$/;var lr=0;function dr(e,t,r,o,i){if(!(o instanceof t))return e.apply(r,i);var n=Dt(e.prototype),s=e.apply(n,i);return Le(s)?s:n}var ur=Ie((function(e,t){var r=ur.placeholder,o=function(){for(var i=0,n=t.length,s=Array(n),a=0;a<n;a++)s[a]=t[a]===r?arguments[i++]:t[a];for(;i<arguments.length;)s.push(arguments[i++]);return dr(e,o,this,this,s)};return o}));ur.placeholder=ft;var hr=Ie((function(e,t,r){if(!Qe(e))throw new TypeError("Bind must be called on a function");var o=Ie((function(i){return dr(e,o,t,this,r.concat(i))}));return o})),pr=it(dt);function fr(e,t,r,o){if(o=o||[],t||0===t){if(t<=0)return o.concat(e)}else t=1/0;for(var i=o.length,n=0,s=dt(e);n<s;n++){var a=e[n];if(pr(a)&&(Ge(a)||tt(a)))if(t>1)fr(a,t-1,r,o),i=o.length;else for(var c=0,l=a.length;c<l;)o[i++]=a[c++];else r||(o[i++]=a)}return o}var gr=Ie((function(e,t){var r=(t=fr(t,!1,!1)).length;if(r<1)throw new Error("bindAll must be passed function names");for(;r--;){var o=t[r];e[o]=hr(e[o],e)}return e}));var yr=Ie((function(e,t,r){return setTimeout((function(){return e.apply(null,r)}),t)})),mr=ur(yr,ft,1);function vr(e){return function(){return!e.apply(this,arguments)}}function kr(e,t){var r;return function(){return--e>0&&(r=t.apply(this,arguments)),e<=1&&(t=null),r}}var br=ur(kr,2);function wr(e,t,r){t=Vt(t,r);for(var o,i=ht(e),n=0,s=i.length;n<s;n++)if(t(e[o=i[n]],o,e))return o}function Tr(e){return function(t,r,o){r=Vt(r,o);for(var i=dt(t),n=e>0?0:i-1;n>=0&&n<i;n+=e)if(r(t[n],n,t))return n;return-1}}var Er=Tr(1),Cr=Tr(-1);function xr(e,t,r,o){for(var i=(r=Vt(r,o,1))(t),n=0,s=dt(e);n<s;){var a=Math.floor((n+s)/2);r(e[a])<i?n=a+1:s=a}return n}function _r(e,t,r){return function(o,i,n){var s=0,a=dt(o);if("number"==typeof n)e>0?s=n>=0?n:Math.max(n+a,s):a=n>=0?Math.min(n+1,a):n+a+1;else if(r&&n&&a)return o[n=r(o,i)]===i?n:-1;if(i!=i)return(n=t(ve.call(o,s,a),rt))>=0?n+s:-1;for(n=e>0?s:a-1;n>=0&&n<a;n+=e)if(o[n]===i)return n;return-1}}var Sr=_r(1,Er,xr),Rr=_r(-1,Cr);function Or(e,t,r){var o=(pr(e)?Er:wr)(e,t,r);if(void 0!==o&&-1!==o)return e[o]}function Ar(e,t,r){var o,i;if(t=Qt(t,r),pr(e))for(o=0,i=e.length;o<i;o++)t(e[o],o,e);else{var n=ht(e);for(o=0,i=n.length;o<i;o++)t(e[n[o]],n[o],e)}return e}function Fr(e,t,r){t=Vt(t,r);for(var o=!pr(e)&&ht(e),i=(o||e).length,n=Array(i),s=0;s<i;s++){var a=o?o[s]:s;n[s]=t(e[a],a,e)}return n}function Ir(e){return function(t,r,o,i){var n=arguments.length>=3;return function(t,r,o,i){var n=!pr(t)&&ht(t),s=(n||t).length,a=e>0?0:s-1;for(i||(o=t[n?n[a]:a],a+=e);a>=0&&a<s;a+=e){var c=n?n[a]:a;o=r(o,t[c],c,t)}return o}(t,Qt(r,i,4),o,n)}}var Lr=Ir(1),Mr=Ir(-1);function jr(e,t,r){var o=[];return t=Vt(t,r),Ar(e,(function(e,r,i){t(e,r,i)&&o.push(e)})),o}function Br(e,t,r){t=Vt(t,r);for(var o=!pr(e)&&ht(e),i=(o||e).length,n=0;n<i;n++){var s=o?o[n]:n;if(!t(e[s],s,e))return!1}return!0}function zr(e,t,r){t=Vt(t,r);for(var o=!pr(e)&&ht(e),i=(o||e).length,n=0;n<i;n++){var s=o?o[n]:n;if(t(e[s],s,e))return!0}return!1}function Dr(e,t,r,o){return pr(e)||(e=Ft(e)),("number"!=typeof r||o)&&(r=0),Sr(e,t,r)>=0}var Pr=Ie((function(e,t,r){var o,i;return Qe(t)?i=t:(t=$t(t),o=t.slice(0,-1),t=t[t.length-1]),Fr(e,(function(e){var n=i;if(!n){if(o&&o.length&&(e=Ut(e,o)),null==e)return;n=e[t]}return null==n?n:n.apply(e,r)}))}));function $r(e,t){return Fr(e,Jt(t))}function Ur(e,t,r){var o,i,n=-1/0,s=-1/0;if(null==t||"number"==typeof t&&"object"!=typeof e[0]&&null!=e)for(var a=0,c=(e=pr(e)?e:Ft(e)).length;a<c;a++)null!=(o=e[a])&&o>n&&(n=o);else t=Vt(t,r),Ar(e,(function(e,r,o){((i=t(e,r,o))>s||i===-1/0&&n===-1/0)&&(n=e,s=i)}));return n}var Nr=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;function qr(e){return e?Ge(e)?ve.call(e):ze(e)?e.match(Nr):pr(e)?Fr(e,qt):Ft(e):[]}function Wr(e,t,r){if(null==t||r)return pr(e)||(e=Ft(e)),e[Yt(e.length-1)];var o=qr(e),i=dt(o);t=Math.max(Math.min(t,i),0);for(var n=i-1,s=0;s<t;s++){var a=Yt(s,n),c=o[s];o[s]=o[a],o[a]=c}return o.slice(0,t)}function Jr(e,t){return function(r,o,i){var n=t?[[],[]]:{};return o=Vt(o,i),Ar(r,(function(t,i){var s=o(t,i,r);e(n,t,s)})),n}}var Qr=Jr((function(e,t,r){Ze(e,r)?e[r].push(t):e[r]=[t]})),Kr=Jr((function(e,t,r){e[r]=t})),Hr=Jr((function(e,t,r){Ze(e,r)?e[r]++:e[r]=1})),Vr=Jr((function(e,t,r){e[r?0:1].push(t)}),!0);function Xr(e,t,r){return t in r}var Yr=Ie((function(e,t){var r={},o=t[0];if(null==e)return r;Qe(o)?(t.length>1&&(o=Qt(o,t[1])),t=kt(e)):(o=Xr,t=fr(t,!1,!1),e=Object(e));for(var i=0,n=t.length;i<n;i++){var s=t[i],a=e[s];o(a,s,e)&&(r[s]=a)}return r})),Gr=Ie((function(e,t){var r,o=t[0];return Qe(o)?(o=vr(o),t.length>1&&(r=t[1])):(t=Fr(fr(t,!1,!1),String),o=function(e,r){return!Dr(t,r)}),Yr(e,o,r)}));function Zr(e,t,r){return ve.call(e,0,Math.max(0,e.length-(null==t||r?1:t)))}function eo(e,t,r){return null==e||e.length<1?null==t||r?void 0:[]:null==t||r?e[0]:Zr(e,e.length-t)}function to(e,t,r){return ve.call(e,null==t||r?1:t)}var ro=Ie((function(e,t){return t=fr(t,!0,!0),jr(e,(function(e){return!Dr(t,e)}))})),oo=Ie((function(e,t){return ro(e,t)}));function io(e,t,r,o){je(t)||(o=r,r=t,t=!1),null!=r&&(r=Vt(r,o));for(var i=[],n=[],s=0,a=dt(e);s<a;s++){var c=e[s],l=r?r(c,s,e):c;t&&!r?(s&&n===l||i.push(c),n=l):r?Dr(n,l)||(n.push(l),i.push(c)):Dr(i,c)||i.push(c)}return i}var no=Ie((function(e){return io(fr(e,!0,!0))}));function so(e){for(var t=e&&Ur(e,dt).length||0,r=Array(t),o=0;o<t;o++)r[o]=$r(e,o);return r}var ao=Ie(so);function co(e,t){return e._chain?ft(t).chain():t}function lo(e){return Ar(Lt(e),(function(t){var r=ft[t]=e[t];ft.prototype[t]=function(){var e=[this._wrapped];return me.apply(e,arguments),co(this,r.apply(ft,e))}})),ft}Ar(["pop","push","reverse","shift","sort","splice","unshift"],(function(e){var t=fe[e];ft.prototype[e]=function(){var r=this._wrapped;return null!=r&&(t.apply(r,arguments),"shift"!==e&&"splice"!==e||0!==r.length||delete r[0]),co(this,r)}})),Ar(["concat","join","slice"],(function(e){var t=fe[e];ft.prototype[e]=function(){var e=this._wrapped;return null!=e&&(e=t.apply(e,arguments)),co(this,e)}}));var uo=Object.freeze({__proto__:null,VERSION:he,restArguments:Ie,isObject:Le,isNull:function(e){return null===e},isUndefined:Me,isBoolean:je,isElement:function(e){return!(!e||1!==e.nodeType)},isString:ze,isNumber:De,isDate:Pe,isRegExp:$e,isError:Ue,isSymbol:Ne,isArrayBuffer:qe,isDataView:Ye,isArray:Ge,isFunction:Qe,isArguments:tt,isFinite:function(e){return!Ne(e)&&Re(e)&&!isNaN(parseFloat(e))},isNaN:rt,isTypedArray:lt,isEmpty:function(e){if(null==e)return!0;var t=dt(e);return"number"==typeof t&&(Ge(e)||ze(e)||tt(e))?0===t:0===dt(ht(e))},isMatch:pt,isEqual:function(e,t){return mt(e,t)},isMap:St,isWeakMap:Rt,isSet:Ot,isWeakSet:At,keys:ht,allKeys:kt,values:Ft,pairs:function(e){for(var t=ht(e),r=t.length,o=Array(r),i=0;i<r;i++)o[i]=[t[i],e[t[i]]];return o},invert:It,functions:Lt,methods:Lt,extend:jt,extendOwn:Bt,assign:Bt,defaults:zt,create:function(e,t){var r=Dt(e);return t&&Bt(r,t),r},clone:function(e){return Le(e)?Ge(e)?e.slice():jt({},e):e},tap:function(e,t){return t(e),e},get:Nt,has:function(e,t){for(var r=(t=$t(t)).length,o=0;o<r;o++){var i=t[o];if(!Ze(e,i))return!1;e=e[i]}return!!r},mapObject:function(e,t,r){t=Vt(t,r);for(var o=ht(e),i=o.length,n={},s=0;s<i;s++){var a=o[s];n[a]=t(e[a],a,e)}return n},identity:qt,constant:ot,noop:Xt,toPath:Pt,property:Jt,propertyOf:function(e){return null==e?Xt:function(t){return Nt(e,t)}},matcher:Wt,matches:Wt,times:function(e,t,r){var o=Array(Math.max(0,e));t=Qt(t,r,1);for(var i=0;i<e;i++)o[i]=t(i);return o},random:Yt,now:Gt,escape:tr,unescape:rr,templateSettings:or,template:function(e,t,r){!t&&r&&(t=r),t=zt({},t,ft.templateSettings);var o=RegExp([(t.escape||ir).source,(t.interpolate||ir).source,(t.evaluate||ir).source].join("|")+"|$","g"),i=0,n="__p+='";e.replace(o,(function(t,r,o,s,a){return n+=e.slice(i,a).replace(sr,ar),i=a+t.length,r?n+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'":o?n+="'+\n((__t=("+o+"))==null?'':__t)+\n'":s&&(n+="';\n"+s+"\n__p+='"),t})),n+="';\n";var s,a=t.variable;if(a){if(!cr.test(a))throw new Error("variable is not a bare identifier: "+a)}else n="with(obj||{}){\n"+n+"}\n",a="obj";n="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+n+"return __p;\n";try{s=new Function(a,"_",n)}catch(e){throw e.source=n,e}var c=function(e){return s.call(this,e,ft)};return c.source="function("+a+"){\n"+n+"}",c},result:function(e,t,r){var o=(t=$t(t)).length;if(!o)return Qe(r)?r.call(e):r;for(var i=0;i<o;i++){var n=null==e?void 0:e[t[i]];void 0===n&&(n=r,i=o),e=Qe(n)?n.call(e):n}return e},uniqueId:function(e){var t=++lr+"";return e?e+t:t},chain:function(e){var t=ft(e);return t._chain=!0,t},iteratee:Ht,partial:ur,bind:hr,bindAll:gr,memoize:function(e,t){var r=function(o){var i=r.cache,n=""+(t?t.apply(this,arguments):o);return Ze(i,n)||(i[n]=e.apply(this,arguments)),i[n]};return r.cache={},r},delay:yr,defer:mr,throttle:function(e,t,r){var o,i,n,s,a=0;r||(r={});var c=function(){a=!1===r.leading?0:Gt(),o=null,s=e.apply(i,n),o||(i=n=null)},l=function(){var l=Gt();a||!1!==r.leading||(a=l);var d=t-(l-a);return i=this,n=arguments,d<=0||d>t?(o&&(clearTimeout(o),o=null),a=l,s=e.apply(i,n),o||(i=n=null)):o||!1===r.trailing||(o=setTimeout(c,d)),s};return l.cancel=function(){clearTimeout(o),a=0,o=i=n=null},l},debounce:function(e,t,r){var o,i,n,s,a,c=function(){var l=Gt()-i;t>l?o=setTimeout(c,t-l):(o=null,r||(s=e.apply(a,n)),o||(n=a=null))},l=Ie((function(l){return a=this,n=l,i=Gt(),o||(o=setTimeout(c,t),r&&(s=e.apply(a,n))),s}));return l.cancel=function(){clearTimeout(o),o=n=a=null},l},wrap:function(e,t){return ur(t,e)},negate:vr,compose:function(){var e=arguments,t=e.length-1;return function(){for(var r=t,o=e[t].apply(this,arguments);r--;)o=e[r].call(this,o);return o}},after:function(e,t){return function(){if(--e<1)return t.apply(this,arguments)}},before:kr,once:br,findKey:wr,findIndex:Er,findLastIndex:Cr,sortedIndex:xr,indexOf:Sr,lastIndexOf:Rr,find:Or,detect:Or,findWhere:function(e,t){return Or(e,Wt(t))},each:Ar,forEach:Ar,map:Fr,collect:Fr,reduce:Lr,foldl:Lr,inject:Lr,reduceRight:Mr,foldr:Mr,filter:jr,select:jr,reject:function(e,t,r){return jr(e,vr(Vt(t)),r)},every:Br,all:Br,some:zr,any:zr,contains:Dr,includes:Dr,include:Dr,invoke:Pr,pluck:$r,where:function(e,t){return jr(e,Wt(t))},max:Ur,min:function(e,t,r){var o,i,n=1/0,s=1/0;if(null==t||"number"==typeof t&&"object"!=typeof e[0]&&null!=e)for(var a=0,c=(e=pr(e)?e:Ft(e)).length;a<c;a++)null!=(o=e[a])&&o<n&&(n=o);else t=Vt(t,r),Ar(e,(function(e,r,o){((i=t(e,r,o))<s||i===1/0&&n===1/0)&&(n=e,s=i)}));return n},shuffle:function(e){return Wr(e,1/0)},sample:Wr,sortBy:function(e,t,r){var o=0;return t=Vt(t,r),$r(Fr(e,(function(e,r,i){return{value:e,index:o++,criteria:t(e,r,i)}})).sort((function(e,t){var r=e.criteria,o=t.criteria;if(r!==o){if(r>o||void 0===r)return 1;if(r<o||void 0===o)return-1}return e.index-t.index})),"value")},groupBy:Qr,indexBy:Kr,countBy:Hr,partition:Vr,toArray:qr,size:function(e){return null==e?0:pr(e)?e.length:ht(e).length},pick:Yr,omit:Gr,first:eo,head:eo,take:eo,initial:Zr,last:function(e,t,r){return null==e||e.length<1?null==t||r?void 0:[]:null==t||r?e[e.length-1]:to(e,Math.max(0,e.length-t))},rest:to,tail:to,drop:to,compact:function(e){return jr(e,Boolean)},flatten:function(e,t){return fr(e,t,!1)},without:oo,uniq:io,unique:io,union:no,intersection:function(e){for(var t=[],r=arguments.length,o=0,i=dt(e);o<i;o++){var n=e[o];if(!Dr(t,n)){var s;for(s=1;s<r&&Dr(arguments[s],n);s++);s===r&&t.push(n)}}return t},difference:ro,unzip:so,transpose:so,zip:ao,object:function(e,t){for(var r={},o=0,i=dt(e);o<i;o++)t?r[e[o]]=t[o]:r[e[o][0]]=e[o][1];return r},range:function(e,t,r){null==t&&(t=e||0,e=0),r||(r=t<e?-1:1);for(var o=Math.max(Math.ceil((t-e)/r),0),i=Array(o),n=0;n<o;n++,e+=r)i[n]=e;return i},chunk:function(e,t){if(null==t||t<1)return[];for(var r=[],o=0,i=e.length;o<i;)r.push(ve.call(e,o,o+=t));return r},mixin:lo,default:ft}),ho=lo(uo);ho._=ho;const po=e=>e.map((e=>e.name)),fo=e=>e.map((e=>e.key)),go=(e,t)=>{let r=[];for(let o=0;o<e.length;o++)t.indexOf(e[o])>-1&&r.push(t.indexOf(e[o]));return r.length<t.length&&t.forEach((o=>{if(-1===e.indexOf(o))for(let e=0;e<t.length;e++)if(-1===r.indexOf(e)){r.push(e);break}})),[...new Set(r.map((e=>e-Math.min(...r))))]};class yo{static sortBooks(e,t,r){let o=e.map((e=>e.key)),i=(e=>e.getAllListConfig("recentBooks"))(r);if(1===t.sort||0===t.sort)return 1===t.order?go(i,o).reverse():go(i,o);if(2===t.sort){let r=po(e),o=po(e).sort();return 1===t.order?go(o,r).reverse():go(o,r)}if(3===t.sort){let r=[];for(let t=0;t<e.length;t++)r.push(t);return 1===t.order?r.reverse():r}if(4===t.sort){let o=(e=>{let t=e.getAllObjectConfig("readingTime");var r=[];for(let e in t)r.push([e,t[e]]);return r.sort((function(e,t){return e[1]-t[1]})),Object.keys(t)})(r),i=fo(e);return 1===t.order?go(ho.union(o,i),i).reverse():go(ho.union(o,i),i)}if(5===t.sort){let r=fo(e),o=(e=>ho.sortBy(e.map((e=>({key:e.key,author:e.author}))),"author").map((e=>e.key)))(e);return 1===t.order?go(o,r).reverse():go(o,r)}if(6===t.sort){let o=(e=>{let t=e.getAllObjectConfig("recordLocation");var r=[];for(let e in t)r.push([e,t[e].percentage||0]);return r.sort((function(e,t){return e[1]-t[1]})),r.map((e=>e[0]))})(r),i=fo(e);return 1===t.order?go(o,i).reverse():go(o,i)}}static sortNotes(e,t,r=[]){if(3===t.sort){let r=ho.clone(e).reverse(),o=ho.uniq(e.map((e=>({chapter:e.chapter,chapterIndex:e.chapterIndex}))));o=1===t.order?ho.sortBy(o,"chapterIndex"):ho.sortBy(o,"chapterIndex").reverse();let i=ho.uniq(o.map((e=>e.chapter))),n={};return i.forEach((e=>{n[e]=[]})),r.forEach((e=>{n[e.chapter].push(e)})),i.map((e=>({group:e,notes:n[e]})))||[]}if(2===t.sort){let r=ho.clone(e).reverse(),o=ho.uniq(e.map((e=>e.date.year+"-"+e.date.month+"-"+e.date.day)));1===t.order?o.sort():o.sort().reverse();let i={};return o.forEach((e=>{i[e]=[]})),r.forEach((e=>{o.forEach((t=>{t===e.date.year+"-"+e.date.month+"-"+e.date.day&&i[t].push(e)}))})),i||{}}if(1===t.sort){let o=ho.clone(e).reverse(),i=ho.uniq(e.map((e=>{let t=ho.findLastIndex(r,{key:e.bookKey});return t>-1?r[t].name:""})));1===t.order?i.sort():i.sort().reverse();let n={};return i.forEach((e=>{n[e]=[]})),o.forEach((e=>{i.forEach((t=>{let o=ho.findLastIndex(r,{key:e.bookKey});o>-1&&t===r[o].name&&n[t].push(e)}))})),n||{}}}static sortBookmarks(e,t){if(3===t.sort){let r=ho.clone(e).reverse(),o=ho.uniq(e.map((e=>({chapter:e.chapter,chapterIndex:parseInt(JSON.parse(e.cfi).chapterDocIndex)}))));o=1===t.order?ho.sortBy(o,"chapterIndex"):ho.sortBy(o,"chapterIndex").reverse();let i=ho.uniq(o.map((e=>e.chapter))),n={};return i.forEach((e=>{n[e]=[]})),r.forEach((e=>{n[e.chapter].push(e)})),i.map((e=>({group:e,bookmarks:n[e]})))||[]}}}class mo{static getDefaultCss(e){return`::selection{background:#f3a6a68c}::-moz-selection{background:#f3a6a68c}.kookit-note:hover{cursor:pointer;}img{max-width:100% !important}body,html{margin: 0px !important; padding: 0px !important;}.kookit-text{${this.getCustomCss(e)}}.kookit-title{${this.getCustomCss(e,!0)}}code,pre{white-space: pre-wrap;}p{margin-block: 0;margin-inline: 0;}${"yes"===e.getReaderConfig("isOverwriteLink")?"a{color: #0066cc !important; text-decoration: underline !important; cursor: pointer !important;}a:hover{color: #004080 !important;}a:visited{color: #6600cc !important;}":""}${"yes"===e.getReaderConfig("isMergeWord")?`h1{font-size: ${e.getReaderConfig("fontSize")||18}px !important;}`:""}`}static getCustomCss(e,t=!1){return`font-size: ${t?"":e.getReaderConfig("fontSize")?e.getReaderConfig("fontSize"):"18"}px !important;line-height: ${e.getReaderConfig("lineHeight")||"1.25"} !important;font-family: ${e.getReaderConfig("fontFamily")||""} !important;background-color: transparent;color: ${e.getReaderConfig("textColor")?e.getReaderConfig("textColor"):"rgba(44,47,49,1)"===e.getReaderConfig("backgroundColor")||"night"===e.getReaderConfig("appSkin")||"system"===e.getReaderConfig("appSkin")&&"yes"===e.getReaderConfig("isOSNight")?"white":""} !important;letter-spacing: ${e.getReaderConfig("letterSpacing")}px !important;text-align: ${e.getReaderConfig("textAlign")?e.getReaderConfig("textAlign"):""} !important;font-weight: ${"yes"===e.getReaderConfig("isBold")?"bold !important":""};font-style: ${"yes"===e.getReaderConfig("isItalic")?"italic !important":""};text-shadow: ${"yes"===e.getReaderConfig("isShadow")?"2px 2px 2px #cccccc !important":""};text-indent: ${"yes"===e.getReaderConfig("isIndent")?"2rem":""};text-decoration: ${"yes"===e.getReaderConfig("isUnderline")?"underline !important":""};margin-bottom: ${e.getReaderConfig("paraSpacing")||0}px !important;padding:0px !important;word-wrap: break-word !important; writing-mode: horizontal-tb !important; `}}class vo{static mergeArray(e,t){var r=[];for(let t of e)r.push(t);for(let i of t){var o=!0;for(let t of e)if(i===t){o=!1;break}o&&r.push(i)}return r}static fuzzyQuery(e,t){for(var r=[],o=0;o<e.length;o++)e[o].indexOf(t.trim())>-1&&r.push(o);return r}static mouseSearch(e){let t=document.querySelector(".header-search-box").value.toLowerCase(),r=[],o=[];if(!e)return[];e.forEach((e=>{r.push(e.name.toLowerCase()),o.push(e.author.toLowerCase())}));let i=this.fuzzyQuery(r,t),n=this.fuzzyQuery(o,t);return this.mergeArray(i,n)}static keywordSearch(e,t){let r=[],o=[];if(!t)return[];t.forEach((e=>{r.push(e.name.toLowerCase()),o.push(e.author.toLowerCase())}));let i=this.fuzzyQuery(r,e),n=this.fuzzyQuery(o,e);return this.mergeArray(i,n)}static keySearch(e,t){if(e&&13===e.keyCode){let r=[],o=[];if(!t)return[];t.forEach((e=>{r.push(e.name.toLowerCase()),o.push(e.author.toLowerCase())}));let i=this.fuzzyQuery(r,e.target.value.toLowerCase()),n=this.fuzzyQuery(o,e.target.value.toLowerCase());return this.mergeArray(i,n)}}static mouseNoteSearch(e){let t=document.querySelector(".header-search-box").value.toLowerCase(),r=[],o=[];e.forEach((e=>{r.push(e.notes.toLowerCase()),o.push(e.text.toLowerCase())}));let i=this.fuzzyQuery(r,t),n=this.fuzzyQuery(o,t);return this.mergeArray(i,n)}static keyNoteSearch(e,t){if(e&&13===e.keyCode){let r=[],o=[];t.forEach((e=>{r.push(e.notes.toLowerCase()),o.push(e.text.toLowerCase())}));let i=this.fuzzyQuery(r,e.target.value.toLowerCase()),n=this.fuzzyQuery(o,e.target.value.toLowerCase());return this.mergeArray(i,n)}}}export{J as BookHelper,p as CommonTool,Z as ConfigService,y as KookitConfig,Y as LoginHelper,H as ReaderRequest,vo as SearchUtil,yo as SortUtil,q as SqlStatement,mo as StyleHelper,G as SyncHelper,B as SyncUtil,V as ThirdpartyRequest,ce as TokenService,X as UserRequest};
