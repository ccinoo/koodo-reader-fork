import e from"axios";import{Storage as t}from"megajs";import{Buffer as r}from"buffer";import{createClient as o,AuthType as i}from"webdav/dist/web/index.js";import{isElectron as n}from"react-device-detect";function s(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{c(o.next(e))}catch(e){n(e)}}function a(e){try{c(o.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))}const a={publicUrl:"https://api.960960.xyz",cloudUrl:"https://cloud.960960.xyz",devUrl:"http://192.168.28.159:8000"},c={callbackUrl:"https://web.koodoreader.com/",dropboxClientId:"vnc67byrssocvy1",pcloudClientId:"pg8ten0B3vH",boxClientId:"ltimecqanmpxoaicn9qw3es6l3sdl1ya",microsoftClientId:"506df58a-29ab-4020-afc5-6f423dc80f35",googleClientId:"1051055003225-ph1f5fvh328dhv7bco5jitlnfhg6ks2t.apps.googleusercontent.com",facebookClientId:"2845583825559500",githubClientId:"Ov23liJVzfvJMMEEZ8v2",adriveClientId:"a128ae7b9c094545af623de61dc0a1ef"};var l={CloudConfig:a,ThirdpartyConfig:c,LoginAuthRequest:{google:{clientId:c.googleClientId,scopes:["openid"],usePKCE:!1,responseType:"code",redirectUri:c.callbackUrl,extraParams:{prompt:"consent",scope:"openid"}},microsoft:{clientId:c.microsoftClientId,scopes:["openid","profile","User.Read","offline_access"],usePKCE:!1,responseType:"code",redirectUri:c.callbackUrl,extraParams:{scope:"openid profile User.Read offline_access"}},facebook:{clientId:c.facebookClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:c.callbackUrl,extraParams:{scope:""}},github:{clientId:c.githubClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:c.callbackUrl,extraParams:{scope:""}}},LoginDiscovery:{microsoft:{authorizationEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/authorize",tokenEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/token"},google:{authorizationEndpoint:"https://accounts.google.com/o/oauth2/v2/auth",tokenEndpoint:"https://oauth2.googleapis.com/token"},facebook:{authorizationEndpoint:"https://www.facebook.com/v12.0/dialog/oauth",tokenEndpoint:"https://graph.facebook.com/v12.0/oauth/access_token"},github:{authorizationEndpoint:"https://github.com/login/oauth/authorize",tokenEndpoint:"https://github.com/login/oauth/access_token"}},DriveAuthRequest:{dropbox:{clientId:c.dropboxClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:c.callbackUrl,extraParams:{token_access_type:"offline"}},boxnet:{clientId:c.boxClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:c.callbackUrl,extraParams:{grant_type:"authorization_code",box_subject_type:"enterprise",scope:"root_readwrite"}},pcloud:{clientId:c.pcloudClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:c.callbackUrl,extraParams:{grant_type:"authorization_code"}},adrive:{clientId:c.adriveClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:c.callbackUrl,extraParams:{grant_type:"authorization_code",scope:"user:base,file:all:write,file:all:read"}},microsoft:{clientId:c.microsoftClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:c.callbackUrl,extraParams:{scope:"files.readwrite.appfolder offline_access"}},google:{clientId:c.googleClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:c.callbackUrl,extraParams:{prompt:"consent",scope:"https://www.googleapis.com/auth/drive.appdata",access_type:"offline"}}},DriveDiscovery:{dropbox:{authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",tokenEndpoint:"https://www.dropbox.com/oauth2/token"},boxnet:{authorizationEndpoint:"https://account.box.com/api/oauth2/authorize",tokenEndpoint:"https://api.box.com/oauth2/token"},pcloud:{authorizationEndpoint:"https://my.pcloud.com/oauth2/authorize",tokenEndpoint:"https://api.pcloud.com/oauth2_token"},adrive:{authorizationEndpoint:"https://openapi.alipan.com/oauth/authorize",tokenEndpoint:"https://openapi.alipan.com/oauth/token"},microsoft:{authorizationEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/authorize",tokenEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/token"},google:{authorizationEndpoint:"https://accounts.google.com/o/oauth2/v2/auth",tokenEndpoint:"https://oauth2.googleapis.com/token"}}};class d{constructor(e){this.queue=[],this.runningTasks=0,this.maxConcurrency=e}addTask(e){return s(this,void 0,void 0,(function*(){return new Promise(((t,r)=>{const o=()=>s(this,void 0,void 0,(function*(){try{this.runningTasks++;const r=yield e();return t(r),r}catch(e){throw r(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?o():this.queue.push(o)}))}))}runNext(){if(this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}}class u{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.driveId="",this.refreshTokenPromise=null,this.taskQueue=new d(1)}retryOperation(e,t=5){return s(this,void 0,void 0,(function*(){let r=0;for(;;){const o=yield e();if(o)return o;if(r>=t)return o;r++;const i=1e3*Math.pow(2,r);console.info(`Retry attempt ${r} after ${i}ms`),yield new Promise((e=>setTimeout(e,i)))}}))}getDriveId(){return s(this,void 0,void 0,(function*(){if(this.driveId)return this.driveId;const t=yield this.refreshToken(),r=yield e.post("https://openapi.alipan.com/adrive/v1.0/user/getDriveInfo",{},{headers:{Authorization:`Bearer ${t}`}});return this.driveId=r.data.default_drive_id,this.driveId}))}getFolderIdByPath(t){return s(this,void 0,void 0,(function*(){const r=yield this.refreshToken(),o=yield this.getDriveId();try{try{const i=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:o,file_path:t},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});if(i.data)return i.data.file_id}catch(i){const n=t.split("/").filter((e=>e));let s="",a="root";for(const t of n){s+="/"+t;try{a=(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:o,file_path:s},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})).data.file_id}catch(i){a=(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/create",{drive_id:o,parent_file_id:a,name:t,type:"folder",check_name_mode:"refuse"},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})).data.file_id}}return a}}catch(e){return console.error("Error getting/creating folder by path:",e),""}}))}listFiles(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield this.getDriveId(),i=yield this.getFolderIdByPath("/KoodoReader/"+t);return(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/list",{drive_id:o,parent_file_id:i},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})).data.items.map((e=>e.name))}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield this.getDriveId(),i=yield this.getFolderIdByPath("/KoodoReader/"+t);return!i||(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/delete",{drive_id:o,file_id:i},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}}),!0)}catch(e){return console.error("Error deleting file:",e),!1}}))}checkExists(t){var r;return s(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),i=yield this.getDriveId(),n=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:i,file_path:t},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});(null===(r=n.data)||void 0===r?void 0:r.file_id)&&(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/recyclebin/trash",{drive_id:i,file_id:n.data.file_id},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}}))}catch(e){}}))}refreshToken(){return s(this,void 0,void 0,(function*(){return this.config.access_token&&this.config.expires_at>(new Date).getTime()?this.config.access_token:(this.refreshTokenPromise||(this.refreshTokenPromise=(()=>s(this,void 0,void 0,(function*(){try{let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"adrive",refresh_token:e});this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,this.config.refresh_token=t.data.refresh_token;let r=yield this.thirdpartyRequest.encryptToken({token:JSON.stringify({refresh_token:t.data.refresh_token})});return 200===r.code&&(yield this.thirdpartyRequest.TokenService.setToken("adrive_token",r.data.encrypted_token)),t.data.access_token}finally{this.refreshTokenPromise=null}})))()),this.refreshTokenPromise)}))}authToken(e){return s(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"adrive",redirect_uri:c.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://openapi.alipan.com/oauth/authorize?${new URLSearchParams({response_type:"code",client_id:c.adriveClientId,redirect_uri:c.callbackUrl,grant_type:"authorization_code",scope:"user:base,file:all:write,file:all:read"}).toString()}`}}class h extends u{constructor(e,t){super(e,t)}uploadFile(t,r){return s(this,void 0,void 0,(function*(){return new Promise(((o,i)=>s(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken(),n=yield this.getDriveId(),s=r.substring(0,r.lastIndexOf("/")),a=r.substring(r.lastIndexOf("/")+1),c=yield this.getFolderIdByPath("/KoodoReader/"+s),l=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/create",{drive_id:n,parent_file_id:c,name:a,type:"file",check_name_mode:"ignore"},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}}),{file_id:d,upload_id:u,part_info_list:h}=l.data;yield e.put(h[0].upload_url,t,{headers:{"Content-Type":"application/octet-stream"}}),yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/complete",{drive_id:n,file_id:d,upload_id:u},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}}),o(!0)}catch(e){console.error("Error uploading file:",e),o(!1)}}))))}))}downloadFile(t){return new Promise(((r,o)=>s(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),i=yield this.getDriveId(),n=(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:i,file_path:"/KoodoReader/"+t},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}})).data.file_id,s=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/getDownloadUrl",{drive_id:i,file_id:n},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}}),a=yield e.get(s.data.url,{responseType:"arraybuffer"});r(a.data)}catch(e){console.error("Error downloading file:",e),r(!1)}}))))}}class p{constructor(e){this.queue=[],this.runningTasks=0,this.maxConcurrency=e}addTask(e){return s(this,void 0,void 0,(function*(){return new Promise(((t,r)=>{const o=()=>s(this,void 0,void 0,(function*(){try{this.runningTasks++;const r=yield e();return t(r),r}catch(e){throw r(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?o():this.queue.push(o)}))}))}runNext(){if(this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}}class f{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.refreshTokenPromise=null,this.taskQueue=new p(3)}retryOperation(e,t=3){return s(this,void 0,void 0,(function*(){let r=0;for(;;){const o=yield e();if(o)return o;if(r>=t)return o;r++;const i=1e3*Math.pow(2,r);console.info(`Retry attempt ${r} after ${i}ms`),yield new Promise((e=>setTimeout(e,i)))}}))}getFolderIdByPath(t){return s(this,void 0,void 0,(function*(){const r=yield this.refreshToken(),o=t.split("/");let i="0";for(const t of o){const o=`https://api.box.com/2.0/folders/${i}/items?fields=id,name&type=folder&limit=1000`;try{const n=(yield e.get(o,{headers:{Authorization:`Bearer ${r}`}})).data.entries.find((e=>e.name===t&&"folder"===e.type));if(n)i=n.id;else{const o={name:t,parent:{id:i},type:"folder"};i=(yield e.post("https://api.box.com/2.0/folders",o,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})).data.id}}catch(e){return console.error("Error occurred during folder creation:",e),""}}return i}))}listFiles(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken();let o=yield this.getFolderIdByPath("KoodoReader/"+t);return(yield e.get(`https://api.box.com/2.0/folders/${o}/items`,{headers:{Authorization:`Bearer ${r}`}})).data.entries.map((e=>e.name))}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=t.substring(0,t.lastIndexOf("/")),i=t.substring(t.lastIndexOf("/")+1),n=yield this.getFolderIdByPath("KoodoReader/"+o);if(!n)return!0;const s=`https://api.box.com/2.0/folders/${n}/items?fields=id,name&type=file&limit=1000`,a=(yield e.get(s,{headers:{Authorization:`Bearer ${r}`}})).data.entries.find((e=>e.name===i&&"file"===e.type));return!a||(yield e.delete(`https://api.box.com/2.0/files/${a.id}`,{headers:{Authorization:`Bearer ${r}`}}),!0)}catch(e){return console.error("Error deleting file:",e),!1}}))}refreshToken(){return s(this,void 0,void 0,(function*(){return this.config.access_token&&this.config.expires_at>(new Date).getTime()?this.config.access_token:(this.refreshTokenPromise||(this.refreshTokenPromise=(()=>s(this,void 0,void 0,(function*(){try{let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"boxnet",refresh_token:e});this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,this.config.refresh_token=t.data.refresh_token;let r=yield this.thirdpartyRequest.encryptToken({token:JSON.stringify({refresh_token:t.data.refresh_token})});return 200===r.code&&(yield this.thirdpartyRequest.TokenService.setToken("boxnet_token",r.data.encrypted_token)),t.data.access_token}finally{this.refreshTokenPromise=null}})))()),this.refreshTokenPromise)}))}authToken(e){return s(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"boxnet",redirect_uri:c.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://account.box.com/api/oauth2/authorize?${new URLSearchParams({response_type:"code",client_id:c.boxClientId,redirect_uri:c.callbackUrl,grant_type:"authorization_code",box_subject_type:"enterprise",scope:"root_readwrite"}).toString()}`}}class y extends f{constructor(e,t){super(e,t)}uploadFile(t,r){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),i=r.substring(0,r.lastIndexOf("/")),n=r.substring(r.lastIndexOf("/")+1),s=yield this.getFolderIdByPath("KoodoReader/"+i);if(!s)throw new Error("Folder not found");const a=(yield this.listFiles(i)).find((e=>e===n));a&&(yield this.deleteFileWithoutQueue(i+"/"+n));let c=new File([t],n,{lastModified:(new Date).getTime(),type:t.type});const l=new FormData;l.append("file",c),l.append("parent_id",s);const d=yield e.post("https://upload.box.com/api/2.0/files/content",l,{headers:{Authorization:`Bearer ${o}`,"Content-Type":"multipart/form-data"},params:{if_match:"false",fields:"name,id"},maxContentLength:1/0,maxBodyLength:1/0});return!(d.status>=300)||(console.error("Error occurred during file upload:",d),!1)}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(t){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=t.substring(0,t.lastIndexOf("/")),i=t.substring(t.lastIndexOf("/")+1),n=yield this.getFolderIdByPath("KoodoReader/"+o);if(!n)throw new Error("Folder not found");const s=`https://api.box.com/2.0/folders/${n}/items?fields=id,name&type=file&limit=1000`,a=(yield e.get(s,{headers:{Authorization:`Bearer ${r}`}})).data.entries.find((e=>e.name===i&&"file"===e.type));if(!a)return console.error("File not found:",i),!1;const c=yield e({url:`https://api.box.com/2.0/files/${a.id}/content`,method:"get",headers:{Authorization:`Bearer ${r}`},responseType:"arraybuffer"});return c.status>=300?(console.error("Error occurred during file download:",c),!1):c.data}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class g{constructor(e){this.queue=[],this.runningTasks=0,this.maxConcurrency=e}addTask(e){return s(this,void 0,void 0,(function*(){return new Promise(((t,r)=>{const o=()=>s(this,void 0,void 0,(function*(){try{this.runningTasks++;const r=yield e();return t(r),r}catch(e){throw r(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?o():this.queue.push(o)}))}))}runNext(){if(this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}}class m{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.refreshTokenPromise=null,this.taskQueue=new g(3)}retryOperation(e,t=3){return s(this,void 0,void 0,(function*(){let r=0;for(;;){const o=yield e();if(o)return o;if(r>=t)return o;r++;const i=1e3*Math.pow(2,r);console.info(`Retry attempt ${r} after ${i}ms`),yield new Promise((e=>setTimeout(e,i)))}}))}listFiles(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken();return(yield e.post("https://api.dropboxapi.com/2/files/list_folder",{path:"/"+t},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})).data.entries.map((e=>e.name))}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken();yield e.post("https://api.dropboxapi.com/2/files/delete_v2",{path:"/"+t},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});return!0}catch(e){return console.error("Error deleting file:",e),!1}}))}refreshToken(){return s(this,void 0,void 0,(function*(){return this.config.access_token&&this.config.expires_at>(new Date).getTime()?this.config.access_token:(this.refreshTokenPromise||(this.refreshTokenPromise=(()=>s(this,void 0,void 0,(function*(){try{let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"dropbox",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}finally{this.refreshTokenPromise=null}})))()),this.refreshTokenPromise)}))}authToken(e){return s(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"dropbox",redirect_uri:c.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://www.dropbox.com/oauth2/authorize?response_type=code&token_access_type=offline&client_id=${c.dropboxClientId}&redirect_uri=${c.callbackUrl}`}}class v extends m{constructor(e,t){super(e,t)}uploadFile(t,r){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken();let i=r.split("/").pop()||"",n=new File([t],i,{lastModified:(new Date).getTime(),type:t.type});const s=yield e.post("https://content.dropboxapi.com/2/files/upload",n,{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/octet-stream","Dropbox-API-Arg":JSON.stringify({path:"/"+r,mode:"overwrite",autorename:!0,mute:!1})},maxContentLength:1/0,maxBodyLength:1/0});return!(s.status>=300)||(console.error("Error occurred during file upload:",s),!1)}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(t){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield e({url:"https://content.dropboxapi.com/2/files/download",method:"post",headers:{Authorization:`Bearer ${r}`,"Dropbox-API-Arg":JSON.stringify({path:"/"+t})},maxContentLength:1/0,maxBodyLength:1/0,responseType:"arraybuffer"});return o.status>=300?(console.error("Error occurred during file download:",o),!1):o.data}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class k{constructor(e){this.queue=[],this.runningTasks=0,this.maxConcurrency=e}addTask(e){return s(this,void 0,void 0,(function*(){return new Promise(((t,r)=>{const o=()=>s(this,void 0,void 0,(function*(){try{this.runningTasks++;const r=yield e();return t(r),r}catch(e){throw r(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?o():this.queue.push(o)}))}))}runNext(){if(this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}}class b{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.refreshTokenPromise=null,this.taskQueue=new k(3)}retryOperation(e,t=3){return s(this,void 0,void 0,(function*(){let r=0;for(;;){const o=yield e();if(o)return o;if(r>=t)return o;r++;const i=1e3*Math.pow(2,r);console.info(`Retry attempt ${r} after ${i}ms`),yield new Promise((e=>setTimeout(e,i)))}}))}getFileId(t,r){return s(this,void 0,void 0,(function*(){const o=yield this.refreshToken(),i=`https://www.googleapis.com/drive/v3/files?q=name='${t}'+and+'${r}'+in+parents&spaces=appDataFolder&fields=files(id,name)`;try{const t=yield e.get(i,{headers:{Authorization:"Bearer "+o}});if(0===t.data.files.length)return"";const r=t.data.files;return r.length>0?r[0].id:null}catch(e){return console.error("Error occurred during file list retrieval:",e),""}}))}checkFolder(t){return s(this,void 0,void 0,(function*(){const r=yield this.refreshToken(),o=yield this.getFolderId(t);if(o)return o;const i={name:t,mimeType:"application/vnd.google-apps.folder",parents:["appDataFolder"]};try{return(yield e.post("https://www.googleapis.com/drive/v3/files",i,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})).data.id}catch(e){throw console.error("Error occurred during folder creation:",e),e}}))}getFolderId(t){return s(this,void 0,void 0,(function*(){const r=yield this.refreshToken(),o=`https://www.googleapis.com/drive/v3/files?q=name='${t}'+and+mimeType='application/vnd.google-apps.folder'+and+'appDataFolder'+in+parents&spaces=appDataFolder&fields=files(id,name)`;try{const t=(yield e.get(o,{headers:{Authorization:`Bearer ${r}`}})).data.files;return t.length>0?t[0].id:null}catch(e){throw console.error("Error occurred during fetching folder ID:",e),e}}))}listFiles(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken();const o=`https://www.googleapis.com/drive/v3/files?q='${yield this.checkFolder(t)}'+in+parents&spaces=appDataFolder&fields=files(id,name)`;return(yield e.get(o,{headers:{Authorization:`Bearer ${r}`}})).data.files.map((e=>e.name))}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQue(e)}))))))}))}deleteFileWithoutQue(t){return s(this,void 0,void 0,(function*(){const r=t.split("/")[1],o=t.split("/")[0],i=yield this.getFolderId(o),n=yield this.refreshToken(),s=yield this.getFileId(r,i);if(""===s)return console.error("File not found:",r),!0;try{const t=yield e.delete(`https://www.googleapis.com/drive/v3/files/${s}`,{headers:{Authorization:`Bearer ${n}`}});return console.error("File deleted:",t),!0}catch(e){return console.error("Error deleting file:",e),!1}}))}refreshToken(){return s(this,void 0,void 0,(function*(){return this.config.access_token&&this.config.expires_at>(new Date).getTime()?this.config.access_token:(this.refreshTokenPromise||(this.refreshTokenPromise=(()=>s(this,void 0,void 0,(function*(){try{let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"google",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}finally{this.refreshTokenPromise=null}})))()),this.refreshTokenPromise)}))}authToken(e){return s(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"google",redirect_uri:c.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://accounts.google.com/o/oauth2/v2/auth?redirect_uri=${c.callbackUrl}&prompt=consent&response_type=code&client_id=${c.googleClientId}&scope=https://www.googleapis.com/auth/drive.appdata&access_type=offline`}}const w=e=>"json"===e?"application/json":["jpg","jpeg","png","gif","bmp"].includes(e)?"image/"+e:"zip"===e?"application/zip":"epub"===e?"application/epub+zip":"txt"===e?"text/plain":"pdf"===e?"application/pdf":"mobi"===e?"application/x-mobipocket-ebook":"azw3"===e||"azw"===e?"application/vnd.amazon.ebook":"cbz"===e?"application/x-cbz":"cbr"===e?"application/x-cbr":"cbt"===e?"application/x-cbt":"cb7"===e?"application/x-cb7":"fb2"===e?"application/x-fictionbook+xml":"html"===e?"text/html":"css"===e?"text/css":"js"===e?"application/javascript":"xml"===e?"application/xml":"xhtml"===e?"application/xhtml+xml":"opf"===e?"application/oebps-package+xml":"ncx"===e?"application/x-dtbncx+xml":"mp3"===e?"audio/mpeg":"wav"===e?"audio/wav":"ogg"===e?"audio/ogg":"mp4"===e?"video/mp4":"webm"===e?"video/webm":"avi"===e?"video/x-msvideo":"wmv"===e?"video/x-ms-wmv":"flv"===e?"video/x-flv":"m3u8"===e?"application/x-mpegURL":"ts"===e?"video/MP2T":"3gp"===e?"video/3gpp":"3g2"===e?"video/3gpp2":"db"===e?"application/x-sqlite3":void 0,T=["books","notes","bookmarks","plugins","words"],C=e=>{var t=new ArrayBuffer(e.byteLength);return new Uint8Array(t).set(new Uint8Array(e)),t},E=e=>{const t=atob(e),r=t.length,o=new Uint8Array(r);for(let e=0;e<r;e++)o[e]=t.charCodeAt(e);return o.buffer},x=e=>{let t="";const r=new Uint8Array(e),o=r.byteLength;for(let e=0;e<o;e++)t+=String.fromCharCode(r[e]);return btoa(t)};var _={getMimeType:w,databaseList:T,configList:["themeColors","readingTime","cloudSyncTime","recentBooks","recentAdd","deletedBooks","favoriteBooks","shelfList","txtParsers","noteTags","recordLocation","sortedShelfList"],copyArrayBuffer:C,base64ToArrayBuffer:E,arrayBufferToBase64:x,generateSHA256Hash:function(e){return s(this,void 0,void 0,(function*(){const t=(new TextEncoder).encode(e),r=yield crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(r)).map((e=>e.toString(16).padStart(2,"0"))).join("")}))}};class S extends b{constructor(e,t){super(e,t)}uploadFile(t,r){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken();let i=r.split("/").pop()||"",n=new File([t],i,{lastModified:(new Date).getTime(),type:t.type}),s=r.split(".").pop(),a=w(s||""),c=r.split("/")[0],l=yield this.checkFolder(c),d=yield this.getFileId(i||"",l);const u={mimeType:a,name:i,parents:[l]},h=d?`https://www.googleapis.com/upload/drive/v3/files/${d}?uploadType=resumable`:"https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable",p=(yield e({method:d?"PATCH":"POST",url:h,data:d?null:JSON.stringify(u),headers:{Authorization:"Bearer "+o,"Content-Type":"application/json; charset=UTF-8"},maxContentLength:1/0,maxBodyLength:1/0})).headers.location,f=yield this.getData(n);if(0===Object.keys(f).length)return!1;const y=yield e.put(p,f.data,{headers:{Authorization:"Bearer "+o,"Content-Type":"application/zip","Content-Range":`bytes 0-${f.fileSize-1}/${f.fileSize}`},maxContentLength:1/0,maxBodyLength:1/0});return!(y.status>=300)||(console.error("Error occurred during file download:",y),!1)}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(t){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken();let o=t.split("/").pop(),i=t.split("/")[0],n=yield this.checkFolder(i),s=yield this.getFileId(o||"",n);if(!s)throw new Error("File not found");const a=`https://www.googleapis.com/drive/v3/files/${s}?alt=media`,c=yield e.get(a,{headers:{Authorization:"Bearer "+r},maxContentLength:1/0,maxBodyLength:1/0,responseType:"arraybuffer"});return c.status>=300?(console.error("Error occurred during file download:",c),!1):c.data}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}getData(e){return s(this,void 0,void 0,(function*(){return e?new Promise(((t,r)=>{const o=new FileReader;o.onload=r=>t({fileName:e.name,mimeType:e.type,fileSize:e.size,data:r.target.result}),o.onerror=e=>r(e),o.readAsArrayBuffer(e)})):{}}))}}class R{constructor(e){this.queue=[],this.runningTasks=0,this.maxConcurrency=e}addTask(e){return s(this,void 0,void 0,(function*(){return new Promise(((t,r)=>{const o=()=>s(this,void 0,void 0,(function*(){try{this.runningTasks++;const r=yield e();return t(r),r}catch(e){throw r(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?o():this.queue.push(o)}))}))}runNext(){if(this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}}class O{constructor(e){this.folderCreationLocks=new Map,this.config=e,this.taskQueue=new R(3)}retryOperation(e,t=3){return s(this,void 0,void 0,(function*(){let r=0;for(;;){const o=yield e();if(o)return o;if(r>=t)return o;r++;const i=1e3*Math.pow(2,r);console.info(`Retry attempt ${r} after ${i}ms`),yield new Promise((e=>setTimeout(e,i)))}}))}getStorage(){return s(this,void 0,void 0,(function*(){if(this.storage)return this.storage;let{email:e,password:r}=this.config;return this.storage=yield new t({email:e,password:r}).ready,this.storage}))}getRoot(){return s(this,void 0,void 0,(function*(){if(this.root)return this.root;const e=(yield this.getStorage()).root;let t=e.children.find((e=>"KoodoReader"===e.name&&e.directory));return t||(t=yield e.mkdir("KoodoReader")),this.root=t,this.root}))}createFolder(e,t){return s(this,void 0,void 0,(function*(){const r=`${e.nodeId}_${t}`;if(this.folderCreationLocks.has(r))return yield this.folderCreationLocks.get(r);const o=(()=>s(this,void 0,void 0,(function*(){try{let r=e.children.find((e=>e.name===t&&e.directory));return r||(r=yield e.mkdir(t),r)}finally{this.folderCreationLocks.delete(r)}})))();return this.folderCreationLocks.set(r,o),yield o}))}listFiles(e){return s(this,void 0,void 0,(function*(){try{let t=yield this.getRoot();if(e){const r=e.split("/").filter((e=>e));for(const e of r){const r=t.children.find((t=>t.name===e&&t.directory));if(!r)return[];t=r}}return t.children.filter((e=>!e.directory)).map((e=>e.name))}catch(e){return console.error("Error listing MEGA files:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(e){return s(this,void 0,void 0,(function*(){try{let t=yield this.getRoot();const r=e.split("/"),o=r.pop();for(const e of r){if(!e)continue;const r=t.children.find((t=>t.name===e&&t.directory));if(!r)return!0;t=r}const i=t.children.find((e=>e.name===o&&!e.directory));return!i||(yield i.delete(),!0)}catch(e){return console.error("Error deleting MEGA file:",e),!1}}))}}class A extends O{constructor(e){super(e)}uploadFile(e,t){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{let o=yield this.getRoot();const i=t.split("/"),n=i.pop()||"";for(const e of i){if(!e)continue;let t=o.children.find((t=>t.name===e&&t.directory));t||(t=yield this.createFolder(o,e)),o=t}const s=new File([e],n,{lastModified:(new Date).getTime(),type:e.type}),a=yield e.arrayBuffer(),c=new Uint8Array(a),l=r.from(c),d=o.children.find((e=>e.name===n&&!e.directory));return d&&(yield d.delete()),yield o.upload({name:n,size:s.size},l).complete,!0}catch(e){return console.error("Error occurred during MEGA file upload:",e),!1}}))))))}))}downloadFile(e){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{let t=yield this.getRoot();const r=e.split("/"),o=r.pop()||"";for(const e of r){if(!e)continue;const r=t.children.find((t=>t.name===e&&t.directory));if(!r)return!1;t=r}const i=t.children.find((e=>e.name===o&&!e.directory));if(!i)return!1;return yield i.downloadBuffer()}catch(e){return console.error("Error occurred during MEGA file download:",e),!1}}))))))}))}}class I{constructor(e){this.queue=[],this.runningTasks=0,this.maxConcurrency=e}addTask(e){return s(this,void 0,void 0,(function*(){return new Promise(((t,r)=>{const o=()=>s(this,void 0,void 0,(function*(){try{this.runningTasks++;const r=yield e();return t(r),r}catch(e){throw r(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?o():this.queue.push(o)}))}))}runNext(){if(this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}}class F{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.refreshTokenPromise=null,this.taskQueue=new I(3)}retryOperation(e,t=3){return s(this,void 0,void 0,(function*(){let r=0;for(;;){const o=yield e();if(o)return o;if(r>=t)return o;r++;const i=1e3*Math.pow(2,r);console.info(`Retry attempt ${r} after ${i}ms`),yield new Promise((e=>setTimeout(e,i)))}}))}listFiles(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield e.get(`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}:/children`,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});return o.status>=300?[]:o.data.value.map((e=>e.name))}catch(e){return console.error("Error occurred during file list:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield e.delete(`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}`,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});return!(o.status>=300)||(console.error("Error deleting file:",o),!0)}catch(e){return console.error("Error occurred during file delete:",e),!1}}))}refreshToken(){return s(this,void 0,void 0,(function*(){return this.config.access_token&&this.config.expires_at>(new Date).getTime()?this.config.access_token:(this.refreshTokenPromise||(this.refreshTokenPromise=(()=>s(this,void 0,void 0,(function*(){try{let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"microsoft",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}finally{this.refreshTokenPromise=null}})))()),this.refreshTokenPromise)}))}authToken(e){return s(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"microsoft",redirect_uri:c.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${c.microsoftClientId}&scope=files.readwrite.appfolder offline_access&response_type=code&redirect_uri=${c.callbackUrl}`}}class L extends F{constructor(e,t){super(e,t)}uploadFile(t,r){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken();let i=r.split("/").pop()||"",n=new File([t],i,{lastModified:(new Date).getTime(),type:t.type});const s="https://graph.microsoft.com/v1.0/me/drive/special/approot:/"+r+":/createUploadSession",a=yield e.post(s,null,{headers:{Authorization:"Bearer "+o,"Content-Type":"application/json"},maxContentLength:1/0,maxBodyLength:1/0});let c=n.size;const l=n.type,d=a.data.uploadUrl,u=yield e.put(d,n,{headers:{"Content-Type":l,"Content-Range":`bytes 0-${c-1}/${c}`},maxContentLength:1/0,maxBodyLength:1/0});return!(u.status>=300)||(console.error("Error occurred during file download:",u),!1)}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(t){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}:/content`,i=yield e.get(o,{responseType:"arraybuffer",headers:{Authorization:"Bearer "+r},maxContentLength:1/0,maxBodyLength:1/0});return i.status>=300?(console.error("Error occurred during file download:",i),!1):i.data}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class j{downloadFile(e,t){return s(this,void 0,void 0,(function*(){return new Promise((e=>{e(!0)}))}))}uploadFile(e,t){return s(this,void 0,void 0,(function*(){return new Promise((e=>{e(!0)}))}))}listFiles(e){return s(this,void 0,void 0,(function*(){return new Promise((e=>{e([])}))}))}authToken(e){return s(this,void 0,void 0,(function*(){return new Promise((e=>{e("")}))}))}getAuthUrl(){return""}}class M{constructor(e){this.queue=[],this.runningTasks=0,this.maxConcurrency=e}addTask(e){return s(this,void 0,void 0,(function*(){return new Promise(((t,r)=>{const o=()=>s(this,void 0,void 0,(function*(){try{this.runningTasks++;const r=yield e();return t(r),r}catch(e){throw r(e),e}finally{this.runningTasks--,this.runNext()}}));this.runningTasks<this.maxConcurrency?o():this.queue.push(o)}))}))}runNext(){if(this.queue.length>0&&this.runningTasks<this.maxConcurrency){const e=this.queue.shift();e&&e()}}}class B{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.taskQueue=new M(3)}retryOperation(e,t=5){return s(this,void 0,void 0,(function*(){let r=0;for(;;){const o=yield e();if(o)return o;if(r>=t)return o;r++;const i=1e3*Math.pow(2,r);console.info(`Retry attempt ${r} after ${i}ms`),yield new Promise((e=>setTimeout(e,i)))}}))}checkFolderExists(t,r){return s(this,void 0,void 0,(function*(){try{return 0===(yield e.get("https://api.pcloud.com/listfolder",{params:{access_token:r,path:`/${t}`}})).data.result}catch(e){return console.error("Error checking folder:",e),!1}}))}createFolder(t,r){return s(this,void 0,void 0,(function*(){try{return 0===(yield e.get("https://api.pcloud.com/createfolderifnotexists",{params:{access_token:r,path:`/${t}`}})).data.result}catch(e){return console.error("Error creating folder:",e),!1}}))}listFiles(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield e.get("https://api.pcloud.com/listfolder",{params:{access_token:r,path:"/"+t,recursive:0}});return 0!==o.data.result?[]:o.data.metadata.contents.map((e=>e.name))}catch(e){return console.error("Error occurred during file list:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){return yield this.deleteFileWithoutQueue(e)}))))))}))}deleteFileWithoutQueue(t){return s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield e.get("https://api.pcloud.com/deletefile",{params:{access_token:r,path:"/"+t}});return 0===o.data.result||(console.error("Error deleting file:",o.data),!0)}catch(e){return console.error("Error occurred during file delete:",e),!1}}))}refreshToken(){return s(this,void 0,void 0,(function*(){return this.config.refresh_token}))}authToken(e){return s(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"pcloud",redirect_uri:c.callbackUrl,code:e})).data.access_token}))}getAuthUrl(){return`https://my.pcloud.com/oauth2/authorize?client_id=${c.pcloudClientId}&response_type=code&redirect_uri=${c.callbackUrl}`}}class P extends B{constructor(e,t){super(e,t)}uploadFile(t,r){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),i=r.split("/").slice(0,-1).join("/");if(!(yield this.checkFolderExists(i,o))){if(!(yield this.createFolder(i,o)))return!1}let n=r.split("/").pop()||"",s=new File([t],n,{lastModified:(new Date).getTime(),type:t.type});const a=new FormData;a.append("file",s);const c=yield e.post("https://api.pcloud.com/uploadfile",a,{params:{access_token:o,path:`/${i}`,renew:1},maxContentLength:1/0,maxBodyLength:1/0});return 0===c.data.result||(console.error("Error uploading file:",c.data),!1)}catch(e){return console.error("Error uploading file:",e),!1}}))))))}))}downloadFile(t){return s(this,void 0,void 0,(function*(){return this.taskQueue.addTask((()=>this.retryOperation((()=>s(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield e.get("https://api.pcloud.com/getfilelink",{params:{access_token:r,path:`/${t}`}});if(0!==o.data.result)return console.error("Error getting file link:",o.data),!1;const i=`https://${o.data.hosts[0]}${o.data.path}`,n=yield e.get(i,{responseType:"arraybuffer",maxContentLength:1/0,maxBodyLength:1/0});return n.status>=300?(console.error("Error downloading file:",n),!1):n.data}catch(e){return console.error("Error occurred during file download:",e),!1}}))))))}))}}class q{constructor(e,t){this.config=e,this.thirdpartyRequest=t}listFiles(e){return s(this,void 0,void 0,(function*(){let{endpoint:t,region:r,bucketName:o,accessKeyId:i,secretAccessKey:n,dir:s}=this.config;try{return(yield this.thirdpartyRequest.s3List({bucket_name:o,prefix:s+"/"+e,region:r,endpoint:t,access_key_id:i,secret_access_key:n})).data.contents.map((e=>e.split("/").pop()))}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){let{endpoint:t,region:r,bucketName:o,accessKeyId:i,secretAccessKey:n,dir:s}=this.config;try{let a=yield this.thirdpartyRequest.s3Delete({bucket_name:o,object_key:s+"/"+e,region:r,endpoint:t,access_key_id:i,secret_access_key:n});return 200===a.code||(console.error("Error deleting file:",a),!1)}catch(e){return console.error("Error deleting file:",e),!1}}))}}class z extends q{constructor(e,t){super(e,t)}uploadFile(t,r){return new Promise(((o,i)=>s(this,void 0,void 0,(function*(){let{endpoint:i,region:n,bucketName:s,accessKeyId:a,secretAccessKey:c,dir:l}=this.config;try{const d=(yield this.thirdpartyRequest.s3Upload({bucket_name:s,object_key:l+"/"+r,region:n,endpoint:i,access_key_id:a,secret_access_key:c})).data.url;let u=r.split("/").pop()||"",h=new File([t],u,{lastModified:(new Date).getTime(),type:t.type});const p=yield e.put(d,h,{headers:{},maxContentLength:1/0,maxBodyLength:1/0});if(p.status>=300)return console.error("Error occurred during file upload:",p),void o(!1);o(!0)}catch(e){console.error("Error occurred during file upload:",e),o(!1)}}))))}downloadFile(t){return new Promise(((r,o)=>s(this,void 0,void 0,(function*(){let{endpoint:o,region:i,bucketName:n,accessKeyId:s,secretAccessKey:a,dir:c}=this.config;try{const l=(yield this.thirdpartyRequest.s3Download({bucket_name:n,object_key:c+"/"+t,region:i,endpoint:o,access_key_id:s,secret_access_key:a})).data.url,d=yield e({url:l,method:"get",headers:{},responseType:"arraybuffer",maxContentLength:1/0,maxBodyLength:1/0});r(d.data)}catch(e){console.error("Error occurred during file download:",e),r(!1)}}))))}}class N{constructor(e){let{username:t,password:r,url:n,dir:s}=e;this.client=o(n,{authType:i.Password,username:t,password:r}),this.username=t,this.password=r,this.dir=s}uploadFile(t,r){return new Promise(((o,i)=>s(this,void 0,void 0,(function*(){try{!1===(yield this.client.exists(r.substring(0,r.lastIndexOf("/"))))&&(yield this.client.createDirectory(r.substring(0,r.lastIndexOf("/"))));let i=r.split("/").pop()||"",n=new File([t],i,{lastModified:(new Date).getTime(),type:t.type}),s=this.client.getFileUploadLink(this.dir+"/"+r);const a=new URL(s);a.search="",s=a.toString();const c=btoa(this.username+":"+this.password);yield e.put(s,n,{headers:{Authorization:"Basic "+c},maxContentLength:1/0,maxBodyLength:1/0});o(!0)}catch(e){console.error("Error uploading file:",e),o(!1)}}))))}downloadFile(t){return new Promise(((r,o)=>s(this,void 0,void 0,(function*(){try{const o=this.client.getFileDownloadLink(this.dir+"/"+t),i=btoa(this.username+":"+this.password),n=yield e({url:o,method:"get",headers:{Authorization:"Basic "+i},responseType:"arraybuffer",maxContentLength:1/0,maxBodyLength:1/0});if(n.status>=300)return console.error("Error occurred during file download:",n),void r(!1);r(n.data)}catch(e){console.error("Error occurred during file download:",e),r(!1)}}))))}listFiles(e){return s(this,void 0,void 0,(function*(){try{return(yield this.client.getDirectoryContents(this.dir+"/"+e)).map((e=>e.basename))}catch(e){return console.error("Error listing files:",e),[]}}))}deleteFile(e){return s(this,void 0,void 0,(function*(){try{return yield this.client.deleteFile(this.dir+"/"+e),!0}catch(e){return console.error("Error deleting file:",e),!1}}))}}const D=["book","config","cover","font"];class ${constructor(e,t,r){this.type=e,this.remote="dropbox"===e?new v(t,r):"microsoft"===e?new L(t,r):"google"===e?new S(t,r):"s3compatible"===e?new z(t,r):"webdav"===e?new N(t):"boxnet"===e?new y(t,r):"mega"===e?new A(t):"adrive"===e?new h(t,r):"pcloud"===e?new P(t,r):new j}downloadFile(e,t){return s(this,void 0,void 0,(function*(){return!!(yield this.listFiles(t)).find((t=>e.indexOf(t)>-1))&&(yield this.remote.downloadFile(t+"/"+e))}))}uploadFile(e,t,r){return s(this,void 0,void 0,(function*(){return yield this.remote.uploadFile(r,t+"/"+e)}))}deleteFile(e,t){return s(this,void 0,void 0,(function*(){return yield this.remote.deleteFile(t+"/"+e)}))}listFiles(e){return s(this,void 0,void 0,(function*(){return yield this.remote.listFiles(e)}))}isExist(e,t){return s(this,void 0,void 0,(function*(){return(yield this.listFiles(t)).find((t=>-1!==t.indexOf(e)))}))}downloadAllFiles(){return s(this,void 0,void 0,(function*(){for(let e of D){let t=yield this.listFiles(e);for(let r of t)yield this.downloadFile(r,e)}}))}authToken(e){return s(this,void 0,void 0,(function*(){return yield this.remote.authToken(e)}))}getAuthUrl(){return this.remote.getAuthUrl?this.remote.getAuthUrl():""}}const U={notes:"SELECT * FROM notes WHERE key = ?",bookmarks:"SELECT * FROM bookmarks WHERE key = ?",books:"SELECT * FROM books WHERE key = ?",plugins:"SELECT * FROM plugins WHERE key = ?",words:"SELECT * FROM words WHERE key = ?"},W={notes:"SELECT * FROM notes WHERE bookKey = ?",bookmarks:"SELECT * FROM bookmarks WHERE bookKey = ?",words:"SELECT * FROM words WHERE bookKey = ?",books:"SELECT * FROM books WHERE key = ?"},K={notes:"DELETE FROM notes WHERE bookKey = ?",bookmarks:"DELETE FROM bookmarks WHERE bookKey = ?",words:"DELETE FROM words WHERE bookKey = ?"};function J(e){for(const t in e)e.hasOwnProperty(t)&&(e[`temp-${t}`]=e[t]);return e}const Q={notes:e=>{let t=Object.assign({},e);return t.date=JSON.parse(e.date),t.tag=JSON.parse(e.tag),t},bookmarks:e=>e,books:e=>e,plugins:e=>{let t=Object.assign({},e);return e.autoValue||delete t.autoValue,e.langList?t.langList=JSON.parse(e.langList):delete t.langList,e.voiceList?t.voiceList=JSON.parse(e.voiceList):delete t.voiceList,t.config=JSON.parse(e.config),t},words:e=>{let t=Object.assign({},e);return t.date=JSON.parse(e.date),t}};var H,V={sqlStatement:{createTableStatement:J({notes:'\n      CREATE TABLE IF NOT EXISTS "notes" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "date" object,\n        "chapter" text,\n        "chapterIndex" integer,\n        "text" text,\n        "cfi" text,\n        "range" text,\n        "notes" text,\n        "percentage" text,\n        "color" integer,\n        "tag" array\n      )\n    ',bookmarks:'\n      CREATE TABLE IF NOT EXISTS "bookmarks" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "cfi" text,\n        "label" text,\n        "percentage" text,\n        "chapter" text\n      );\n    ',books:'\n      CREATE TABLE IF NOT EXISTS "books" (\n        "key" text PRIMARY KEY,\n        "name" text,\n        "author" text,\n        "description" text,\n        "md5" text,\n        "cover" text,\n        "format" text,\n        "publisher" text,\n        "size" integer,\n        "page" integer,\n        "path" text,\n        "charset" text\n      );\n    ',plugins:'\n      CREATE TABLE IF NOT EXISTS "plugins" (\n        "key" text PRIMARY KEY,\n        "type" text,\n        "displayName" text,\n        "icon" text,\n        "version" text,\n        "config" object,\n        "autoValue" string,\n        "langList" text,\n        "voiceList" text,\n        "scriptSHA256" text,\n        "script" text\n      );\n    ',words:'\n      CREATE TABLE IF NOT EXISTS "words" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "date" object,\n        "word" text,\n        "chapter" text\n      );\n    '}),getAllStatement:J({notes:"SELECT * FROM notes",bookmarks:"SELECT * FROM bookmarks",books:"SELECT * FROM books",plugins:"SELECT * FROM plugins",words:"SELECT * FROM words"}),saveStatement:J({notes:"INSERT OR REPLACE INTO notes (key, bookKey, chapter, chapterIndex, text, cfi, range, notes, date, percentage, color, tag) VALUES (@key, @bookKey, @chapter, @chapterIndex, @text, @cfi, @range, @notes, @date, @percentage, @color, @tag)",bookmarks:"INSERT OR REPLACE INTO bookmarks (key, bookKey, cfi, label, percentage, chapter) VALUES (@key, @bookKey, @cfi, @label, @percentage, @chapter)",books:"INSERT OR REPLACE INTO books (key, name, author, description, md5, cover, format, publisher, size, page, path, charset) VALUES (@key, @name, @author, @description, @md5, @cover, @format, @publisher, @size, @page, @path, @charset)",plugins:"INSERT OR REPLACE INTO plugins (key, type, displayName, icon, version, config, autoValue, langList, voiceList, scriptSHA256, script) VALUES (@key, @type, @displayName, @icon, @version, @config, @autoValue, @langList, @voiceList, @scriptSHA256, @script)",words:"INSERT OR REPLACE INTO words (key, bookKey, date, word, chapter) VALUES (@key, @bookKey, @date, @word, @chapter)"}),deleteAllStatement:J({notes:"DELETE FROM notes",bookmarks:"DELETE FROM bookmarks",books:"DELETE FROM books",plugins:"DELETE FROM plugins",words:"DELETE FROM words"}),updateStatement:J({notes:"UPDATE notes SET bookKey = @bookKey, chapter = @chapter, chapterIndex = @chapterIndex, text = @text, cfi = @cfi, range = @range, notes = @notes, date = @date, percentage = @percentage, color = @color, tag = @tag WHERE key = @key",bookmarks:"UPDATE bookmarks SET bookKey = @bookKey, cfi = @cfi, label = @label, percentage = @percentage, chapter = @chapter WHERE key = @key",books:"UPDATE books SET name = @name, author = @author, description = @description, md5 = @md5, cover = @cover, format = @format, publisher = @publisher, size = @size, page = @page, path = @path, charset = @charset WHERE key = @key",plugins:"UPDATE plugins SET type = @type, displayName = @displayName, icon = @icon, version = @version, config = @config, autoValue = @autoValue, langList = @langList, voiceList = @voiceList, scriptSHA256 = @scriptSHA256, script = @script WHERE key = @key",words:"UPDATE words SET bookKey = @bookKey, date = @date, word = @word, chapter = @chapter WHERE key = @key"}),deleteStatement:J({notes:"DELETE FROM notes WHERE key = ?",bookmarks:"DELETE FROM bookmarks WHERE key = ?",books:"DELETE FROM books WHERE key = ?",plugins:"DELETE FROM plugins WHERE key = ?",words:"DELETE FROM words WHERE key = ?"}),dropStatement:J({notes:"DROP TABLE IF EXISTS notes",bookmarks:"DROP TABLE IF EXISTS bookmarks",books:"DROP TABLE IF EXISTS books",plugins:"DROP TABLE IF EXISTS plugins",words:"DROP TABLE IF EXISTS words"}),getStatement:J(U),getByBookKeyStatement:J(W),getByBookKeysStatement:J({notes:e=>`SELECT * FROM notes WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,bookmarks:e=>`SELECT * FROM bookmarks WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,words:e=>`SELECT * FROM words WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,books:e=>`SELECT * FROM books WHERE key IN (${e.map((()=>"?")).join(",")})`}),deleteByBookKeyStatement:J(K)},jsonToSqlite:J({notes:e=>{let t=Object.assign({},e);return t.date=JSON.stringify(e.date),t.tag=JSON.stringify(e.tag),t},bookmarks:e=>e,books:e=>{let t=Object.assign({},e);return t.page=e.page||0,t},plugins:e=>{let t=Object.assign({},e);return e.autoValue||(t.autoValue=null),e.langList?t.langList=JSON.stringify(e.langList):t.langList=null,e.voiceList?t.voiceList=JSON.stringify(e.voiceList):t.voiceList=null,t.config=JSON.stringify(e.config),t},words:e=>{let t=Object.assign({},e);return t.date=JSON.stringify(e.date),t}}),sqliteToJson:J(Q)};class X{constructor(e,t,r,o,i,n,s,a,c,l,d,u){this.key=e,this.name=t,this.author=r,this.description=o,this.md5=i,this.cover=n,this.format=s,this.publisher=a,this.size=c,this.page=l,this.path=d,this.charset=u}}class Y{static generateBook(e,t,r,o,i,n,a){return new Promise(((c,l)=>s(this,void 0,void 0,(function*(){try{let s,l,d,u,h,p,f,y,g="";switch([l,d,h,u,p,f]=[e,"","","","",0],t){case"pdf":case"epub":case"mobi":case"azw":case"azw3":case"fb2":y=yield a.getMetadata(),[l,d,h,u,g]=[y.name||e,y.author||"",y.description||"",y.publisher||"",y.cover||""];break;case"cbr":case"cbt":case"cbz":case"cb7":y=yield a.getMetadata(),g=y.cover;break;case"txt":y=yield a.getMetadata(n),p=y.charset}let m=t.toUpperCase();s=(new Date).getTime()+"",c(new X(s,l,d,h,r,g,m,u,o,f,i,p))}catch(e){console.error(e),l(e)}}))))}}H=Y,Y.getRendtion=(e,t,r,o,i,n,s,a)=>{let c;return"CACHE"===t?c=new a.CacheRender(e,{readerMode:r,animation:i,convertChinese:n}):"MOBI"===t||"AZW3"===t||"AZW"===t?c=new a.MobiRender(e,{readerMode:r,animation:i,convertChinese:n}):"EPUB"===t?c=new a.EpubRender(e,{readerMode:r,animation:i,convertChinese:n}):"TXT"===t?c=new a.TxtRender(e,{readerMode:r,animation:i,charset:o,convertChinese:n,parserRegex:s}):"MD"===t?c=new a.MdRender(e,{readerMode:r,animation:i,convertChinese:n}):"PDF"===t?c=new a.PdfRender(e,{readerMode:r,animation:i,convertChinese:n}):"FB2"===t?c=new a.Fb2Render(e,{readerMode:r,animation:i,convertChinese:n}):"DOCX"===t?c=new a.DocxRender(e,{readerMode:r,animation:i,convertChinese:n}):"HTML"===t||"XHTML"===t||"MHTML"===t||"HTM"===t||"XML"===t?c=new a.HtmlRender(e,{readerMode:r,format:t,animation:i,convertChinese:n}):"CBR"!==t&&"CBT"!==t&&"CBZ"!==t&&"CB7"!==t||(c=new a.ComicRender(C(e),{readerMode:r,format:t,animation:i,convertChinese:n})),c},Y.addMobileBook=(e,t,r,o,i,n,a="")=>s(void 0,void 0,void 0,(function*(){try{let s=E(e),c=H.getRendtion(s,r.toUpperCase(),"","","","no",a,window.Kookit),l=yield Y.generateBook(t,r,o,i,n,s,c);if(!l||!l.key)return;window.ReactNativeWebView.postMessage(JSON.stringify({event:"metadata",bookInfo:l}));let d=yield c.preCache(s);if(""===d)window.ReactNativeWebView.postMessage(JSON.stringify({event:"cache",cacheBase64:"",key:l.key}));else if("err"!==d){let e=x(d);window.ReactNativeWebView.postMessage(JSON.stringify({event:"cache",cacheBase64:e,key:l.key}))}else window.ReactNativeWebView.postMessage(JSON.stringify({event:"error",message:"Parse book failed"}))}catch(e){console.error(e),window.ReactNativeWebView.postMessage(JSON.stringify({event:"error",message:"Parse book failed"}))}}));const G=a.cloudUrl;class Z{constructor(e,t){this.processingQueue=!1,this.requestQueue=[],this.TokenService=e,this.ConfigService=t,this.refreshToken="",this.accessToken="",this.streamPromise=null}refreshUserToken(){return s(this,void 0,void 0,(function*(){if(this.refreshToken=yield this.TokenService.getToken("refresh_token"),!this.refreshToken)return{code:401,message:"refresh token not found"};let t=(yield e.post(G+"/api/v1/public/user/refresh_token",{refresh_token:this.refreshToken})).data;return 200===t.code&&(yield this.TokenService.setToken("access_token",t.data.access_token),yield this.TokenService.setToken("refresh_token",t.data.refresh_token),this.accessToken=t.data.access_token,this.refreshToken=t.data.refresh_token),t}))}requestWithRetry(e){return s(this,void 0,void 0,(function*(){return this.requestQueue||(this.requestQueue=[]),new Promise(((t,r)=>{this.requestQueue.push({config:e,resolve:t,reject:r}),this.processingQueue||this.processQueue()}))}))}processQueue(){return s(this,void 0,void 0,(function*(){if(!this.processingQueue){this.processingQueue=!0;try{for(;this.requestQueue.length>0;){const e=this.requestQueue.shift();try{let t=yield this.executeRequest(e.config);e.resolve(t)}catch(t){e.reject(t)}}}finally{this.processingQueue=!1}}}))}executeRequest(t){return s(this,void 0,void 0,(function*(){try{try{this.accessToken=(yield this.TokenService.getToken("access_token"))||""}catch(e){console.error("Error get Token:",e)}let r="req-"+Date.now().toString(36)+"-"+Math.random().toString(36).substring(2,11);t.baseURL=G,t.headers={Authorization:"Bearer "+this.accessToken,"X-Request-ID":r};let o=(yield e(t)).data;if(402===o.code){let r=yield this.refreshUserToken();if(200===r.code){return t.headers=t.headers||{},t.headers.Authorization="Bearer "+this.accessToken,(yield e(t)).data}return r}return 200!==o.code&&this.ConfigService.setItem("errorLog",JSON.stringify({request:t.data,url:t.url,result:o,requestID:r})),o}catch(e){throw console.error("Request execution error:",e),e}}))}requestWithStream(e,t,r){return s(this,void 0,void 0,(function*(){return this.streamPromise||(this.streamPromise=(()=>s(this,void 0,void 0,(function*(){try{let o="";try{o=(yield this.TokenService.getToken("access_token"))||""}catch(e){console.error("Error get Token:",e)}let i="req-"+Date.now().toString(36)+"-"+Math.random().toString(36).substring(2,11);return new Promise(((n,a)=>{const c=new r(G+e.url,{headers:{"Content-Type":"application/json",Authorization:"Bearer "+o,"X-Request-ID":i},method:e.method,body:JSON.stringify(e.data),pollingInterval:0});c.addEventListener("open",(()=>{console.info("Connection to OpenAI established.")})),c.addEventListener("message",(e=>s(this,void 0,void 0,(function*(){if(!e.data)return;const r=JSON.parse(e.data);r.done?(c.close(),n(r)):(402===r.code&&(yield this.refreshUserToken()),t(r.data))})))),c.addEventListener("error",(e=>{console.error("Error:",e),n({code:500,message:"internal error"}),c.close()}))}))}finally{this.streamPromise=null}})))()),this.streamPromise}))}requestWithFetch(e,t){return s(this,void 0,void 0,(function*(){return this.streamPromise||(this.streamPromise=(()=>s(this,void 0,void 0,(function*(){try{let r="";try{r=(yield this.TokenService.getToken("access_token"))||""}catch(e){console.error("Error get Token:",e)}let o="req-"+Date.now().toString(36)+"-"+Math.random().toString(36).substring(2,11);return new Promise(((i,n)=>s(this,void 0,void 0,(function*(){const n=yield fetch(G+e.url,{method:"POST",headers:{"Content-Type":"text/event-stream",Authorization:"Bearer "+r,"X-Request-ID":o},body:JSON.stringify(e.data)});if(!n.body)throw new Error("Response body is null");const s=n.body.pipeThrough(new TextDecoderStream).getReader();for(;;){const{value:e,done:r}=yield s.read();if(r)break;if(e)if(e.includes('"code":400')||e.includes('"code":401')||e.includes('"code":402')){let t=JSON.parse(e);402===t.code&&(yield this.refreshUserToken()),i(t)}else e.split("\n").forEach((e=>{if(e.startsWith("data:")){const r=JSON.parse(e.substring(5));t(r.data)}}))}}))))}finally{this.streamPromise=null}})))()),this.streamPromise}))}}class ee extends Z{constructor(e,t){super(e,t)}getTransStream(e,t,r){return s(this,void 0,void 0,(function*(){const o={method:"post",url:"/api/v1/pro/reader/get_llm_trans_stream",data:e};return yield this.requestWithStream(o,t,r)}))}getTransFetch(e,t){return s(this,void 0,void 0,(function*(){const r={method:"post",url:"/api/v1/pro/reader/get_llm_trans_stream",data:e};return yield this.requestWithFetch(r,t)}))}getDictionary(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/reader/get_llm_dict",data:e};return yield this.requestWithRetry(t)}))}getSummaryStream(e,t,r){return s(this,void 0,void 0,(function*(){const o={method:"post",url:"/api/v1/pro/reader/get_llm_sum_stream",data:e};return yield this.requestWithStream(o,t,r)}))}getSummaryFetch(e,t){return s(this,void 0,void 0,(function*(){const r={method:"post",url:"/api/v1/pro/reader/get_llm_sum_stream",data:e};return yield this.requestWithFetch(r,t)}))}getGoogleFont(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/reader/get_google_font",data:e};return yield this.requestWithRetry(t)}))}}class te extends Z{constructor(e,t){super(e,t)}encryptToken(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/encrypt_token",data:e};return yield this.requestWithRetry(t)}))}decryptToken(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/decrypt_token",data:e};return yield this.requestWithRetry(t)}))}authThirdToken(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/auth_token",data:e};return yield this.requestWithRetry(t)}))}refreshThirdToken(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/refresh_token",data:e};return yield this.requestWithRetry(t)}))}s3Upload(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_upload",data:e};return yield this.requestWithRetry(t)}))}s3Download(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_download",data:e};return yield this.requestWithRetry(t)}))}s3List(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_list",data:e};return yield this.requestWithRetry(t)}))}s3Delete(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_delete",data:e};return yield this.requestWithRetry(t)}))}getSyncState(){return s(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"get",url:"/api/v1/pro/thirdparty/get_sync_state"})}))}deleteSyncState(){return s(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/pro/thirdparty/delete_sync_state"})}))}}class re extends Z{constructor(e,t){super(e,t)}loginRegister(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/public/user/login_register",data:e};return yield this.requestWithRetry(t)}))}logout(){return s(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/member/user/logout"})}))}getLogins(){return s(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/member/user/get_logins"})}))}addLogin(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/member/user/add_login",data:e};return yield this.requestWithRetry(t)}))}removeLogin(e){return s(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/member/user/remove_login",data:e};return yield this.requestWithRetry(t)}))}getUserInfo(){return s(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/member/user/get_info"})}))}getTempToken(){return s(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"get",url:"/api/v1/member/user/get_temp_token"})}))}}var oe={getAuthUrl:(e,t)=>{let r="";if("github"===e?r=`https://github.com/login/oauth/authorize?client_id=${c.githubClientId}&redirect_uri=${c.callbackUrl}&scope=openid`:"google"===e?r=`https://accounts.google.com/o/oauth2/v2/auth?redirect_uri=${c.callbackUrl}&prompt=consent&response_type=code&client_id=${c.googleClientId}&scope=openid&access_type=offline`:"facebook"===e?r=`https://www.facebook.com/v12.0/dialog/oauth?client_id=${c.facebookClientId}&redirect_uri=${c.callbackUrl}&scope=&response_type=code`:"microsoft"===e&&(r=`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${c.microsoftClientId}&scope=openid profile User.Read offline_access&response_type=code&redirect_uri=${c.callbackUrl}`),"manual"===t)return r;let o=JSON.stringify({deeplink:"desktop"===t?"koodo-reader://callback":"browser"===t?"https://web.koodoreader.com/#/login":"",service:e});return`${r}&state=${"state|"+encodeURIComponent(o)}`}};function ie(e,t,r){return s(this,void 0,void 0,(function*(){if("ftp"!==r&&"adrive"!==r){const r=[],o=[];for(const i of e){const e=i().then((t=>(o.splice(o.indexOf(e),1),t)));r.push(e),o.push(e),o.length>=t&&(yield Promise.race(o))}return Promise.all(r)}for(let t of e)yield t()}))}class ne{static CompareDatabase(e,t,r){return s(this,void 0,void 0,(function*(){let o=Object.keys(e).filter((e=>e.startsWith("database.sqlite.books"))),i=Object.keys(e).filter((e=>e.startsWith("database.sqlite.notes"))),n=Object.keys(e).filter((e=>e.startsWith("database.sqlite.bookmarks"))),s=Object.keys(e).filter((e=>e.startsWith("database.sqlite.plugins"))),a=Object.keys(e).filter((e=>e.startsWith("database.sqlite.words"))),c=Object.keys(t).filter((e=>e.startsWith("database.sqlite.books"))),l=Object.keys(t).filter((e=>e.startsWith("database.sqlite.notes"))),d=Object.keys(t).filter((e=>e.startsWith("database.sqlite.bookmarks"))),u=Object.keys(t).filter((e=>e.startsWith("database.sqlite.plugins"))),h=Object.keys(t).filter((e=>e.startsWith("database.sqlite.words"))),p={books:Array.from(new Set(o.concat(c))),notes:Array.from(new Set(i.concat(l))),bookmarks:Array.from(new Set(n.concat(d))),plugins:Array.from(new Set(s.concat(u))),words:Array.from(new Set(a.concat(h)))},f={books:{save:[],update:[],delete:[],conflict:[],upload:[]},notes:{save:[],update:[],delete:[],conflict:[],upload:[]},bookmarks:{save:[],update:[],delete:[],conflict:[],upload:[]},plugins:{save:[],update:[],delete:[],conflict:[],upload:[]},words:{save:[],update:[],delete:[],conflict:[],upload:[]}},y=["books","notes","bookmarks","plugins","words"];for(let o of y)for(let i of p[o]){let n=i.split(".")[3],s=e[i],a=t[i];s?a?("save"===a.operation&&("update"===s.operation||"delete"===s.operation?f[o].upload.push(n):console.info("ignore",a)),"delete"===a.operation&&("save"===s.operation&&(f[o].delete.push(n),e[i]=a),"update"===s.operation&&(s.time<a.time?(f[o].delete.push(n),e[i]=a):s.time>a.time?(f[o].conflict.push(n),"cloud"===r?(f[o].delete.push(n),e[i]=a):f[o].upload.push(n)):console.info("ignore",a)),"delete"===s.operation&&console.info("ignore",a)),"update"===a.operation&&("save"===s.operation&&(f[o].update.push(n),e[i]=a),"update"===s.operation&&(s.time<a.time?(f[o].update.push(n),e[i]=a):s.time>a.time?f[o].upload.push(n):console.info("ignore",a)),"delete"===s.operation&&(s.time<a.time?(f[o].conflict.push(n),"cloud"===r?(f[o].save.push(n),e[i]=a):f[o].upload.push(n)):s.time>a.time?f[o].upload.push(n):console.info("ignore",a)))):f[o].upload.push(n):(f[o].save.push(n),e[i]=a)}return{compareResult:f,syncRecords:e}}))}static CompareConfig(e,t,r){return s(this,void 0,void 0,(function*(){let o=Object.keys(e).filter((e=>e.startsWith("config.readerConfig"))),i=Object.keys(e).filter((e=>e.startsWith("config.listConfig"))),n=Object.keys(e).filter((e=>e.startsWith("config.objectConfig"))),s=Object.keys(e).filter((e=>e.startsWith("config.mapConfig"))),a=Object.keys(t).filter((e=>e.startsWith("config.readerConfig"))),c=Object.keys(t).filter((e=>e.startsWith("config.listConfig"))),l=Object.keys(t).filter((e=>e.startsWith("config.objectConfig"))),d=Object.keys(t).filter((e=>e.startsWith("config.mapConfig"))),u={readerConfig:Array.from(new Set(o.concat(a))),listConfig:Array.from(new Set(i.concat(c))),objectConfig:Array.from(new Set(n.concat(l))),mapConfig:Array.from(new Set(s.concat(d)))},h={readerConfig:{update:[],upload:[]},listConfig:{update:[],upload:[]},objectConfig:{update:[],delete:[],conflict:[],upload:[]},mapConfig:{update:[],delete:[],conflict:[],upload:[]}},p=["readerConfig","listConfig"];for(let r of p)for(let o of u[r]){let i=o,n=e[o],s=t[o];n?s?n.time<s.time?(h[r].update.push(i),e[o]=s):n.time>s.time?h[r].upload.push(i):console.info("ignore",s):h[r].upload.push(i):(h[r].update.push(i),e[o]=s)}let f=["objectConfig","mapConfig"];for(let o of f)for(let i of u[o]){let n=i,s=e[i],a=t[i];s?a?("delete"===a.operation&&("update"===s.operation&&(s.time<a.time?(h[o].delete.push(n),e[i]=a):s.time>a.time?(h[o].conflict.push(n),"cloud"===r?(h[o].delete.push(n),e[i]=a):h[o].upload.push(n)):console.info("ignore",a)),"delete"===s.operation&&console.info("ignore",a)),"update"===a.operation&&("update"===s.operation&&(s.time<a.time?(h[o].update.push(n),e[i]=a):s.time>a.time?h[o].upload.push(n):console.info("ignore",a)),"delete"===s.operation&&(s.time<a.time?(h[o].conflict.push(n),"cloud"===r?(h[o].save.push(n),e[i]=a):h[o].upload.push(n)):s.time>a.time?h[o].upload.push(n):console.info("ignore",a)))):h[o].upload.push(n):(h[o].update.push(n),e[i]=a)}return{compareResult:h,syncRecords:e}}))}static compareAll(e,t,r,o,i){return s(this,void 0,void 0,(function*(){let n="cloud";if("yes"===r.getReaderConfig("isKeepLocal")){n="local";let e=r.getObjectConfig(yield o.getFingerprint(),"cloudSyncTime",{time:0,conflictMode:"cloud"}),t=yield i.getCloudConfig("config"),s=JSON.parse(t.cloudSyncTime||"{}");delete s[yield o.getFingerprint()],Object.values(s).filter((t=>"local"===t.conflictMode&&t.time>e.time)).length>0&&(n="cloud")}let{compareResult:s,syncRecords:a}=yield this.CompareDatabase(e,t,n),{compareResult:c,syncRecords:l}=yield this.CompareConfig(a,t,n),d=Object.assign(Object.assign({},s),c);return r.setAllSyncRecord(l),"local"===n&&(d.books.conflict.length>0||d.notes.conflict.length>0||d.bookmarks.conflict.length>0||d.plugins.conflict.length>0||d.words.conflict.length>0||d.objectConfig.conflict.length>0||d.mapConfig.conflict.length>0)?r.setObjectConfig(yield o.getFingerprint(),{time:(new Date).getTime(),conflictMode:"local"},"cloudSyncTime"):r.setObjectConfig(yield o.getFingerprint(),{time:(new Date).getTime(),conflictMode:"cloud"},"cloudSyncTime"),d}))}static startSync(e,t,r,o,i,n){return s(this,void 0,void 0,(function*(){yield this.syncConfig(e,t,r,i,o),yield this.syncCover(t,n,i),yield this.syncBook(t,i)}))}static syncConfig(e,t,r,o,i){return s(this,void 0,void 0,(function*(){for(let t of T){if(e[t].save.length+e[t].update.length>0){let o=yield i.getCloudDatabase(t);for(let i of e[t].save){let e=o.find((e=>e.key===i));e&&(yield r.saveRecord(e,t))}for(let i of e[t].update){let e=o.find((e=>e.key===i));e&&(yield r.updateRecord(e,t,!1))}}if(e[t].delete.length>0)for(let i of e[t].delete)yield r.deleteRecord(i,t),"books"===t&&(yield o.deleteOfflineBook(i))}if(e.readerConfig.update.length>0||e.listConfig.update.length>0||e.objectConfig.update.length>0||e.mapConfig.update.length>0){let r=yield i.getCloudConfig("config");for(let o of e.readerConfig.update){let e=o.split(".")[3];r.readerConfig&&t.setReaderConfig(e,JSON.parse(r.readerConfig)[e],!1)}for(let o of e.listConfig.update){let e=o.split(".")[3];r[e]&&t.setAllListConfig(JSON.parse(r[e]),e,!1)}for(let o of e.objectConfig.update){let e=o.split(".")[3],i=o.split(".")[2];r[i]&&JSON.parse(r[i])&&JSON.parse(r[i])[e]&&t.setObjectConfig(e,JSON.parse(r[i])[e],i,!1)}for(let o of e.mapConfig.update){let e=o.split(".")[3],i=o.split(".")[2];if(r[i]&&JSON.parse(r[i])&&JSON.parse(r[i])[e]){let o=JSON.parse(r[i])[e];t.setOneMapConfig(e,o,i,!1)}}}if(e.objectConfig.delete.length>0||e.mapConfig.delete.length>0){for(let r of e.objectConfig.delete){let e=r.split(".")[3],o=r.split(".")[2];t.deleteObjectConfig(e,o)}for(let r of e.mapConfig.delete){let e=r.split(".")[3],o=r.split(".")[2];t.deleteMapConfig(e,o)}}for(let t of T)e[t].upload.length>0&&(yield i.uploadDatabase(t));yield i.uploadConfig("config"),yield i.uploadConfig("sync")}))}static syncCover(e,t,r){return s(this,void 0,void 0,(function*(){let r=yield t.getLocalCoverList(),o=yield t.getCloudCoverList(),i=Array.from(new Set([...r,...o])),n=[];for(let s of i)r.includes(s)&&!o.includes(s)&&n.push((()=>t.uploadCover(s))),!r.includes(s)&&o.includes(s)&&"adrive"!==e.getItem("defaultSyncOption")&&n.push((()=>t.downloadCover(s)));yield ie(n,3,e.getItem("defaultSyncOption"))}))}static syncBook(e,t){return s(this,void 0,void 0,(function*(){let r=yield t.getLocalBookList(),o=yield t.getCloudBookList(),i=[],n=Array.from(new Set([...r,...o]));for(let s of n){if(r.includes(s)&&!o.includes(s)){let e=s.split(".")[0],r=s.split(".")[1];i.push((()=>t.uploadBook(e,r)))}let n="yes"===e.getReaderConfig("autoOffline");if(!r.includes(s)&&o.includes(s)&&n&&"adrive"!==e.getItem("defaultSyncOption")){let e=s.split(".")[0],r=s.split(".")[1];"pdf"===r&&i.push((()=>t.offlineBook(e,r.toUpperCase()))),"zip"===r&&i.push((()=>t.offlineBook(e.split("-")[1],r.toUpperCase())))}}yield ie(i,3,e.getItem("defaultSyncOption"))}))}}const se=(ae=class{static getItem(e){return localStorage.getItem(e)}static setItem(e,t){localStorage.setItem(e,t)}static removeItem(e){localStorage.removeItem(e)}},ce="browser",class extends ae{static getReaderConfig(e){return JSON.parse(this.getItem("readerConfig")||"{}")[e]}static setReaderConfig(e,t,r=!0){let o=JSON.parse(this.getItem("readerConfig")||"{}");o[e]=t,this.setItem("readerConfig",JSON.stringify(o)),r&&this.setSyncRecord({type:"config",catergory:"readerConfig",name:ce,key:e},{operation:"update",time:Date.now()})}static getAllListConfig(e){return("{}"!==this.getItem(e)&&this.getItem(e)?JSON.parse(this.getItem(e)||""):[])||[]}static deleteListConfig(e,t){let r=this.getAllListConfig(t);const o=r.indexOf(e);o>-1&&r.splice(o,1),this.setAllListConfig(r,t)}static setListConfig(e,t){let r=this.getAllListConfig(t);const o=r.indexOf(e);o>-1?(r.splice(o,1),r.unshift(e)):r.unshift(e),this.setAllListConfig(r,t)}static setAllListConfig(e,t,r=!0){this.setItem(t,JSON.stringify(e)),r&&this.setSyncRecord({type:"config",catergory:"listConfig",name:"general",key:t},{operation:"update",time:Date.now()})}static setObjectConfig(e,t,r,o=!0){let i=this.getAllObjectConfig(r);i[e]=t,o&&this.setSyncRecord({type:"config",catergory:"objectConfig",name:r,key:e},{operation:"update",time:Date.now()}),this.setAllObjectConfig(i,r)}static getObjectConfig(e,t,r){return this.getAllObjectConfig(t)[e]||r}static getAllObjectConfig(e){let t=this.getItem(e);return JSON.parse(t)||{}}static setAllObjectConfig(e,t){this.setItem(t,JSON.stringify(e))}static deleteObjectConfig(e,t){let r=this.getAllObjectConfig(t);delete r[e],this.setSyncRecord({type:"config",catergory:"objectConfig",name:t,key:e},{operation:"delete",time:Date.now()}),this.setAllObjectConfig(r,t)}static getAllMapConfig(e){let t=this.getItem(e);return JSON.parse(t)||{}}static getMapConfig(e,t){return this.getAllMapConfig(t)[e]||[]}static setAllMapConfig(e,t){this.setItem(t,JSON.stringify(e))}static setMapConfig(e,t,r){let o=this.getAllMapConfig(r);void 0===o[e]&&(o[e]=[]),t&&-1===o[e].indexOf(t)&&o[e].unshift(t),this.setSyncRecord({type:"config",catergory:"mapConfig",name:r,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(o,r)}static setOneMapConfig(e,t,r,o=!0){let i=this.getAllMapConfig(r);i[e]=t,o&&this.setSyncRecord({type:"config",catergory:"mapConfig",name:r,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(i,r)}static deleteFromMapConfig(e,t,r){let o=this.getAllMapConfig(r),i=o[e].indexOf(t);o[e].splice(i,1),this.setSyncRecord({type:"config",catergory:"mapConfig",name:r,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(o,r)}static deleteFromAllMapConfig(e,t){let r=this.getAllMapConfig(t);Object.keys(r).forEach((o=>{let i=r[o].indexOf(e);i>-1&&(r[o].splice(i,1),this.setSyncRecord({type:"config",catergory:"mapConfig",name:t,key:o},{operation:"update",time:Date.now()}))})),this.setAllMapConfig(r,t)}static deleteMapConfig(e,t){let r=this.getAllMapConfig(t);delete r[e],this.setSyncRecord({type:"config",catergory:"mapConfig",name:t,key:e},{operation:"delete",time:Date.now()}),this.setAllMapConfig(r,t)}static getFromAllMapConfig(e,t){let r=this.getAllMapConfig(t),o=[];for(let t in r)r[t]&&r[t].indexOf(e)>-1&&o.push(t);return o}static getSyncRecord(e){return JSON.parse(this.getItem("syncRecord")||"{}")[e.type+"."+e.catergory+"."+e.name+"."+e.key]||{operation:"",time:0}}static getAllSyncRecord(){return JSON.parse(this.getItem("syncRecord")||"{}")}static setSyncRecord(e,t){let r=JSON.parse(this.getItem("syncRecord")||"{}");r[e.type+"."+e.catergory+"."+e.name+"."+e.key]=t,this.setItem("syncRecord",JSON.stringify(r))}static setAllSyncRecord(e){this.setItem("syncRecord",JSON.stringify(e))}});var ae,ce;let le;const de=new Uint8Array(16);function ue(){if(!le&&(le="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!le))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return le(de)}const he=[];for(let e=0;e<256;++e)he.push((e+256).toString(16).slice(1));var pe={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function fe(e,t,r){if(pe.randomUUID&&!t&&!e)return pe.randomUUID();const o=(e=e||{}).random||(e.rng||ue)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=o[e];return t}return function(e,t=0){return he[e[t+0]]+he[e[t+1]]+he[e[t+2]]+he[e[t+3]]+"-"+he[e[t+4]]+he[e[t+5]]+"-"+he[e[t+6]]+he[e[t+7]]+"-"+he[e[t+8]]+he[e[t+9]]+"-"+he[e[t+10]]+he[e[t+11]]+he[e[t+12]]+he[e[t+13]]+he[e[t+14]]+he[e[t+15]]}(o)}class ye{static saveAllToken(e){return s(this,void 0,void 0,(function*(){if(e)if(n){const{ipcRenderer:t}=window.require("electron");t.invoke("encrypt-data",{token:e})}else{const t=yield this.encryptString(e);localStorage.setItem("encryptedToken",t)}}))}static getAllToken(){return s(this,void 0,void 0,(function*(){if(n){const{ipcRenderer:e}=window.require("electron");return yield e.invoke("decrypt-data")}{let e=localStorage.getItem("encryptedToken")||"";return e?yield this.decryptString(e):null}}))}static setToken(e,t){return s(this,void 0,void 0,(function*(){const r=JSON.parse((yield this.getAllToken())||"{}");r[e]=t,yield this.saveAllToken(JSON.stringify(r))}))}static getToken(e){return s(this,void 0,void 0,(function*(){return JSON.parse((yield this.getAllToken())||"{}")[e]||null}))}static deleteToken(e){return s(this,void 0,void 0,(function*(){const t=JSON.parse((yield this.getAllToken())||"{}");delete t[e],yield this.saveAllToken(JSON.stringify(t))}))}static encryptString(e){return s(this,void 0,void 0,(function*(){try{let t=yield this.getFingerprint();const r=yield ve(t),o=yield function(e,t,r={alg:"HS256",typ:"JWT"}){return s(this,void 0,void 0,(function*(){const o=ge((new TextEncoder).encode(JSON.stringify(r))),i=ge((new TextEncoder).encode(JSON.stringify(e))),n=(new TextEncoder).encode(`${o}.${i}`),s=yield crypto.subtle.importKey("raw",(new TextEncoder).encode(t),{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]);return`${o}.${i}.${ge(yield crypto.subtle.sign("HMAC",s,n))}`}))}(e,r);return o}catch(e){return console.error("Error generating secret:",e),""}}))}static decryptString(e){return s(this,void 0,void 0,(function*(){try{let t=yield this.getFingerprint();const r=yield ve(t),o=yield function(e,t){return s(this,void 0,void 0,(function*(){const[r,o,i]=e.split("."),n=(new TextEncoder).encode(`${r}.${o}`),s=yield me(i),a=yield crypto.subtle.importKey("raw",(new TextEncoder).encode(t),{name:"HMAC",hash:{name:"SHA-256"}},!1,["verify"]);if(!(yield crypto.subtle.verify("HMAC",a,s,n)))throw new Error("Invalid signature");return JSON.parse((new TextDecoder).decode(me(o)))}))}(e,r);return o}catch(e){return console.error("Error generating secret:",e),""}}))}static oldDecryptString(e){return s(this,void 0,void 0,(function*(){let t=yield this.getFingerprint();const r=yield crypto.subtle.digest("SHA-256",(new TextEncoder).encode(t)),o=yield crypto.subtle.importKey("raw",r,{name:"AES-GCM",length:256},!1,["decrypt"]),i=new Uint8Array(e.split("").map((e=>e.charCodeAt(0)))),n=i.slice(0,12),s=i.slice(12),a=yield crypto.subtle.decrypt({name:"AES-GCM",iv:n},o,s);return(new TextDecoder).decode(a)}))}static getFingerprint(){return s(this,void 0,void 0,(function*(){if(n){const{ipcRenderer:e}=window.require("electron");return yield e.invoke("get-mac")}{let e=se.getItem("fingerPrint");if(e)return e;let t=fe().replace(/-/g,"");return se.setItem("fingerPrint",t),t}}))}}function ge(e){return btoa(String.fromCharCode.apply(null,Array.from(new Uint8Array(e)))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function me(e){const t=e.replace(/-/g,"+").replace(/_/g,"/"),r=atob(t),o=new Uint8Array(r.length);for(let e=0;e<r.length;e++)o[e]=r.charCodeAt(e);return o}function ve(e){return s(this,void 0,void 0,(function*(){const t=(new TextEncoder).encode(e);return function(e){let t="";const r=new Uint8Array(e);for(let e=0;e<r.byteLength;e++)t+=String.fromCharCode(r[e]);return btoa(t)}(yield crypto.subtle.digest("SHA-256",t))}))}var ke="1.13.7",be="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||Function("return this")()||{},we=Array.prototype,Te=Object.prototype,Ce="undefined"!=typeof Symbol?Symbol.prototype:null,Ee=we.push,xe=we.slice,_e=Te.toString,Se=Te.hasOwnProperty,Re="undefined"!=typeof ArrayBuffer,Oe="undefined"!=typeof DataView,Ae=Array.isArray,Ie=Object.keys,Fe=Object.create,Le=Re&&ArrayBuffer.isView,je=isNaN,Me=isFinite,Be=!{toString:null}.propertyIsEnumerable("toString"),Pe=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],qe=Math.pow(2,53)-1;function ze(e,t){return t=null==t?e.length-1:+t,function(){for(var r=Math.max(arguments.length-t,0),o=Array(r),i=0;i<r;i++)o[i]=arguments[i+t];switch(t){case 0:return e.call(this,o);case 1:return e.call(this,arguments[0],o);case 2:return e.call(this,arguments[0],arguments[1],o)}var n=Array(t+1);for(i=0;i<t;i++)n[i]=arguments[i];return n[t]=o,e.apply(this,n)}}function Ne(e){var t=typeof e;return"function"===t||"object"===t&&!!e}function De(e){return void 0===e}function $e(e){return!0===e||!1===e||"[object Boolean]"===_e.call(e)}function Ue(e){var t="[object "+e+"]";return function(e){return _e.call(e)===t}}var We=Ue("String"),Ke=Ue("Number"),Je=Ue("Date"),Qe=Ue("RegExp"),He=Ue("Error"),Ve=Ue("Symbol"),Xe=Ue("ArrayBuffer"),Ye=Ue("Function"),Ge=be.document&&be.document.childNodes;"function"!=typeof/./&&"object"!=typeof Int8Array&&"function"!=typeof Ge&&(Ye=function(e){return"function"==typeof e||!1});var Ze=Ye,et=Ue("Object"),tt=Oe&&(!/\[native code\]/.test(String(DataView))||et(new DataView(new ArrayBuffer(8)))),rt="undefined"!=typeof Map&&et(new Map),ot=Ue("DataView");var it=tt?function(e){return null!=e&&Ze(e.getInt8)&&Xe(e.buffer)}:ot,nt=Ae||Ue("Array");function st(e,t){return null!=e&&Se.call(e,t)}var at=Ue("Arguments");!function(){at(arguments)||(at=function(e){return st(e,"callee")})}();var ct=at;function lt(e){return Ke(e)&&je(e)}function dt(e){return function(){return e}}function ut(e){return function(t){var r=e(t);return"number"==typeof r&&r>=0&&r<=qe}}function ht(e){return function(t){return null==t?void 0:t[e]}}var pt=ht("byteLength"),ft=ut(pt),yt=/\[object ((I|Ui)nt(8|16|32)|Float(32|64)|Uint8Clamped|Big(I|Ui)nt64)Array\]/;var gt=Re?function(e){return Le?Le(e)&&!it(e):ft(e)&&yt.test(_e.call(e))}:dt(!1),mt=ht("length");function vt(e,t){t=function(e){for(var t={},r=e.length,o=0;o<r;++o)t[e[o]]=!0;return{contains:function(e){return!0===t[e]},push:function(r){return t[r]=!0,e.push(r)}}}(t);var r=Pe.length,o=e.constructor,i=Ze(o)&&o.prototype||Te,n="constructor";for(st(e,n)&&!t.contains(n)&&t.push(n);r--;)(n=Pe[r])in e&&e[n]!==i[n]&&!t.contains(n)&&t.push(n)}function kt(e){if(!Ne(e))return[];if(Ie)return Ie(e);var t=[];for(var r in e)st(e,r)&&t.push(r);return Be&&vt(e,t),t}function bt(e,t){var r=kt(t),o=r.length;if(null==e)return!o;for(var i=Object(e),n=0;n<o;n++){var s=r[n];if(t[s]!==i[s]||!(s in i))return!1}return!0}function wt(e){return e instanceof wt?e:this instanceof wt?void(this._wrapped=e):new wt(e)}function Tt(e){return new Uint8Array(e.buffer||e,e.byteOffset||0,pt(e))}wt.VERSION=ke,wt.prototype.value=function(){return this._wrapped},wt.prototype.valueOf=wt.prototype.toJSON=wt.prototype.value,wt.prototype.toString=function(){return String(this._wrapped)};var Ct="[object DataView]";function Et(e,t,r,o){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return!1;if(e!=e)return t!=t;var i=typeof e;return("function"===i||"object"===i||"object"==typeof t)&&xt(e,t,r,o)}function xt(e,t,r,o){e instanceof wt&&(e=e._wrapped),t instanceof wt&&(t=t._wrapped);var i=_e.call(e);if(i!==_e.call(t))return!1;if(tt&&"[object Object]"==i&&it(e)){if(!it(t))return!1;i=Ct}switch(i){case"[object RegExp]":case"[object String]":return""+e==""+t;case"[object Number]":return+e!=+e?+t!=+t:0==+e?1/+e==1/t:+e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object Symbol]":return Ce.valueOf.call(e)===Ce.valueOf.call(t);case"[object ArrayBuffer]":case Ct:return xt(Tt(e),Tt(t),r,o)}var n="[object Array]"===i;if(!n&&gt(e)){if(pt(e)!==pt(t))return!1;if(e.buffer===t.buffer&&e.byteOffset===t.byteOffset)return!0;n=!0}if(!n){if("object"!=typeof e||"object"!=typeof t)return!1;var s=e.constructor,a=t.constructor;if(s!==a&&!(Ze(s)&&s instanceof s&&Ze(a)&&a instanceof a)&&"constructor"in e&&"constructor"in t)return!1}o=o||[];for(var c=(r=r||[]).length;c--;)if(r[c]===e)return o[c]===t;if(r.push(e),o.push(t),n){if((c=e.length)!==t.length)return!1;for(;c--;)if(!Et(e[c],t[c],r,o))return!1}else{var l,d=kt(e);if(c=d.length,kt(t).length!==c)return!1;for(;c--;)if(!st(t,l=d[c])||!Et(e[l],t[l],r,o))return!1}return r.pop(),o.pop(),!0}function _t(e){if(!Ne(e))return[];var t=[];for(var r in e)t.push(r);return Be&&vt(e,t),t}function St(e){var t=mt(e);return function(r){if(null==r)return!1;var o=_t(r);if(mt(o))return!1;for(var i=0;i<t;i++)if(!Ze(r[e[i]]))return!1;return e!==Ft||!Ze(r[Rt])}}var Rt="forEach",Ot=["clear","delete"],At=["get","has","set"],It=Ot.concat(Rt,At),Ft=Ot.concat(At),Lt=["add"].concat(Ot,Rt,"has"),jt=rt?St(It):Ue("Map"),Mt=rt?St(Ft):Ue("WeakMap"),Bt=rt?St(Lt):Ue("Set"),Pt=Ue("WeakSet");function qt(e){for(var t=kt(e),r=t.length,o=Array(r),i=0;i<r;i++)o[i]=e[t[i]];return o}function zt(e){for(var t={},r=kt(e),o=0,i=r.length;o<i;o++)t[e[r[o]]]=r[o];return t}function Nt(e){var t=[];for(var r in e)Ze(e[r])&&t.push(r);return t.sort()}function Dt(e,t){return function(r){var o=arguments.length;if(t&&(r=Object(r)),o<2||null==r)return r;for(var i=1;i<o;i++)for(var n=arguments[i],s=e(n),a=s.length,c=0;c<a;c++){var l=s[c];t&&void 0!==r[l]||(r[l]=n[l])}return r}}var $t=Dt(_t),Ut=Dt(kt),Wt=Dt(_t,!0);function Kt(e){if(!Ne(e))return{};if(Fe)return Fe(e);var t=function(){};t.prototype=e;var r=new t;return t.prototype=null,r}function Jt(e){return nt(e)?e:[e]}function Qt(e){return wt.toPath(e)}function Ht(e,t){for(var r=t.length,o=0;o<r;o++){if(null==e)return;e=e[t[o]]}return r?e:void 0}function Vt(e,t,r){var o=Ht(e,Qt(t));return De(o)?r:o}function Xt(e){return e}function Yt(e){return e=Ut({},e),function(t){return bt(t,e)}}function Gt(e){return e=Qt(e),function(t){return Ht(t,e)}}function Zt(e,t,r){if(void 0===t)return e;switch(null==r?3:r){case 1:return function(r){return e.call(t,r)};case 3:return function(r,o,i){return e.call(t,r,o,i)};case 4:return function(r,o,i,n){return e.call(t,r,o,i,n)}}return function(){return e.apply(t,arguments)}}function er(e,t,r){return null==e?Xt:Ze(e)?Zt(e,t,r):Ne(e)&&!nt(e)?Yt(e):Gt(e)}function tr(e,t){return er(e,t,1/0)}function rr(e,t,r){return wt.iteratee!==tr?wt.iteratee(e,t):er(e,t,r)}function or(){}function ir(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))}wt.toPath=Jt,wt.iteratee=tr;var nr=Date.now||function(){return(new Date).getTime()};function sr(e){var t=function(t){return e[t]},r="(?:"+kt(e).join("|")+")",o=RegExp(r),i=RegExp(r,"g");return function(e){return e=null==e?"":""+e,o.test(e)?e.replace(i,t):e}}var ar={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},cr=sr(ar),lr=sr(zt(ar)),dr=wt.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},ur=/(.)^/,hr={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},pr=/\\|'|\r|\n|\u2028|\u2029/g;function fr(e){return"\\"+hr[e]}var yr=/^\s*(\w|\$)+\s*$/;var gr=0;function mr(e,t,r,o,i){if(!(o instanceof t))return e.apply(r,i);var n=Kt(e.prototype),s=e.apply(n,i);return Ne(s)?s:n}var vr=ze((function(e,t){var r=vr.placeholder,o=function(){for(var i=0,n=t.length,s=Array(n),a=0;a<n;a++)s[a]=t[a]===r?arguments[i++]:t[a];for(;i<arguments.length;)s.push(arguments[i++]);return mr(e,o,this,this,s)};return o}));vr.placeholder=wt;var kr=ze((function(e,t,r){if(!Ze(e))throw new TypeError("Bind must be called on a function");var o=ze((function(i){return mr(e,o,t,this,r.concat(i))}));return o})),br=ut(mt);function wr(e,t,r,o){if(o=o||[],t||0===t){if(t<=0)return o.concat(e)}else t=1/0;for(var i=o.length,n=0,s=mt(e);n<s;n++){var a=e[n];if(br(a)&&(nt(a)||ct(a)))if(t>1)wr(a,t-1,r,o),i=o.length;else for(var c=0,l=a.length;c<l;)o[i++]=a[c++];else r||(o[i++]=a)}return o}var Tr=ze((function(e,t){var r=(t=wr(t,!1,!1)).length;if(r<1)throw new Error("bindAll must be passed function names");for(;r--;){var o=t[r];e[o]=kr(e[o],e)}return e}));var Cr=ze((function(e,t,r){return setTimeout((function(){return e.apply(null,r)}),t)})),Er=vr(Cr,wt,1);function xr(e){return function(){return!e.apply(this,arguments)}}function _r(e,t){var r;return function(){return--e>0&&(r=t.apply(this,arguments)),e<=1&&(t=null),r}}var Sr=vr(_r,2);function Rr(e,t,r){t=rr(t,r);for(var o,i=kt(e),n=0,s=i.length;n<s;n++)if(t(e[o=i[n]],o,e))return o}function Or(e){return function(t,r,o){r=rr(r,o);for(var i=mt(t),n=e>0?0:i-1;n>=0&&n<i;n+=e)if(r(t[n],n,t))return n;return-1}}var Ar=Or(1),Ir=Or(-1);function Fr(e,t,r,o){for(var i=(r=rr(r,o,1))(t),n=0,s=mt(e);n<s;){var a=Math.floor((n+s)/2);r(e[a])<i?n=a+1:s=a}return n}function Lr(e,t,r){return function(o,i,n){var s=0,a=mt(o);if("number"==typeof n)e>0?s=n>=0?n:Math.max(n+a,s):a=n>=0?Math.min(n+1,a):n+a+1;else if(r&&n&&a)return o[n=r(o,i)]===i?n:-1;if(i!=i)return(n=t(xe.call(o,s,a),lt))>=0?n+s:-1;for(n=e>0?s:a-1;n>=0&&n<a;n+=e)if(o[n]===i)return n;return-1}}var jr=Lr(1,Ar,Fr),Mr=Lr(-1,Ir);function Br(e,t,r){var o=(br(e)?Ar:Rr)(e,t,r);if(void 0!==o&&-1!==o)return e[o]}function Pr(e,t,r){var o,i;if(t=Zt(t,r),br(e))for(o=0,i=e.length;o<i;o++)t(e[o],o,e);else{var n=kt(e);for(o=0,i=n.length;o<i;o++)t(e[n[o]],n[o],e)}return e}function qr(e,t,r){t=rr(t,r);for(var o=!br(e)&&kt(e),i=(o||e).length,n=Array(i),s=0;s<i;s++){var a=o?o[s]:s;n[s]=t(e[a],a,e)}return n}function zr(e){return function(t,r,o,i){var n=arguments.length>=3;return function(t,r,o,i){var n=!br(t)&&kt(t),s=(n||t).length,a=e>0?0:s-1;for(i||(o=t[n?n[a]:a],a+=e);a>=0&&a<s;a+=e){var c=n?n[a]:a;o=r(o,t[c],c,t)}return o}(t,Zt(r,i,4),o,n)}}var Nr=zr(1),Dr=zr(-1);function $r(e,t,r){var o=[];return t=rr(t,r),Pr(e,(function(e,r,i){t(e,r,i)&&o.push(e)})),o}function Ur(e,t,r){t=rr(t,r);for(var o=!br(e)&&kt(e),i=(o||e).length,n=0;n<i;n++){var s=o?o[n]:n;if(!t(e[s],s,e))return!1}return!0}function Wr(e,t,r){t=rr(t,r);for(var o=!br(e)&&kt(e),i=(o||e).length,n=0;n<i;n++){var s=o?o[n]:n;if(t(e[s],s,e))return!0}return!1}function Kr(e,t,r,o){return br(e)||(e=qt(e)),("number"!=typeof r||o)&&(r=0),jr(e,t,r)>=0}var Jr=ze((function(e,t,r){var o,i;return Ze(t)?i=t:(t=Qt(t),o=t.slice(0,-1),t=t[t.length-1]),qr(e,(function(e){var n=i;if(!n){if(o&&o.length&&(e=Ht(e,o)),null==e)return;n=e[t]}return null==n?n:n.apply(e,r)}))}));function Qr(e,t){return qr(e,Gt(t))}function Hr(e,t,r){var o,i,n=-1/0,s=-1/0;if(null==t||"number"==typeof t&&"object"!=typeof e[0]&&null!=e)for(var a=0,c=(e=br(e)?e:qt(e)).length;a<c;a++)null!=(o=e[a])&&o>n&&(n=o);else t=rr(t,r),Pr(e,(function(e,r,o){((i=t(e,r,o))>s||i===-1/0&&n===-1/0)&&(n=e,s=i)}));return n}var Vr=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;function Xr(e){return e?nt(e)?xe.call(e):We(e)?e.match(Vr):br(e)?qr(e,Xt):qt(e):[]}function Yr(e,t,r){if(null==t||r)return br(e)||(e=qt(e)),e[ir(e.length-1)];var o=Xr(e),i=mt(o);t=Math.max(Math.min(t,i),0);for(var n=i-1,s=0;s<t;s++){var a=ir(s,n),c=o[s];o[s]=o[a],o[a]=c}return o.slice(0,t)}function Gr(e,t){return function(r,o,i){var n=t?[[],[]]:{};return o=rr(o,i),Pr(r,(function(t,i){var s=o(t,i,r);e(n,t,s)})),n}}var Zr=Gr((function(e,t,r){st(e,r)?e[r].push(t):e[r]=[t]})),eo=Gr((function(e,t,r){e[r]=t})),to=Gr((function(e,t,r){st(e,r)?e[r]++:e[r]=1})),ro=Gr((function(e,t,r){e[r?0:1].push(t)}),!0);function oo(e,t,r){return t in r}var io=ze((function(e,t){var r={},o=t[0];if(null==e)return r;Ze(o)?(t.length>1&&(o=Zt(o,t[1])),t=_t(e)):(o=oo,t=wr(t,!1,!1),e=Object(e));for(var i=0,n=t.length;i<n;i++){var s=t[i],a=e[s];o(a,s,e)&&(r[s]=a)}return r})),no=ze((function(e,t){var r,o=t[0];return Ze(o)?(o=xr(o),t.length>1&&(r=t[1])):(t=qr(wr(t,!1,!1),String),o=function(e,r){return!Kr(t,r)}),io(e,o,r)}));function so(e,t,r){return xe.call(e,0,Math.max(0,e.length-(null==t||r?1:t)))}function ao(e,t,r){return null==e||e.length<1?null==t||r?void 0:[]:null==t||r?e[0]:so(e,e.length-t)}function co(e,t,r){return xe.call(e,null==t||r?1:t)}var lo=ze((function(e,t){return t=wr(t,!0,!0),$r(e,(function(e){return!Kr(t,e)}))})),uo=ze((function(e,t){return lo(e,t)}));function ho(e,t,r,o){$e(t)||(o=r,r=t,t=!1),null!=r&&(r=rr(r,o));for(var i=[],n=[],s=0,a=mt(e);s<a;s++){var c=e[s],l=r?r(c,s,e):c;t&&!r?(s&&n===l||i.push(c),n=l):r?Kr(n,l)||(n.push(l),i.push(c)):Kr(i,c)||i.push(c)}return i}var po=ze((function(e){return ho(wr(e,!0,!0))}));function fo(e){for(var t=e&&Hr(e,mt).length||0,r=Array(t),o=0;o<t;o++)r[o]=Qr(e,o);return r}var yo=ze(fo);function go(e,t){return e._chain?wt(t).chain():t}function mo(e){return Pr(Nt(e),(function(t){var r=wt[t]=e[t];wt.prototype[t]=function(){var e=[this._wrapped];return Ee.apply(e,arguments),go(this,r.apply(wt,e))}})),wt}Pr(["pop","push","reverse","shift","sort","splice","unshift"],(function(e){var t=we[e];wt.prototype[e]=function(){var r=this._wrapped;return null!=r&&(t.apply(r,arguments),"shift"!==e&&"splice"!==e||0!==r.length||delete r[0]),go(this,r)}})),Pr(["concat","join","slice"],(function(e){var t=we[e];wt.prototype[e]=function(){var e=this._wrapped;return null!=e&&(e=t.apply(e,arguments)),go(this,e)}}));var vo=Object.freeze({__proto__:null,VERSION:ke,restArguments:ze,isObject:Ne,isNull:function(e){return null===e},isUndefined:De,isBoolean:$e,isElement:function(e){return!(!e||1!==e.nodeType)},isString:We,isNumber:Ke,isDate:Je,isRegExp:Qe,isError:He,isSymbol:Ve,isArrayBuffer:Xe,isDataView:it,isArray:nt,isFunction:Ze,isArguments:ct,isFinite:function(e){return!Ve(e)&&Me(e)&&!isNaN(parseFloat(e))},isNaN:lt,isTypedArray:gt,isEmpty:function(e){if(null==e)return!0;var t=mt(e);return"number"==typeof t&&(nt(e)||We(e)||ct(e))?0===t:0===mt(kt(e))},isMatch:bt,isEqual:function(e,t){return Et(e,t)},isMap:jt,isWeakMap:Mt,isSet:Bt,isWeakSet:Pt,keys:kt,allKeys:_t,values:qt,pairs:function(e){for(var t=kt(e),r=t.length,o=Array(r),i=0;i<r;i++)o[i]=[t[i],e[t[i]]];return o},invert:zt,functions:Nt,methods:Nt,extend:$t,extendOwn:Ut,assign:Ut,defaults:Wt,create:function(e,t){var r=Kt(e);return t&&Ut(r,t),r},clone:function(e){return Ne(e)?nt(e)?e.slice():$t({},e):e},tap:function(e,t){return t(e),e},get:Vt,has:function(e,t){for(var r=(t=Qt(t)).length,o=0;o<r;o++){var i=t[o];if(!st(e,i))return!1;e=e[i]}return!!r},mapObject:function(e,t,r){t=rr(t,r);for(var o=kt(e),i=o.length,n={},s=0;s<i;s++){var a=o[s];n[a]=t(e[a],a,e)}return n},identity:Xt,constant:dt,noop:or,toPath:Jt,property:Gt,propertyOf:function(e){return null==e?or:function(t){return Vt(e,t)}},matcher:Yt,matches:Yt,times:function(e,t,r){var o=Array(Math.max(0,e));t=Zt(t,r,1);for(var i=0;i<e;i++)o[i]=t(i);return o},random:ir,now:nr,escape:cr,unescape:lr,templateSettings:dr,template:function(e,t,r){!t&&r&&(t=r),t=Wt({},t,wt.templateSettings);var o=RegExp([(t.escape||ur).source,(t.interpolate||ur).source,(t.evaluate||ur).source].join("|")+"|$","g"),i=0,n="__p+='";e.replace(o,(function(t,r,o,s,a){return n+=e.slice(i,a).replace(pr,fr),i=a+t.length,r?n+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'":o?n+="'+\n((__t=("+o+"))==null?'':__t)+\n'":s&&(n+="';\n"+s+"\n__p+='"),t})),n+="';\n";var s,a=t.variable;if(a){if(!yr.test(a))throw new Error("variable is not a bare identifier: "+a)}else n="with(obj||{}){\n"+n+"}\n",a="obj";n="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+n+"return __p;\n";try{s=new Function(a,"_",n)}catch(e){throw e.source=n,e}var c=function(e){return s.call(this,e,wt)};return c.source="function("+a+"){\n"+n+"}",c},result:function(e,t,r){var o=(t=Qt(t)).length;if(!o)return Ze(r)?r.call(e):r;for(var i=0;i<o;i++){var n=null==e?void 0:e[t[i]];void 0===n&&(n=r,i=o),e=Ze(n)?n.call(e):n}return e},uniqueId:function(e){var t=++gr+"";return e?e+t:t},chain:function(e){var t=wt(e);return t._chain=!0,t},iteratee:tr,partial:vr,bind:kr,bindAll:Tr,memoize:function(e,t){var r=function(o){var i=r.cache,n=""+(t?t.apply(this,arguments):o);return st(i,n)||(i[n]=e.apply(this,arguments)),i[n]};return r.cache={},r},delay:Cr,defer:Er,throttle:function(e,t,r){var o,i,n,s,a=0;r||(r={});var c=function(){a=!1===r.leading?0:nr(),o=null,s=e.apply(i,n),o||(i=n=null)},l=function(){var l=nr();a||!1!==r.leading||(a=l);var d=t-(l-a);return i=this,n=arguments,d<=0||d>t?(o&&(clearTimeout(o),o=null),a=l,s=e.apply(i,n),o||(i=n=null)):o||!1===r.trailing||(o=setTimeout(c,d)),s};return l.cancel=function(){clearTimeout(o),a=0,o=i=n=null},l},debounce:function(e,t,r){var o,i,n,s,a,c=function(){var l=nr()-i;t>l?o=setTimeout(c,t-l):(o=null,r||(s=e.apply(a,n)),o||(n=a=null))},l=ze((function(l){return a=this,n=l,i=nr(),o||(o=setTimeout(c,t),r&&(s=e.apply(a,n))),s}));return l.cancel=function(){clearTimeout(o),o=n=a=null},l},wrap:function(e,t){return vr(t,e)},negate:xr,compose:function(){var e=arguments,t=e.length-1;return function(){for(var r=t,o=e[t].apply(this,arguments);r--;)o=e[r].call(this,o);return o}},after:function(e,t){return function(){if(--e<1)return t.apply(this,arguments)}},before:_r,once:Sr,findKey:Rr,findIndex:Ar,findLastIndex:Ir,sortedIndex:Fr,indexOf:jr,lastIndexOf:Mr,find:Br,detect:Br,findWhere:function(e,t){return Br(e,Yt(t))},each:Pr,forEach:Pr,map:qr,collect:qr,reduce:Nr,foldl:Nr,inject:Nr,reduceRight:Dr,foldr:Dr,filter:$r,select:$r,reject:function(e,t,r){return $r(e,xr(rr(t)),r)},every:Ur,all:Ur,some:Wr,any:Wr,contains:Kr,includes:Kr,include:Kr,invoke:Jr,pluck:Qr,where:function(e,t){return $r(e,Yt(t))},max:Hr,min:function(e,t,r){var o,i,n=1/0,s=1/0;if(null==t||"number"==typeof t&&"object"!=typeof e[0]&&null!=e)for(var a=0,c=(e=br(e)?e:qt(e)).length;a<c;a++)null!=(o=e[a])&&o<n&&(n=o);else t=rr(t,r),Pr(e,(function(e,r,o){((i=t(e,r,o))<s||i===1/0&&n===1/0)&&(n=e,s=i)}));return n},shuffle:function(e){return Yr(e,1/0)},sample:Yr,sortBy:function(e,t,r){var o=0;return t=rr(t,r),Qr(qr(e,(function(e,r,i){return{value:e,index:o++,criteria:t(e,r,i)}})).sort((function(e,t){var r=e.criteria,o=t.criteria;if(r!==o){if(r>o||void 0===r)return 1;if(r<o||void 0===o)return-1}return e.index-t.index})),"value")},groupBy:Zr,indexBy:eo,countBy:to,partition:ro,toArray:Xr,size:function(e){return null==e?0:br(e)?e.length:kt(e).length},pick:io,omit:no,first:ao,head:ao,take:ao,initial:so,last:function(e,t,r){return null==e||e.length<1?null==t||r?void 0:[]:null==t||r?e[e.length-1]:co(e,Math.max(0,e.length-t))},rest:co,tail:co,drop:co,compact:function(e){return $r(e,Boolean)},flatten:function(e,t){return wr(e,t,!1)},without:uo,uniq:ho,unique:ho,union:po,intersection:function(e){for(var t=[],r=arguments.length,o=0,i=mt(e);o<i;o++){var n=e[o];if(!Kr(t,n)){var s;for(s=1;s<r&&Kr(arguments[s],n);s++);s===r&&t.push(n)}}return t},difference:lo,unzip:fo,transpose:fo,zip:yo,object:function(e,t){for(var r={},o=0,i=mt(e);o<i;o++)t?r[e[o]]=t[o]:r[e[o][0]]=e[o][1];return r},range:function(e,t,r){null==t&&(t=e||0,e=0),r||(r=t<e?-1:1);for(var o=Math.max(Math.ceil((t-e)/r),0),i=Array(o),n=0;n<o;n++,e+=r)i[n]=e;return i},chunk:function(e,t){if(null==t||t<1)return[];for(var r=[],o=0,i=e.length;o<i;)r.push(xe.call(e,o,o+=t));return r},mixin:mo,default:wt}),ko=mo(vo);ko._=ko;const bo=e=>e.map((e=>e.name)),wo=e=>e.map((e=>e.key)),To=(e,t)=>{let r=[];for(let o=0;o<e.length;o++)t.indexOf(e[o])>-1&&r.push(t.indexOf(e[o]));return r.length<t.length&&t.forEach((o=>{if(-1===e.indexOf(o))for(let e=0;e<t.length;e++)if(-1===r.indexOf(e)){r.push(e);break}})),[...new Set(r.map((e=>e-Math.min(...r))))]};class Co{static sortBooks(e,t,r){let o=e.map((e=>e.key)),i=(e=>e.getAllListConfig("recentBooks"))(r);if(1===t.sort||0===t.sort)return 1===t.order?To(i,o).reverse():To(i,o);if(2===t.sort){let r=bo(e),o=bo(e).sort();return 1===t.order?To(o,r).reverse():To(o,r)}if(3===t.sort){let r=[];for(let t=0;t<e.length;t++)r.push(t);return 1===t.order?r.reverse():r}if(4===t.sort){let o=(e=>{let t=e.getAllObjectConfig("readingTime");var r=[];for(let e in t)r.push([e,t[e]]);return r.sort((function(e,t){return e[1]-t[1]})),Object.keys(t)})(r),i=wo(e);return 1===t.order?To(ko.union(o,i),i).reverse():To(ko.union(o,i),i)}if(5===t.sort){let r=wo(e),o=(e=>ko.sortBy(e.map((e=>({key:e.key,author:e.author}))),"author").map((e=>e.key)))(e);return 1===t.order?To(o,r).reverse():To(o,r)}if(6===t.sort){let o=(e=>{let t=e.getAllObjectConfig("recordLocation");var r=[];for(let e in t)r.push([e,t[e].percentage||0]);return r.sort((function(e,t){return e[1]-t[1]})),r.map((e=>e[0]))})(r),i=wo(e);return 1===t.order?To(o,i).reverse():To(o,i)}}static sortNotes(e,t,r=[]){if(3===t.sort){let r=ko.clone(e).reverse(),o=ko.uniq(e.map((e=>({chapter:e.chapter,chapterIndex:e.chapterIndex}))));o=1===t.order?ko.sortBy(o,"chapterIndex"):ko.sortBy(o,"chapterIndex").reverse();let i=ko.uniq(o.map((e=>e.chapter))),n={};return i.forEach((e=>{n[e]=[]})),r.forEach((e=>{n[e.chapter].push(e)})),i.map((e=>({group:e,notes:n[e]})))||[]}if(2===t.sort){let r=ko.clone(e).reverse(),o=ko.uniq(e.map((e=>e.date.year+"-"+e.date.month+"-"+e.date.day)));1===t.order?o.sort():o.sort().reverse();let i={};return o.forEach((e=>{i[e]=[]})),r.forEach((e=>{o.forEach((t=>{t===e.date.year+"-"+e.date.month+"-"+e.date.day&&i[t].push(e)}))})),i||{}}if(1===t.sort){let o=ko.clone(e).reverse(),i=ko.uniq(e.map((e=>{let t=ko.findLastIndex(r,{key:e.bookKey});return t>-1?r[t].name:""})));1===t.order?i.sort():i.sort().reverse();let n={};return i.forEach((e=>{n[e]=[]})),o.forEach((e=>{i.forEach((t=>{let o=ko.findLastIndex(r,{key:e.bookKey});o>-1&&t===r[o].name&&n[t].push(e)}))})),n||{}}}static sortBookmarks(e,t){if(3===t.sort){let r=ko.clone(e).reverse(),o=ko.uniq(e.map((e=>({chapter:e.chapter,chapterIndex:parseInt(JSON.parse(e.cfi).chapterDocIndex)}))));o=1===t.order?ko.sortBy(o,"chapterIndex"):ko.sortBy(o,"chapterIndex").reverse();let i=ko.uniq(o.map((e=>e.chapter))),n={};return i.forEach((e=>{n[e]=[]})),r.forEach((e=>{n[e.chapter].push(e)})),i.map((e=>({group:e,bookmarks:n[e]})))||[]}}}class Eo{static getDefaultCss(e){return`::selection{background:#f3a6a68c}::-moz-selection{background:#f3a6a68c}.kookit-note:hover{cursor:pointer;}img{max-width:100% !important}.kookit-text{${this.getCustomCss(e)}}code,pre{white-space: pre-wrap;}p{margin-block: 0;margin-inline: 0;}`}static getCustomCss(e){return`font-size: ${e.getReaderConfig("fontSize")?e.getReaderConfig("fontSize"):"18"}px !important;line-height: ${e.getReaderConfig("lineHeight")||"1.25"} !important;font-family: ${e.getReaderConfig("fontFamily")||""} !important;background-color: transparent;color: ${e.getReaderConfig("textColor")?e.getReaderConfig("textColor"):"rgba(44,47,49,1)"===e.getReaderConfig("backgroundColor")||"night"===e.getReaderConfig("appSkin")||"system"===e.getReaderConfig("appSkin")&&"yes"===e.getReaderConfig("isOSNight")?"white":""} !important;letter-spacing: ${e.getReaderConfig("letterSpacing")}px !important;text-align: ${e.getReaderConfig("textAlign")?e.getReaderConfig("textAlign"):""} !important;font-weight: ${"yes"===e.getReaderConfig("isBold")?"bold !important":""};font-style: ${"yes"===e.getReaderConfig("isItalic")?"italic !important":""};text-shadow: ${"yes"===e.getReaderConfig("isShadow")?"2px 2px 2px #cccccc !important":""};text-indent: ${"yes"===e.getReaderConfig("isIndent")?"2rem":""};text-decoration: ${"yes"===e.getReaderConfig("isUnderline")?"underline !important":""};margin-bottom: ${e.getReaderConfig("paraSpacing")||0}px !important;padding:0px !important;word-wrap: break-word !important; writing-mode: horizontal-tb !important; `}}class xo{static mergeArray(e,t){var r=[];for(let t of e)r.push(t);for(let i of t){var o=!0;for(let t of e)if(i===t){o=!1;break}o&&r.push(i)}return r}static fuzzyQuery(e,t){for(var r=[],o=0;o<e.length;o++)e[o].indexOf(t.trim())>-1&&r.push(o);return r}static mouseSearch(e){let t=document.querySelector(".header-search-box").value.toLowerCase(),r=[],o=[];if(!e)return[];e.forEach((e=>{r.push(e.name.toLowerCase()),o.push(e.author.toLowerCase())}));let i=this.fuzzyQuery(r,t),n=this.fuzzyQuery(o,t);return this.mergeArray(i,n)}static keywordSearch(e,t){let r=[],o=[];if(!t)return[];t.forEach((e=>{r.push(e.name.toLowerCase()),o.push(e.author.toLowerCase())}));let i=this.fuzzyQuery(r,e),n=this.fuzzyQuery(o,e);return this.mergeArray(i,n)}static keySearch(e,t){if(e&&13===e.keyCode){let r=[],o=[];if(!t)return[];t.forEach((e=>{r.push(e.name.toLowerCase()),o.push(e.author.toLowerCase())}));let i=this.fuzzyQuery(r,e.target.value.toLowerCase()),n=this.fuzzyQuery(o,e.target.value.toLowerCase());return this.mergeArray(i,n)}}static mouseNoteSearch(e){let t=document.querySelector(".header-search-box").value.toLowerCase(),r=[],o=[];e.forEach((e=>{r.push(e.notes.toLowerCase()),o.push(e.text.toLowerCase())}));let i=this.fuzzyQuery(r,t),n=this.fuzzyQuery(o,t);return this.mergeArray(i,n)}static keyNoteSearch(e,t){if(e&&13===e.keyCode){let r=[],o=[];t.forEach((e=>{r.push(e.notes.toLowerCase()),o.push(e.text.toLowerCase())}));let i=this.fuzzyQuery(r,e.target.value.toLowerCase()),n=this.fuzzyQuery(o,e.target.value.toLowerCase());return this.mergeArray(i,n)}}}export{Y as BookHelper,_ as CommonTool,se as ConfigService,l as KookitConfig,oe as LoginHelper,ee as ReaderRequest,xo as SearchUtil,Co as SortUtil,V as SqlStatement,Eo as StyleHelper,ne as SyncHelper,$ as SyncUtil,te as ThirdpartyRequest,ye as TokenService,re as UserRequest};
